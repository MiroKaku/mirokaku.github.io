<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>喵石榴</title>
  
  
  <link href="https://mirokaku.github.io/atom.xml" rel="self"/>
  
  <link href="https://mirokaku.github.io/"/>
  <updated>2022-07-11T02:33:42.000Z</updated>
  <id>https://mirokaku.github.io/</id>
  
  <author>
    <name>MiroKaku</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="https://mirokaku.github.io/hello-world/"/>
    <id>https://mirokaku.github.io/hello-world/</id>
    <published>2022-07-11T02:33:59.422Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener external nofollow noreferrer">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener external nofollow noreferrer">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener external nofollow noreferrer">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener external nofollow noreferrer">GitHub</a>.</p><div class="story post-story"><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener external nofollow noreferrer">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener external nofollow noreferrer">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener external nofollow noreferrer">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener external nofollow noreferrer">Deployment</a></p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;Hexo&lt;/a&gt;! This is your very first post.</summary>
      
    
    
    
    <category term="Hello" scheme="https://mirokaku.github.io/categories/hello/"/>
    
    
    <category term="Hello" scheme="https://mirokaku.github.io/tags/hello/"/>
    
  </entry>
  
  <entry>
    <title>让你的驱动启动顺序快人一步!</title>
    <link href="https://mirokaku.github.io/driver-load-order/"/>
    <id>https://mirokaku.github.io/driver-load-order/</id>
    <published>2019-06-27T17:50:05.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="aefb8376354f3422d5c059175c3f778fbafe974e9e0e7497f42f47b575f351ac">6769e003d7583a946c714f8eddbdac6957d1c22f56c8f1199712c125100e39bf3ae208319bf7867075b35babe8713e07bb0a67c412dc8ea355365327552a071a0b9f32c383c80dffeee52b105ee65854ceb70090a94fbdf67ca914ecb504865f3e9bba99286dd9ed5ab9adb92f4d47b27935c18d8c625fd493b081071a00134160f507cb8558b355ea8dc9419ce46091e1be83d8a230497c41ccb80a4ee062ad335e370ef6ae5f18222643eaa9126d94c77282440ae3d3d407ed24c82b54c2225715f38c731272893bf6566664101cecc1eff1270016250857afa6549e0ca735ad27efa856b11aa693c3356597dbfe46f9420fc55a222ebe74537ecaed7b4c2607c7b1dcd1cb5797a7338a29ee84f4687d751280b08c58c92e10b756203e71a25a584b2cdf22c6615fbb41f3efc8a39e111ea2a3f9c0808c4d2b0c79452c7b9b4dd4a39c6e6d11067bd92dcb8621277f68e7753f1c76234c4165e7d62b6680eca1b69d6076cfc0ee37d2a79d15f6c36f7801c53e2deab88067d8803b419fdd5004a827602d2f246e4e73b638991ea6425c3bf3934d2baee838147d998fa6dc607b9e2bd6633544b8f7c03976e616b1cbe396ca97df6d5781240c88ec5c5571f5c3d686f5083d0b78b9604002085edfdc37f199a3cc80c2c421bcf90b98904aa69d7b902c24fbda3db184a3d0107cebdabd699d97c2f3046d2bcb0af331b983d7b70a4e0131f5b79c7d988c83b3ac610e0ee7672aaf43a33632b04ee6222d20c5d10078f767d421800d00ce549d1185c2d25f5c7563f4de4914202072cb0df25bf0d74b10f5e8ab02e4a4f88697b035fcfc80fdc82ff93853b40dd709bf221530dfc9d6d1329a1562f3b92d9b2148d5e12a591a040bfaf954ca80ce05e6cd988824e02c8c59f23064597ebd0712f5465345bd3c27007799f668071385c0173d2f13c889ea6f1a0f4bfda483172c919196dd74dc88e93d8ae27334be20a5da3cf895b5923345bc74ca1232fd7553bc0243e6098a4015402e28783102a5a5c8b8188f098bf7f04d63dfa8611bc551366149554ae2dd1dc85127f956471c8505b2c217917633929935cbe8f3380fb600e77f76129670380522c22eb10924de82b6dd2f400c4ff923ae1ef38378bb324dfd60b4b2b6c60f291353d91a8d8751d6dc557efc79f09d872e6d9ec44d073ae0c569f74f01a6397df20a7015d5b9a4a8f5ba7c5dbbcad3500b11348b8769a76bb133495a5dec5bddfbdac4c9561afad0693afdd114c2b5cf1048214b60eaa01d4b2203338433c40ca87703cfb5d6b13c8260b9506d008027137a3e601f543cd16dd6e06add8a12539a18f75366127ece792e1ab9f8662bfc08337fa2bc4921cd19bc3312fde25f51f07439ff12e2c7e0abb49dd4bf7dc3ac176408b71dc07d1885ecf036e1b9f6fdbad20aba90199d10bf230e4caf3746082165f6a3d053beff613bf074a227be83c8e56f7a55ac1304df56c7aaea30a84ecfb206571ff79fd4b9c14bbc6f6a2a6df06af8895e01bdd3c495e015cb68d690fe99ba77e529226efd19145ef2b3e64c31eae47c144f9d2ce6166651c16dff580ccd7d34c30753f6090570ef2bcd17aba0ec80bac1ed51858b4eee4bf8f02e19bb515d5e0e180a8fc94e2019cf3d1aaf257a0a5aa7027de3d797d6f6a4e1a1b761a96770f3b58ba0c5d0b104ff50390fbf172215a311e5cd29541b5ff691315c791294bba0e210830f9890e5452e301f06fc8e07c8b17a623eee5a3cb052bfa7b3355a21bba53b02dbb25e8a7a4b89a38704944857b327860094e4e87c43c4a4e047e13fd90bc866cf91ea60185cf36c61b1a9ebeef3af6aa8334092f8cc47cc83563efd9074e71db5ce94e3a352e75de6f5dd14d4c377147cc57fa58158cf5ffc8e01186e0c4d0823e1f464cee84b0e8a175e65aedbba4a2dbf65bbe8d18343b29fb19b00a6be6d4bd9c89243d83356f6ec371d1417fa9760cbe616d7f55ef9937580c0fe9671a34c971ae86ffbc5bb773a329a12f5dcd77deb8d330aeefb2cf751fdfba8570fc9bc064c4cc57c8032918d7703ecb78768111a79ca7409220587e240f87d9838f7c63f58c3a06b0fe4564c173775104648f7232530ba40535a10a38177378ca7cc3a02735fa9fe02b38828ddb726cd038565eaaa4d88151dc6a4b884217705ad49c65ceac0d81cd307cf4016752ae0d15e35133f94c4fbebbf9534df00580cfbcbadce9ddd67f51f5f39628cefe470d33dccc0dc16d8ade3d0101500d7d2076917ef54d11d0b663a2ecb7798d2ba3cb9bffc868045fcc8d7cf1eb8509847a3dc001037dc7eda2580b5215d146ed19c6bf247938896c0653e088799c07af17ee6a21babe408deb011a34516630cb912d61fc8f6a6af54ca15025dbd9e7d5d279c5b25e6c4ce69996400e4a077486be0b8e31b568258d48e5a72f4481cf0de48191122b90cd37ba32d9dda30041eb3cf020ebefed9d2e9e0e3736aef1e7e748ec44db16121270279e31dd077ca665ba9d6518d7d5e4a7061a2e21fe65d6ed54e5afa3d556e41360bca4ba6d56ca415e98985753209e33609534923b9a103d4d82addc6b3ff4a19005ff632f7a753108d12e35ba73b953f6695857e4f559c57d5acf44af09644b5efec3324a088ed616a51987740ab8e2101ea267b91844c728368b8500bdd81fb1c52a8c55e1c30d74e904cd1d4200d8c7b9423fe582aa130097bca083f5450863e7f3e104b295f1de5d57169d7765b3a577eca687d267c6652ce19086d89cc20d469861b0ffa7633d3e7622c4dde6fec41968e2fbee13211d6874d3a67f5a4e3f808d4b330510bd71d3731f083b30ec0bb64c37990363a1d5aee7ba04374bd99a6625f09620b26a4a1910dee49e85de27da472d580b3a3ead565739d5b3cbfc3ab93df61c25e0dd78fa34213d1f5bea5fbba918ecae2ace6228c04f04c44cb073e918e61fcfb1280599b342cb0f82142822ed01b4c97e9d1aca36b718d3898bf8de5149f4de55dfd8bd84b6095f99af98f284daafc2dd7d6342b2363711e15aedfae2c22e0e9c887f0b556ed2ce2dbb6e7473b16872bf084fd10701d9be846bb777a1ccaf5b4f2ddbc8293e607faec4f9fe0fcc219ec1c5b96722b049b3ff72b0e78cb0554777135dee3d85946e2f49055323d9639e16b4a9e1c4957cdc61b6ab548baf03ddd66b115afff30ecd0e5bd5a130ed485e661712e74cee2d05c0f6d73926d2f18759b3bc8eabf542de1de5d5061b5eac78ce343803c48ef38b9645036faad16e71c15966f400d2cd63d38a02e248ba294c11b44ba91d23965f37613d22944b73d83bc8cdd6e97e0ebdb9a93ef8e60fad4c2e0d5550206e6ae0aab1161190c16138c52ccfb9cf340b7e0aee30c441e1fb0c70e2d895eca67b68c9d486223f5f65d9fe9c59d30f0d2d0142e7e41c3516b58e8b2dd3113044bd1a1e2f88f4319e1c9e5f18ab1e9d970b1c2574867043b6896c36496c17a622c3c5f70dc3885929f66a6be775847f64ef28934c815cbb4e1cd51cd6c4b037e552471ea26b30fac1d18ca426e1e5b8b4118f9d72345784873a85164d37b4bb6aa7568ada9ab6e6fceb462deb8a1361084fabab7ad6af62fc066b02382db6984fdddab7866f8d88580def8c5f7c3742bf694e10da5c736e7bf6c64c1300b6ccc95d7a6745263c071f91f374c3f0c3d0ddc6fe14c8e4b3af9d1293a0c3f7f6230c79e787e5cfb75d885ccbe1a5ba3b571509425745e64cf3bfd15d4e2674908b59e76e1722b67f5d80ba361db53d5b975e880b78f9b24311e0d78e8dab2f6e7a37cf417a5d40e4d9d4fb1652623b632f48a94dd2eab048e4a4b13b9e79cf5fc711eaefe62881945ab495bf9b0312c5b55b068d1f1b0db0e96e04495f802c84c266ccb0dca8bc51d0b749c694643e1c1fc4dd0951334f17453fabe5a1410d09af79e1f46a431c7edccbf4c1e369d3da015936392efae5f95b1a391fe3933efd7814ebc27606c56b048fac8272eb44ad3295ac87e90e11c1287f35e60e0749ce3e068d02c231d37b5e60c237a7eb1687c40a1f3dcc145c0e078234df63b87a6a925f7ebbb3d5c3dc873a4b942129bdf9b340c4eaa56f0af5da90ab0b95af3c0f6c1efe3dd5777d2b9f8333f9f6b25e050fdde642941bc70690a60510dbb7adcfde12b114510b921707d64acde18089d60fa0aa6b0f04b7230fe0701de11fb8bbdfe9eb484b4f42bad4fcfe9b18778a7f04738c7afc70c600c4f7cbf7a6bd4372b53db6408259d8c7e95ff61728b075f681b2640c7cf1a219d7083b85845a9203c9124d8f977344e1d34137110eb1098859a5d719ee0ac68a828421dc6dec0f0e3c036c79657d4b7909109db0b28db5f2041ecafb77d05bc0316c242d279e4706c41f64cfb3b79bdce4dc95338a93baba3dc93972ce96143dde528744879c5e94e986a1f12258ec14b8db1bc64a4f6dcc2394615621553445e42ee94a06b8cbeb8989442e0eb351b041a44d7df9fa441d9680d79fb833ed77b24153239e28d6290fb21c731a287f4d6322edf60854d238e84ea881cb3b15667655d077c47cf98a20062aa70815e5b92573a13de8975d459082b126ca23797aa7bbf97741ef2e75ad538eaf628d232b26a502a172339cfb48db6cdf1510f511d658ef2cec2c2d16db8ad4c066aab9aa952b8694c45ff53042965e19e63ce59277d3d92e2c3cb7f877957a341c12c7374540d93a5e32319ca26934e5509a5613a94ad1b3c2a4ac2d141515996d354e4e3b269c7d42e33fb877c02370171f8b5ecf7cfee7b1c444a55af6d8519c2ea21887c75b884c517c0cf246710c1075b2c8b507c2df2246f4743352de305698a2582ad8333ce8c103381730284e6396a84917e32bdb19511c1b632df78a3113cf01b26e29caf573d7e6ac54b87017d92cd889ad84f01256f252c9ac8fa0a31d40b4b3018e2cd3e2bc5fcd6287141d6b2a0383cf8264c406a54274bf84e707e98525c233c1a9c090529593cfb879245e51e8cbe5afa420a9e6738ff680c94d689adb33433bee3c8c64391e1ca88b5c582615cc50d5976aecefce8997db928d21fc0aa5a1758ee34cd051dc8158fe4f2436108418f0891281d82a8d3159787fed59a58ac8a886caca9b0110900907f97a5b5ee43a769987a7adf1209c3868aa29d10c5c3ec454adbde940c4586dbe5f32706647ab2349c6ed241c69a6d318b60c2782d2602353050c7d4f0389aeadfdb72aaa7764256d505f8783d160e51b8d690a33acc1d5f4b57df0697be984a5fce74968d1512c70015509fcfd5c7e64e2d75c459aeed2e0610232b6503aa64e50e2b8e2e323a8fa8af3a80f49f8a3268dcad4bf37c95bb27ef59f95c36ad82575e90875986cf01c868841ef6856632c14b3fca07feff8412c4c834f35c1cdf71a810010692fff092ca655f57dadc1dd8089646d4d43868980b0417d87bcaf504ae6a71a4fc0d20d77b86611d22d47c2bda52d31df7f53fd724d1c9ff1ad396bc0a938f6760fd1ac385113ef5aa9919b99f6ca39c65e982b37f611e7ceeb8e0130288deb855a9b0af506b619678ca74be7e28f2eb46183b06a166bb04ae8d3d635554fd9b22bdbe34a3658c2d26af34f8a7ec13e756e75d5b003605b6452ffbffcfc3b3e592d8fef67a3792b9669222ca922c656ec2a4ce7c3e080c985afbff79ed07e7dd892c107d53e9cbded7e64f923cbcfa09859bb9d0a8048406eec056047149bffedcdbd90796f85981b1ded2d770567eb37bfe02348bb39fe32ae31fa237a4eb11941a426907120981a5ff1a4d8e2015a2dd8ef73d1a8df49b1b82de151ae86526f6ba3d4fd292f3dcf17beefcdeb8b8d5e192938173ee969c9d3c656d4db1a0669c8aa9c4a2dd3a3a219e8fec8983b3d6804e112854a8ca5a7d9b80b599270d98148dbc8aaa44c39abde4af5239c53d12e3142d8d7f3188a2f5cc2bbb5c16845bd5c555422cb2f9a0d4847b85ce738a4bc76895f702d231c843c500766dcce2008b7ca4a9a8ae876793681d7b264537b60bfcc50cc94d7187339ec2695cbd06938ccf55e1fe7ebb1389d449f3c0e8d459c34843b9c5b8599af1a29c4d952c97dd3a90e768ca99413d22c1909cc6d245fa919ab73e3083c4b5c55c0ae538b04053166ad43adad1b5dff1c8e2835702570bc404032837821a227a3bd786288eb6f3dea0e4870714d3ff4789a1a01353923a4470abff62804144abc0201e436f3ecd93211094f15bfaf9bfc12a29186b6702ddd657577f12e41b7a866c3cf46fc658766a22097f7d0098caccf2f86fdbff852a442e0f27f444e41f53578ff197ad8c30bc71a314f5fc9f97059d6cd70912c9ae0f69f8754e44f5a561da9f1bf15da037af0a01c68afdf4ed779509e006134247812bc45ea38ec781f9ea0278517acedd21b7d9b3f0c36ad88ac46445d25d0f47b630904a2acc5fa0aed69ba11a0497e47e7d7143e5913cb1fdb88e8de6d56f052ddbe81e1bf73384756f96d0aa6272d051061322a31bd3c808cf06397a759ee3e1d2c033cb350fd9aad69350a72e0331fc94e8cd8cbe57eeeeb4618dffb9abdfe3054044bad71e73dbf3a3c88690a0b9f45df114d4a05cc7a1bb3fcff569852f601134c047f94de91a7acb417f7e567fcf3629e345d3d329592138bc3680cdcc4ac6ee0086cea64dd51ce18f8e7df7fb6e61364d62415dc5902929723ea3c303ed3f7af67f91865d02f1df3dced0173a25c9b466573ec963c1c417fdac310be1ccfcc8bf567664c6715b3bb283e4ab7fbf01cece7a102b4b973e3935dc2d05fd2df72ff591ec509d611172de68f6521376bc866afc6cd5483dfe4d1bd299c2f2842a00455348c2511845e07cab3c76f4cab9bb5eb292cc92c4923d027925e61613c86548f9e9afe81992131c06553ab3003b6087238accea6698626dde14f387d6eb0379bb8d7da1c925aa949c9d9555bff821d9deb2034db5e113e1c3b18618db5b4b505d2fe4cae9a52057ae33f2c475bdb445983e69fc42dcc807777cf1ac774caecd28404e1b8c80561da7cb94d607f2e7e91afc01774dba9bc96ff1308f6721f340dd3452209a3bd90ccf394ed5c6170733d7963d12786345ff38c71b22163e2e3d79f0ca2c947079be8531283aadfbddd06af4e3d8ed646acfc8b61e6d4bba489a16235558e809b6eb834b8cd0e47c224a3d91f9e7d1f677c312854fe4c75d283c4e6fe22c5c07993bdbf17ceb04d4d5d2db9d7e118ab00076fca34fbe2d1f8c1e2373d03a67cd35362d0ada4b9ac9469098e2ad44526e0bc1cab45dd71245c75efcc4dd3e006991c11b5ec6161045a7bad4e804db57e883c29122c2fe2611ba3332684f0274e78b082c499f43efcec996031a5b70670ca7eb331361b5c6a0e9b655913b10bf94f7e86d8512aa62775ea48a230fb91e802335d7463bdbc995199a0c6fb8d34b5258c089542f7b2b372a7372f4965b389118469aeaae934208d5df339172639c5bcda932f71dae25788e98b83505d1774ee8b4a051d7aaff1b95ea78d4524d3ba6e9238be3f4904ed0e7f9aeccc336ca48f983af8aa39ed9995a2d274dbfbc21cb63de76354c976fa0e6990687c81e957b31c61152a949b628978db31ee7a6a608dd970ac0d25d7c0627216a8c4296751b9b621b231405b40d785dbd6343659663358c4ed4bda74cb06cf110f3b3383f656f722634b74fb2befe401b54c6b4cfd66c456a845b1e9d3f1797df73725aa520d41596fc1b99ea24cb19922d7f6bb56d0e0769b33914aa411be3b2d13ae1de831fbb3a4568c54ce31506de0942c01359cbc5df177f282206c7eb600ea27daba2f5545ef8b42e9b007dca40888f465779bae95af471203e928a8c9568a98910e9daf5dda14bb529927d5f277cc9da5c3fcc8831532a7b84927936336107c9cf2195b736e08e17726e063efd97a5a0a20cbfdadd5c72100336fd7585c1886309d39dcad45efa50164caa193c7941d7c013f44b9b17a423a4bb10e5de6dafd1c8d55db3a9f527408045299e9c959a9c3a6cda0c7b3a81b4a67717cbd3e0e01abd5bcbbaacdb2851f12246867d4d94936381e86fd629bb9973b2f9718a1f0bd97cf1bed7e2d7c779e52be65687689e7a55584ac4ab8b2d20bbe78438c822c8336d23cb7051248e3e0174427d4c7da665674d15d6ace1555a375c3f3837f539f990aca61966d7bf6289c0dab1b3b9456e310487ce5f38505a6c3a4c53ba123e9ce801405f077f3631b820b621f243a6551a1a6a1869fdadacfd87b35b1db2c12382f493465b12cd72fa84bc90deb791df888cde9e83ad7234a09dbfeee2aeccc9544ab671e65f95d5d0efa868dd241262077972e7c55f943d94aff721a30feda81db5686870080b5965df6cc3dec02518d0fc6a39cbf1bfdda8cd16dbc7ac763b9218aaeff46d212f395f6f2b4c26f5e9cc894464b534e7e4123dd174e45b067a70a2e17ecdd97436ebdd33763c9da09e5e47eda39499a138318aee00ab6742295ec8c00ce5280f0ff6fc45c28d642cdd7ecab38956ddd4f096059c94398143b424a006b0bf1039c3744ee7d4d0c074d117c5</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-blink">      <input class="hbe hbe-input-field hbe-input-field-blink" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-blink" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-blink" data-content="喵喵喵？">喵喵喵？</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">呀，锁上了！</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel" scheme="https://mirokaku.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>现代 INF 模板</title>
    <link href="https://mirokaku.github.io/Modern-INF-Template/"/>
    <id>https://mirokaku.github.io/Modern-INF-Template/</id>
    <published>2019-05-28T19:34:46.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>前几天写了篇《传统 INF 模板》，今天来补充一下 KMDF 和 NDIS6 的 INF 模板. 这两个模板的编写方式和之前 Legacy 的模板不一样，是微软当前推荐使用的编写方法。</p><div class="story post-story"><h2 id="安装和卸载驱动"><a href="#安装和卸载驱动" class="headerlink" title="安装和卸载驱动"></a>安装和卸载驱动</h2><p>现代的 INF 不能直接再使用 <code>InstallHinfSection</code> 来安装和卸载. 我给 devcon 添加了一些代码, 来支持 Legacy 和 NDIS6 的安装.</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; KMDF（devcon 原版）</span><br><span class="line">devcon.exe install   KMDF.inf       Root\KMDF</span><br><span class="line">     |        |        |                |</span><br><span class="line">安装工具   安装命令  驱动 inf 路径  驱动硬件id(inf有写)</span><br><span class="line"></span><br><span class="line">; KMDF（devcon 修改版 https://github.com/MiroKaku/devcon）</span><br><span class="line">devcon.exe install    KMDF    KMDF.inf       Root\KMDF</span><br><span class="line">     |        |        |         |               |</span><br><span class="line">安装工具    安装命令 安装模式  驱动 inf 路径  驱动硬件id(inf有写)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; NDIS6.x（原版）</span><br><span class="line">netcfg /l NDIS6.inf /c s /i Root\NDIS6</span><br><span class="line"></span><br><span class="line">; NDIS6.x（devcon 修改版）</span><br><span class="line">devcon.exe install NDIS6 NDIS6.inf Root\NDIS6</span><br></pre></td></tr></table></figure><span id="more"></span></div><div class="story post-story"><h2 id="KMDF-驱动-INF-模板"><a href="#KMDF-驱动-INF-模板" class="headerlink" title="KMDF 驱动 INF 模板"></a>KMDF 驱动 INF 模板</h2><figure class="highlight ini"><figcaption><span>NT</span><a href="/downloads/code/KMDF.inf">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Template.INF -- KMDF Driver</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Copyright (c) 2019, Microsoft.Com LLC.  All rights reserved.</span></span><br><span class="line"><span class="comment">;------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; KMDF INF MSDN: https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/using-inx-files-to-create-inf-files</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Class And ClassGuid MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/file-system-filter-driver-classes-and-class-guids</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</span></span><br><span class="line"><span class="section">[version]</span></span><br><span class="line"><span class="attr">Signature</span>   = <span class="string">&quot;$Windows NT$&quot;</span></span><br><span class="line"><span class="attr">Class</span>       = Samples</span><br><span class="line"><span class="attr">ClassGUID</span>   = {<span class="number">78</span>A1C341-<span class="number">4539</span>-<span class="number">11</span>d3-B88D-<span class="number">00</span>C04FAD5171}</span><br><span class="line"><span class="attr">Provider</span>    = %ManufacturerName%</span><br><span class="line"><span class="attr">CatalogFile</span> = %DriverName%.cat</span><br><span class="line"><span class="attr">DriverVer</span>   = </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Manufacturer MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-manufacturer-section</span></span><br><span class="line"><span class="section">[Manufacturer]</span></span><br><span class="line">%ManufacturerName%=Standard,,NT$ARCH$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Models MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-models-section</span></span><br><span class="line"><span class="comment">; hw_id(Hardware ID) MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/hardware-ids</span></span><br><span class="line"><span class="section">[Standard.NT$ARCH$]</span></span><br><span class="line">%ServiceDesc%=Install, Root\Template <span class="comment">; hw_id</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Class section </span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[ClassInstall32]</span></span><br><span class="line"><span class="attr">Addreg</span> = ClassInstall.Registry</span><br><span class="line"></span><br><span class="line"><span class="section">[ClassInstall.Registry]</span></span><br><span class="line">HKR,,,0,Samples <span class="comment">; class name</span></span><br><span class="line">HKR,,Icon,,-5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Installation Section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT$ARCH$]</span></span><br><span class="line"><span class="attr">CopyFiles</span>   = Install.Drivers</span><br><span class="line"></span><br><span class="line"><span class="section">[Install.Remove]</span></span><br><span class="line"><span class="attr">DelFiles</span>    = Uninstall.Drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DestinationDirs MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-destinationdirs-section</span></span><br><span class="line"><span class="section">[DestinationDirs]</span></span><br><span class="line"><span class="attr">DefaultDestDir</span>          = <span class="number">12</span></span><br><span class="line"><span class="attr">CoInstaller.Copyfiles</span>   = <span class="number">11</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksNames MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksnames-section</span></span><br><span class="line"><span class="section">[SourceDisksNames]</span></span><br><span class="line"><span class="attr">1</span>=%DiskId%,<span class="string">&quot;&quot;</span>,,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksFiles MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksfiles-section</span></span><br><span class="line"><span class="comment">; Each filename entry must specify the exact name of a file on the source disk. </span></span><br><span class="line"><span class="comment">;     You cannot use a %strkey% token to specify the file name.</span></span><br><span class="line"><span class="section">[SourceDisksFiles]</span></span><br><span class="line"><span class="attr">Template.sys</span> = <span class="number">1</span>,,</span><br><span class="line">WdfCoInstaller$KMDFCOINSTALLERVERSION$.<span class="attr">dll</span>=<span class="number">1</span> <span class="comment">; make sure the number matches with SourceDisksNames</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Copyfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-copyfiles-directive</span></span><br><span class="line"><span class="section">[Install.Drivers]</span></span><br><span class="line">%DriverName%.sys,Template.sys,,0x00004022 <span class="comment">; COPYFLG_NOSKIP | COPYFLG_NO_VERSION_DIALOG | COPYFLG_IN_USE_RENAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Delfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delfiles-directive</span></span><br><span class="line"><span class="section">[Uninstall.Drivers]</span></span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Service installation support</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; You may want to add the SPSVCINST_STARTSERVICE flag, like this:</span></span><br><span class="line"><span class="comment">;     AddService=%ServiceName%,0x800,InstallService.Arch ; SPSVCINST_STARTSERVICE</span></span><br><span class="line"><span class="comment">; AddService MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-addservice-directive</span></span><br><span class="line"><span class="section">[Install.NT$ARCH$.Services]</span></span><br><span class="line"><span class="attr">AddService</span> = %ServiceName%,%ServicInstFlags%,InstallService</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[InstallService]</span></span><br><span class="line"><span class="attr">DisplayName</span>     = %ServiceName%</span><br><span class="line"><span class="attr">Description</span>     = %ServiceDesc%</span><br><span class="line"><span class="attr">ServiceBinary</span>   = %<span class="number">12</span>%\%DriverName%.sys</span><br><span class="line"><span class="attr">ServiceType</span>     = <span class="number">1</span>                 <span class="comment">;SERVICE_KERNEL_DRIVER</span></span><br><span class="line"><span class="attr">StartType</span>       = <span class="number">3</span>                 <span class="comment">; 0 = SERVICE_BOOT_START</span></span><br><span class="line">                                    <span class="comment">; 1 = SERVICE_SYSTEM_START</span></span><br><span class="line">                                    <span class="comment">; 2 = SERVICE_AUTO_START</span></span><br><span class="line">                                    <span class="comment">; 3 = SERVICE_DEMAND_START</span></span><br><span class="line">                                    <span class="comment">; 4 = SERVICE_DISABLED</span></span><br><span class="line"><span class="attr">ErrorControl</span>    = <span class="number">1</span>                 <span class="comment">;SERVICE_ERROR_NORMAL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.Remove.Services]</span></span><br><span class="line"><span class="attr">DelService</span> = %ServiceName%,<span class="number">0</span>x200    <span class="comment">; SPSVCINST_STOPSERVICE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Install Coinstaller installation</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT.CoInstallers]</span></span><br><span class="line"><span class="attr">AddReg</span>      = CoInstaller.Registry</span><br><span class="line"><span class="attr">CopyFiles</span>   = CoInstaller.Copyfiles</span><br><span class="line"></span><br><span class="line"><span class="section">[CoInstaller.Registry]</span></span><br><span class="line">HKR,,CoInstallers32,0x00010000, &quot;WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll,WdfCoInstaller&quot;</span><br><span class="line"></span><br><span class="line"><span class="section">[CoInstaller.Copyfiles]</span></span><br><span class="line">WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll</span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT.Wdf]</span></span><br><span class="line"><span class="attr">KmdfService</span>         = %ServiceName%, WDFSection</span><br><span class="line"><span class="section">[WDFSection]</span></span><br><span class="line"><span class="attr">KmdfLibraryVersion</span>  = <span class="variable">$KMDFVERSION</span>$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Strings section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Strings]</span></span><br><span class="line"><span class="attr">ManufacturerName</span>    = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">DriverName</span>          = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceName</span>         = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceDesc</span>         = <span class="string">&quot;Template KMDF Driver&quot;</span></span><br><span class="line"><span class="attr">DiskId</span>              = <span class="string">&quot;Template Installation Disk&quot;</span></span><br><span class="line"><span class="attr">ServicInstFlags</span>     = <span class="number">0</span>x00000002</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="NDIS6-X-驱动-INF-模板"><a href="#NDIS6-X-驱动-INF-模板" class="headerlink" title="NDIS6.X 驱动 INF 模板"></a>NDIS6.X 驱动 INF 模板</h2><figure class="highlight ini"><figcaption><span>NT</span><a href="/downloads/code/NDIS6.inf">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Template.INF -- NDIS 6.x LightWeight Filter Driver</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Copyright (c) 2019, Microsoft.Com LLC.  All rights reserved.</span></span><br><span class="line"><span class="comment">;------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Class And ClassGuid MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/file-system-filter-driver-classes-and-class-guids</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</span></span><br><span class="line"><span class="section">[version]</span></span><br><span class="line"><span class="attr">Signature</span>       = <span class="string">&quot;$Windows NT$&quot;</span></span><br><span class="line"><span class="attr">Class</span>           = NetService</span><br><span class="line"><span class="attr">ClassGUID</span>       = {<span class="number">4</span>D36E974-E325-<span class="number">11</span>CE-BFC1-<span class="number">08002</span>BE10318}</span><br><span class="line"><span class="attr">Provider</span>        = %ManufacturerName%</span><br><span class="line"><span class="attr">CatalogFile</span>     = %DriverName%.cat</span><br><span class="line"><span class="attr">DriverVer</span>       = </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Manufacturer MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-manufacturer-section</span></span><br><span class="line"><span class="section">[Manufacturer]</span></span><br><span class="line">%ManufacturerName%=Standard,NT$ARCH$</span><br><span class="line"></span><br><span class="line"><span class="comment">; Models MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-models-section</span></span><br><span class="line"><span class="comment">; hw_id(Hardware ID) MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/hardware-ids</span></span><br><span class="line"><span class="section">[Standard.NT$ARCH$]</span></span><br><span class="line">%ServiceDesc%=Install, Root\Template <span class="comment">; hw_id</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Installation Section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT$ARCH$]</span></span><br><span class="line"><span class="attr">AddReg</span>              = InstallNdi</span><br><span class="line"></span><br><span class="line"><span class="comment">; All LWFs must include the 0x40000 bit (NCF_LW_FILTER). Unlike miniports, you</span></span><br><span class="line"><span class="comment">; don&#x27;t usually need to customize this value.</span></span><br><span class="line"><span class="attr">Characteristics</span>     = <span class="number">0</span>x40000</span><br><span class="line"></span><br><span class="line"><span class="comment">; This must be a random, unique value.</span></span><br><span class="line"><span class="comment">; FILTER_UNIQUE_NAME in filter.h must match this GUID identically.</span></span><br><span class="line"><span class="comment">; Both should have {curly braces}.</span></span><br><span class="line"><span class="attr">NetCfgInstanceId</span>    = <span class="string">&quot;{00000000-0000-0000-0000-000000000000}&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Copyfiles</span>           = Install.Drivers</span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT$ARCH$.Remove]</span></span><br><span class="line"><span class="attr">DelFiles</span>            = Uninstall.Drivers</span><br><span class="line"><span class="attr">DelReg</span>              = UninstallNdi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DestinationDirs MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-destinationdirs-section</span></span><br><span class="line"><span class="section">[DestinationDirs]</span></span><br><span class="line"><span class="attr">DefaultDestDir</span> = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksNames MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksnames-section</span></span><br><span class="line"><span class="section">[SourceDisksNames]</span></span><br><span class="line"><span class="attr">1</span>=%DiskId%,<span class="string">&quot;&quot;</span>,,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksFiles MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksfiles-section</span></span><br><span class="line"><span class="comment">; Each filename entry must specify the exact name of a file on the source disk. </span></span><br><span class="line"><span class="comment">;     You cannot use a %strkey% token to specify the file name.</span></span><br><span class="line"><span class="section">[SourceDisksFiles]</span></span><br><span class="line"><span class="attr">Template.sys</span>        =<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Copyfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-copyfiles-directive</span></span><br><span class="line"><span class="section">[Install.Drivers]</span></span><br><span class="line">%DriverName%.sys,Template.sys,,0x00004022 <span class="comment">; COPYFLG_NOSKIP | COPYFLG_NO_VERSION_DIALOG | COPYFLG_IN_USE_RENAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Delfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delfiles-directive</span></span><br><span class="line"><span class="section">[Uninstall.Drivers]</span></span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Ndi installation support</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[InstallNdi]</span></span><br><span class="line">HKR, Ndi,Service,,%ServiceName%</span><br><span class="line">HKR, Ndi,CoServices,0x00010000,%ServiceName%</span><br><span class="line">HKR, Ndi,HelpText,,%NdiHelpText%</span><br><span class="line"></span><br><span class="line"><span class="comment">; Set the FilterClass here.  The FilterClass controls the order in which</span></span><br><span class="line"><span class="comment">; filters are bound to the underlying miniport.  Possible options include:</span></span><br><span class="line"><span class="comment">;     Custom, Diagnostic, Failover, Loadbalance, Vpn, Compression, Encryption, Scheduler</span></span><br><span class="line"><span class="comment">; See MSDN for a description of each. https://docs.microsoft.com/en-us/windows-hardware/drivers/network/configuring-an-inf-file-for-a-modifying-filter-driver</span></span><br><span class="line">HKR, Ndi,FilterClass,, compression</span><br><span class="line"></span><br><span class="line"><span class="comment">; For a Monitoring filter, use this:</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,FilterType,0x00010001, 1 ; Monitoring filter</span></span><br><span class="line"><span class="comment">; For a Modifying filter, use this:</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,FilterType,0x00010001, 2 ; Modifying filter</span></span><br><span class="line">HKR, Ndi,FilterType,0x00010001,2</span><br><span class="line"></span><br><span class="line"><span class="comment">; Specifying Binding Interfaces MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/network/specifying-binding-interfaces</span></span><br><span class="line">HKR, Ndi\Interfaces,UpperRange,,&quot;noupper&quot;</span><br><span class="line">HKR, Ndi\Interfaces,LowerRange,,&quot;nolower&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Ensure that the list of media types below is correct.  Typically,</span></span><br><span class="line"><span class="comment">; filters include &quot;ethernet&quot;.  Filters may also include &quot;ppip&quot; to include</span></span><br><span class="line"><span class="comment">; native WWAN stacks, but you must be prepared to handle the packet framing.</span></span><br><span class="line"><span class="comment">; Possible values are listed on MSDN, but common values include:</span></span><br><span class="line"><span class="comment">;     ethernet, wan, ppip, wlan</span></span><br><span class="line">HKR, Ndi\Interfaces, FilterMediaTypes,,&quot;ethernet, wan&quot;</span><br><span class="line">HKR, Ndi\Interfaces, LowerExclude,, &quot;ndisatm, ndiscowan, ndiswan, ndiswanasync, ndiswanipx, ndiswannbf&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">; For a Mandatory filter, use this:</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,FilterRunType,0x00010001, 1 ; Mandatory filter</span></span><br><span class="line"><span class="comment">; For an Optional filter, use this:</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,FilterRunType,0x00010001, 2 ; Optional filter</span></span><br><span class="line"><span class="comment">; Mandatory Filter Drivers MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/network/mandatory-filter-drivers</span></span><br><span class="line">HKR, Ndi,FilterRunType,0x00010001, 1 <span class="comment">; Mandatory filter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; By default, Mandatory filters unbind all protocols when they are</span></span><br><span class="line"><span class="comment">; installed/uninstalled, while Optional filters merely pause the stack.  If you</span></span><br><span class="line"><span class="comment">; would like to override this behavior, you can include these options.  These</span></span><br><span class="line"><span class="comment">; options only take effect with 6.30 filters on Windows &quot;8&quot; or later.</span></span><br><span class="line"><span class="comment">; To prevent a full unbind, and merely pause/restart protocols:</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,UnbindOnAttach,0x00010001, 0 ; Do not unbind during FilterAttach</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,UnbindOnDetach,0x00010001, 0 ; Do not unbind during FilterDetach</span></span><br><span class="line"><span class="comment">; To force a full unbind/bind (which includes pause/restart, of course):</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,UnbindOnAttach,0x00010001, 1 ; Unbind during FilterAttach</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,UnbindOnDetach,0x00010001, 1 ; Unbind during FilterDetach</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; NDIS can start a miniport stack even if some Optional filters are</span></span><br><span class="line"><span class="comment">; missing.  However, NDIS reserves the right to wait for the Optional</span></span><br><span class="line"><span class="comment">; filters to be registered, since it&#x27;s faster to attach a filter if</span></span><br><span class="line"><span class="comment">; the protocols haven&#x27;t been bound yet.</span></span><br><span class="line"><span class="comment">; If your Optional filter is unlikely to be started at boot, you can</span></span><br><span class="line"><span class="comment">; use this hint to inform NDIS to spend less time waiting for your</span></span><br><span class="line"><span class="comment">; filter.  Note this setting is ignored for Mandatory filters; NDIS</span></span><br><span class="line"><span class="comment">; always waits forever for all Mandatory filters.</span></span><br><span class="line"><span class="comment">;     HKR, Ndi,NdisBootStart,0x00010001, 0 ; Don&#x27;t wait for this driver to start at boot</span></span><br><span class="line"><span class="comment">; Enable this setting only if your filter will be bound, but the driver</span></span><br><span class="line"><span class="comment">; is not usually started at boot.  If your driver will typically start</span></span><br><span class="line"><span class="comment">; at boot, then enabling this setting would defeat the NDIS heuristic</span></span><br><span class="line"><span class="comment">; and slightly slow down boot.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[UninstallNdi]</span></span><br><span class="line">HKR,,,0x00002000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Service installation support</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.NT$ARCH$.Services]</span></span><br><span class="line"><span class="comment">; You may want to add the SPSVCINST_STARTSERVICE flag, like this:</span></span><br><span class="line"><span class="comment">;     AddService=%ServiceName%,0x800,InstallService.Arch ; SPSVCINST_STARTSERVICE</span></span><br><span class="line"><span class="comment">; AddService MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-addservice-directive</span></span><br><span class="line"><span class="attr">AddService</span>=%ServiceName%,%ServicInstFlags%,InstallService</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[InstallService]</span></span><br><span class="line"><span class="attr">DisplayName</span>     = %ServiceName%</span><br><span class="line"><span class="attr">Description</span>     = %ServiceDesc%</span><br><span class="line"><span class="attr">ServiceBinary</span>   = %<span class="number">12</span>%\%DriverName%.sys</span><br><span class="line"><span class="attr">ServiceType</span>     = <span class="number">1</span>                 <span class="comment">;SERVICE_KERNEL_DRIVER</span></span><br><span class="line"><span class="attr">StartType</span>       = <span class="number">3</span>                 <span class="comment">; 0 = SERVICE_BOOT_START</span></span><br><span class="line">                                    <span class="comment">; 1 = SERVICE_SYSTEM_START</span></span><br><span class="line">                                    <span class="comment">; 2 = SERVICE_AUTO_START</span></span><br><span class="line">                                    <span class="comment">; 3 = SERVICE_DEMAND_START</span></span><br><span class="line">                                    <span class="comment">; 4 = SERVICE_DISABLED</span></span><br><span class="line"><span class="attr">ErrorControl</span>    = <span class="number">1</span>                 <span class="comment">;SERVICE_ERROR_NORMAL</span></span><br><span class="line"><span class="attr">LoadOrderGroup</span>  = NDIS</span><br><span class="line"><span class="attr">AddReg</span>          = Common.Params.Registry, NdisImPlatformBindingOptions.Registry</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Install.Remove.Services]</span></span><br><span class="line"><span class="attr">DelService</span>      = %ServiceName%,<span class="number">0</span>x200    <span class="comment">; SPSVCINST_STOPSERVICE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Common.Params.Registry]</span></span><br><span class="line"><span class="comment">; You can add any sort of NDIS parameters here.  Filter drivers</span></span><br><span class="line"><span class="comment">; don&#x27;t always need NDIS parameters, so it&#x27;s okay to have nothing here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Remove the sample parameters below.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Sample 1: &quot;DriverParam&quot; is a per-driver parameter.</span></span><br><span class="line"><span class="comment">;   HKR, FilterDriverParams\DriverParam,     ParamDesc,   , &quot;Driverparam for lwf&quot;</span></span><br><span class="line"><span class="comment">;   HKR, FilterDriverParams\DriverParam,     default,     , &quot;5&quot;</span></span><br><span class="line"><span class="comment">;   HKR, FilterDriverParams\DriverParam,     type,        , &quot;int&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Sample 2: &quot;AdapterParam&quot; is a per-module parameter.</span></span><br><span class="line"><span class="comment">;   HKR, FilterAdapterParams\AdapterParam,   ParamDesc,   , &quot;Adapterparam for lwf&quot;</span></span><br><span class="line"><span class="comment">;   HKR, FilterAdapterParams\AdapterParam,   default,     , &quot;10&quot;</span></span><br><span class="line"><span class="comment">;   HKR, FilterAdapterParams\AdapterParam,   type,        , &quot;int&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[NdisImPlatformBindingOptions.Registry]</span></span><br><span class="line"><span class="comment">; By default, when an LBFO team or Bridge is created, all filters will be</span></span><br><span class="line"><span class="comment">; unbound from the underlying members and bound to the TNic(s). This keyword</span></span><br><span class="line"><span class="comment">; allows a component to opt out of the default behavior</span></span><br><span class="line"><span class="comment">; To prevent binding this filter to the TNic(s):</span></span><br><span class="line"><span class="comment">;   HKR, Parameters, NdisImPlatformBindingOptions,0x00010001,1 ; Do not bind to TNic</span></span><br><span class="line"><span class="comment">; To prevent unbinding this filter from underlying members:</span></span><br><span class="line"><span class="comment">;   HKR, Parameters, NdisImPlatformBindingOptions,0x00010001,2 ; Do not unbind from Members</span></span><br><span class="line"><span class="comment">; To prevent both binding to TNic and unbinding from members:</span></span><br><span class="line"><span class="comment">;   HKR, Parameters, NdisImPlatformBindingOptions,0x00010001,3 ; Do not bind to TNic or unbind from Members</span></span><br><span class="line">HKR, Parameters, NdisImPlatformBindingOptions,0x00010001,0 <span class="comment">; Subscribe to default behavior</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Strings section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Strings]</span></span><br><span class="line"><span class="attr">ManufacturerName</span>    = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">DriverName</span>          = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceName</span>         = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceDesc</span>         = <span class="string">&quot;Template NDIS6 Packet Driver&quot;</span></span><br><span class="line"><span class="attr">DiskId</span>              = <span class="string">&quot;Template Device Installation Disk&quot;</span></span><br><span class="line"><span class="attr">NdiHelpText</span>         = <span class="string">&quot;A NDIS 6 filter driver to support packet capturing and sending under Windows 7, 8 &amp; 10&quot;</span></span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前几天写了篇《传统 INF 模板》，今天来补充一下 KMDF 和 NDIS6 的 INF 模板. 这两个模板的编写方式和之前 Legacy 的模板不一样，是微软当前推荐使用的编写方法。&lt;/p&gt;
&lt;h2 id=&quot;安装和卸载驱动&quot;&gt;&lt;a href=&quot;#安装和卸载驱动&quot; class=&quot;headerlink&quot; title=&quot;安装和卸载驱动&quot;&gt;&lt;/a&gt;安装和卸载驱动&lt;/h2&gt;&lt;p&gt;现代的 INF 不能直接再使用 &lt;code&gt;InstallHinfSection&lt;/code&gt; 来安装和卸载. 我给 devcon 添加了一些代码, 来支持 Legacy 和 NDIS6 的安装.&lt;/p&gt;
&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;; KMDF（devcon 原版）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;devcon.exe install   KMDF.inf       Root\KMDF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     |        |        |                |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;安装工具   安装命令  驱动 inf 路径  驱动硬件id(inf有写)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;; KMDF（devcon 修改版 https://github.com/MiroKaku/devcon）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;devcon.exe install    KMDF    KMDF.inf       Root\KMDF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     |        |        |         |               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;安装工具    安装命令 安装模式  驱动 inf 路径  驱动硬件id(inf有写)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;; NDIS6.x（原版）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;netcfg /l NDIS6.inf /c s /i Root\NDIS6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;; NDIS6.x（devcon 修改版）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;devcon.exe install NDIS6 NDIS6.inf Root\NDIS6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel" scheme="https://mirokaku.github.io/tags/kernel/"/>
    
    <category term="INF" scheme="https://mirokaku.github.io/tags/inf/"/>
    
  </entry>
  
  <entry>
    <title>传统 INF 模板</title>
    <link href="https://mirokaku.github.io/INF-Template/"/>
    <id>https://mirokaku.github.io/INF-Template/</id>
    <published>2019-05-25T16:53:18.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>基本上，大家写完驱动都是通过一个加载器来加载驱动，我自己觉得太麻烦了...不如直接右键安装更方便.</p><p>下面是我自己使用的驱动 INF 文件模板，直接替换里面部分文件信息就可以直接使用。</p><div class="story post-story"><h2 id="INF-安装和卸载驱动"><a href="#INF-安装和卸载驱动" class="headerlink" title="INF 安装和卸载驱动"></a>INF 安装和卸载驱动</h2><h3 id="安装驱动"><a href="#安装驱动" class="headerlink" title="安装驱动"></a>安装驱动</h3><ol><li><p>可以直接右键 INF 文件，选择 &quot;安装&quot;</p></li><li><p>通过命令安装</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUNDLL32.EXE SETUPAPI.DLL,InstallHinfSection DefaultInstall 128 C:\WINDOWS\INF\SHELL.INF</span><br></pre></td></tr></table></figure><h3 id="卸载驱动"><a href="#卸载驱动" class="headerlink" title="卸载驱动"></a>卸载驱动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUNDLL32.EXE SETUPAPI.DLL,InstallHinfSection DefaultUninstall 128 C:\WINDOWS\INF\SHELL.INF</span><br></pre></td></tr></table></figure><span id="more"></span></div><div class="story post-story"><h2 id="NT-驱动-INF-模板"><a href="#NT-驱动-INF-模板" class="headerlink" title="NT 驱动 INF 模板"></a>NT 驱动 INF 模板</h2><p>有几个地方需要自行替换内容</p><pre><code>1. `Version` 里面的 `Class`，`ClassGuid`，`DriverVer`2. `SourceDisksFiles` 里面的文件名3. `Strings` 里面的所有信息，根据自己的需求来填写</code></pre><figure class="highlight ini"><figcaption><span>NT</span><a href="/downloads/code/NT.inf">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Template.INF -- NT Legacy Driver</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Copyright (c) 2019, Microsoft.Com LLC.  All rights reserved.</span></span><br><span class="line"><span class="comment">;------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; INF MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/roadmap-for-device-and-driver-installation--windows-vista-and-later-</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Class And ClassGuid MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/file-system-filter-driver-classes-and-class-guids</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</span></span><br><span class="line"><span class="section">[Version]</span></span><br><span class="line"><span class="attr">Signature</span>   = <span class="string">&quot;$WINDOWS NT$&quot;</span></span><br><span class="line"><span class="attr">Class</span>       = AntiVirus</span><br><span class="line"><span class="attr">ClassGuid</span>   = {b1d1a169-c54f-<span class="number">4379</span>-<span class="number">81</span>db-bee7d88d7454}</span><br><span class="line"><span class="attr">Provider</span>    = %ManufacturerName%</span><br><span class="line"><span class="attr">CatalogFile</span> = %DriverName%.cat</span><br><span class="line"><span class="attr">DriverVer</span>   = </span><br><span class="line"><span class="attr">PnpLockdown</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Installation Section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DestinationDirs MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-destinationdirs-section</span></span><br><span class="line"><span class="section">[DestinationDirs]</span></span><br><span class="line"><span class="attr">DefaultDestDir</span> = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksNames MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksnames-section</span></span><br><span class="line"><span class="section">[SourceDisksNames]</span></span><br><span class="line"><span class="attr">1</span> = %DiskId%,,,<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksFiles MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksfiles-section</span></span><br><span class="line"><span class="comment">; Each filename entry must specify the exact name of a file on the source disk. </span></span><br><span class="line"><span class="comment">;     You cannot use a %strkey% token to specify the file name.</span></span><br><span class="line"><span class="section">[SourceDisksFiles]</span></span><br><span class="line"><span class="attr">Template.sys</span> = <span class="number">1</span>,,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Copyfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-copyfiles-directive</span></span><br><span class="line"><span class="section">[Install.Drivers]</span></span><br><span class="line">%DriverName%.sys,Template.sys,,0x00004022 <span class="comment">; COPYFLG_NOSKIP | COPYFLG_NO_VERSION_DIALOG | COPYFLG_IN_USE_RENAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Delfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delfiles-directive</span></span><br><span class="line"><span class="section">[Uninstall.Drivers]</span></span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Service installation support</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[DefaultInstall.NT$ARCH$]</span></span><br><span class="line"><span class="attr">CopyFiles</span>       = Install.Drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; LegacyUninstall MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/develop/creating-a-primitive-driver</span></span><br><span class="line"><span class="section">[DefaultUninstall.NT$ARCH$]</span></span><br><span class="line"><span class="attr">LegacyUninstall</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">DelFiles</span>        = Uninstall.Drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[DefaultInstall.NT$ARCH$.Services]</span></span><br><span class="line"><span class="comment">; You may want to add the SPSVCINST_STARTSERVICE flag, like this:</span></span><br><span class="line"><span class="comment">;     AddService=%ServiceName%,0x800,InstallService.Arch ; SPSVCINST_STARTSERVICE</span></span><br><span class="line"><span class="comment">; AddService MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-addservice-directive</span></span><br><span class="line"><span class="attr">AddService</span>      = %ServiceName%,%ServicInstFlags%,InstallService</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DelService MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delservice-directive</span></span><br><span class="line"><span class="section">[DefaultUninstall.NT$ARCH$.Services]</span></span><br><span class="line"><span class="attr">DelService</span>      = %ServiceName%,<span class="number">0</span>x200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[InstallService]</span></span><br><span class="line"><span class="attr">DisplayName</span>    = %ServiceName%</span><br><span class="line"><span class="attr">Description</span>    = %ServiceDesc%</span><br><span class="line"><span class="attr">ServiceBinary</span>  = %<span class="number">12</span>%\%DriverName%.sys</span><br><span class="line"><span class="attr">ServiceType</span>    = <span class="number">1</span>                  <span class="comment">; SERVICE_KERNEL_DRIVER</span></span><br><span class="line"><span class="attr">StartType</span>      = <span class="number">3</span>                  <span class="comment">; 0 = SERVICE_BOOT_START</span></span><br><span class="line">                                    <span class="comment">; 1 = SERVICE_SYSTEM_START</span></span><br><span class="line">                                    <span class="comment">; 2 = SERVICE_AUTO_START</span></span><br><span class="line">                                    <span class="comment">; 3 = SERVICE_DEMAND_START</span></span><br><span class="line">                                    <span class="comment">; 4 = SERVICE_DISABLED</span></span><br><span class="line"><span class="attr">ErrorControl</span>   = <span class="number">1</span>                  <span class="comment">; SERVICE_ERROR_NORMAL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Strings section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Strings]</span></span><br><span class="line"><span class="attr">ManufacturerName</span>        = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">DriverName</span>              = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceName</span>             = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceDesc</span>             = <span class="string">&quot;Template Legacy Driver&quot;</span></span><br><span class="line"><span class="attr">DiskId</span>                  = <span class="string">&quot;Template Device Installation Disk&quot;</span></span><br><span class="line"><span class="attr">ServicInstFlags</span>         = <span class="number">0</span>x00000000</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="MiniFilter-驱动-INF-模板"><a href="#MiniFilter-驱动-INF-模板" class="headerlink" title="MiniFilter 驱动 INF 模板"></a>MiniFilter 驱动 INF 模板</h2><p>MiniFilter 的 INF 和 NT 基本差不多，只是多了个 MiniFilter 的 Instance 注册表的补充.</p><figure class="highlight ini"><figcaption><span>MiniFilter</span><a href="/downloads/code/MiniFilter.inf">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Template.INF -- MiniFilter Driver</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Copyright (c) 2019, Microsoft.Com LLC.  All rights reserved.</span></span><br><span class="line"><span class="comment">;------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; INF MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/roadmap-for-device-and-driver-installation--windows-vista-and-later-</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Class And ClassGuid MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/file-system-filter-driver-classes-and-class-guids</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</span></span><br><span class="line"><span class="section">[Version]</span></span><br><span class="line"><span class="attr">Signature</span>   = <span class="string">&quot;$WINDOWS NT$&quot;</span></span><br><span class="line"><span class="attr">Class</span>       = AntiVirus</span><br><span class="line"><span class="attr">ClassGuid</span>   = {b1d1a169-c54f-<span class="number">4379</span>-<span class="number">81</span>db-bee7d88d7454}</span><br><span class="line"><span class="attr">Provider</span>    = %ManufacturerName%</span><br><span class="line"><span class="attr">CatalogFile</span> = %DriverName%.cat</span><br><span class="line"><span class="attr">DriverVer</span>   = </span><br><span class="line"><span class="attr">PnpLockdown</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Installation Section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DestinationDirs MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-destinationdirs-section</span></span><br><span class="line"><span class="section">[DestinationDirs]</span></span><br><span class="line"><span class="attr">DefaultDestDir</span> = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksNames MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksnames-section</span></span><br><span class="line"><span class="section">[SourceDisksNames]</span></span><br><span class="line"><span class="attr">1</span> = %DiskId%,,,<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; SourceDisksFiles MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-sourcedisksfiles-section</span></span><br><span class="line"><span class="comment">; Each filename entry must specify the exact name of a file on the source disk. </span></span><br><span class="line"><span class="comment">;     You cannot use a %strkey% token to specify the file name.</span></span><br><span class="line"><span class="section">[SourceDisksFiles]</span></span><br><span class="line"><span class="attr">Template.sys</span> = <span class="number">1</span>,,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Copyfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-copyfiles-directive</span></span><br><span class="line"><span class="section">[Install.Drivers]</span></span><br><span class="line">%DriverName%.sys,Template.sys,,0x00004022 <span class="comment">; COPYFLG_NOSKIP | COPYFLG_NO_VERSION_DIALOG | COPYFLG_IN_USE_RENAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Delfiles MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delfiles-directive</span></span><br><span class="line"><span class="section">[Uninstall.Drivers]</span></span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Service installation support</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[DefaultInstall.NT$ARCH$]</span></span><br><span class="line"><span class="attr">CopyFiles</span>       = Install.Drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; LegacyUninstall MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/develop/creating-a-primitive-driver</span></span><br><span class="line"><span class="section">[DefaultUninstall.NT$ARCH$]</span></span><br><span class="line"><span class="attr">LegacyUninstall</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">DelFiles</span>        = Uninstall.Drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[DefaultInstall.NT$ARCH$.Services]</span></span><br><span class="line"><span class="comment">; You may want to add the SPSVCINST_STARTSERVICE flag, like this:</span></span><br><span class="line"><span class="comment">;     AddService=%ServiceName%,0x800,InstallService.Arch ; SPSVCINST_STARTSERVICE</span></span><br><span class="line"><span class="comment">; AddService MSDN</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-addservice-directive</span></span><br><span class="line"><span class="attr">AddService</span>      = %ServiceName%,%ServicInstFlags%,InstallService</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; DelService MSDN:</span></span><br><span class="line"><span class="comment">;     https://docs.microsoft.com/en-us/windows-hardware/drivers/install/inf-delservice-directive</span></span><br><span class="line"><span class="section">[DefaultUninstall.NT$ARCH$.Services]</span></span><br><span class="line"><span class="attr">DelService</span>      = %ServiceName%,<span class="number">0</span>x200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[InstallService]</span></span><br><span class="line"><span class="attr">DisplayName</span>    = %ServiceName%</span><br><span class="line"><span class="attr">Description</span>    = %ServiceDesc%</span><br><span class="line"><span class="attr">ServiceBinary</span>  = %<span class="number">12</span>%\%DriverName%.sys</span><br><span class="line"><span class="attr">ServiceType</span>    = <span class="number">1</span>                  <span class="comment">; SERVICE_KERNEL_DRIVER</span></span><br><span class="line"><span class="attr">StartType</span>      = <span class="number">3</span>                  <span class="comment">; 0 = SERVICE_BOOT_START</span></span><br><span class="line">                                    <span class="comment">; 1 = SERVICE_SYSTEM_START</span></span><br><span class="line">                                    <span class="comment">; 2 = SERVICE_AUTO_START</span></span><br><span class="line">                                    <span class="comment">; 3 = SERVICE_DEMAND_START</span></span><br><span class="line">                                    <span class="comment">; 4 = SERVICE_DISABLED</span></span><br><span class="line"><span class="attr">ErrorControl</span>   = <span class="number">1</span>                  <span class="comment">; SERVICE_ERROR_NORMAL</span></span><br><span class="line"><span class="attr">LoadOrderGroup</span> = FSFilter Anti-Virus<span class="comment">; Reference Version.Class</span></span><br><span class="line"><span class="attr">Dependencies</span>   = FltMgr</span><br><span class="line"><span class="attr">AddReg</span>         = MiniFlt.AddInstance</span><br><span class="line"></span><br><span class="line"><span class="comment">; Minifilter drivers use an AddRegistry section to define minifilter instances and to specify a default instance</span></span><br><span class="line"><span class="section">[MiniFlt.AddInstance]</span></span><br><span class="line">HKR,%InstancesName%,%DefaultInstanceName%,0x00000000,%DefaultInstance%</span><br><span class="line">HKR,%InstancesName%&quot;\&quot;%Instance1.Name%,%AltitudeName%,0x00000000,%Instance1.Altitude%</span><br><span class="line">HKR,%InstancesName%&quot;\&quot;%Instance1.Name%,%FlagsName%,0x00010001,%Instance1.Flags%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; Strings section</span></span><br><span class="line"><span class="comment">;-------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Strings]</span></span><br><span class="line"><span class="attr">ManufacturerName</span>        = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">DriverName</span>              = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceName</span>             = <span class="string">&quot;Template&quot;</span></span><br><span class="line"><span class="attr">ServiceDesc</span>             = <span class="string">&quot;Template MiniFilter Driver&quot;</span></span><br><span class="line"><span class="attr">DiskId</span>                  = <span class="string">&quot;Template Device Installation Disk&quot;</span></span><br><span class="line"><span class="attr">ServicInstFlags</span>         = <span class="number">0</span>x00000000</span><br><span class="line"></span><br><span class="line"><span class="attr">InstancesName</span>           = <span class="string">&quot;Instances&quot;</span></span><br><span class="line"><span class="attr">DefaultInstanceName</span>     = <span class="string">&quot;DefaultInstance&quot;</span></span><br><span class="line"><span class="attr">AltitudeName</span>            = <span class="string">&quot;Altitude&quot;</span></span><br><span class="line"><span class="attr">FlagsName</span>               = <span class="string">&quot;Flags&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DefaultInstance</span>         = <span class="string">&quot;Template Instance&quot;</span></span><br><span class="line"><span class="attr">Instance1.Name</span>          = <span class="string">&quot;Template Instance&quot;</span></span><br><span class="line"><span class="attr">Instance1.Altitude</span>      = <span class="string">&quot;400000&quot;</span>      <span class="comment">; https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/minifilter-altitude-request</span></span><br><span class="line"><span class="attr">Instance1.Flags</span>         = <span class="number">0</span>x0           <span class="comment">; 0x0 = Allow all attachments</span></span><br><span class="line">                                        <span class="comment">; 0x1 = Suppress automatic attachments</span></span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;基本上，大家写完驱动都是通过一个加载器来加载驱动，我自己觉得太麻烦了...不如直接右键安装更方便.&lt;/p&gt;
&lt;p&gt;下面是我自己使用的驱动 INF 文件模板，直接替换里面部分文件信息就可以直接使用。&lt;/p&gt;
&lt;h2 id=&quot;INF-安装和卸载驱动&quot;&gt;&lt;a href=&quot;#INF-安装和卸载驱动&quot; class=&quot;headerlink&quot; title=&quot;INF 安装和卸载驱动&quot;&gt;&lt;/a&gt;INF 安装和卸载驱动&lt;/h2&gt;&lt;h3 id=&quot;安装驱动&quot;&gt;&lt;a href=&quot;#安装驱动&quot; class=&quot;headerlink&quot; title=&quot;安装驱动&quot;&gt;&lt;/a&gt;安装驱动&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;可以直接右键 INF 文件，选择 &amp;quot;安装&amp;quot;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;通过命令安装&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;RUNDLL32.EXE SETUPAPI.DLL,InstallHinfSection DefaultInstall 128 C:\WINDOWS\INF\SHELL.INF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;卸载驱动&quot;&gt;&lt;a href=&quot;#卸载驱动&quot; class=&quot;headerlink&quot; title=&quot;卸载驱动&quot;&gt;&lt;/a&gt;卸载驱动&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;RUNDLL32.EXE SETUPAPI.DLL,InstallHinfSection DefaultUninstall 128 C:\WINDOWS\INF\SHELL.INF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel，INF" scheme="https://mirokaku.github.io/tags/kernel%EF%BC%8Cinf/"/>
    
  </entry>
  
  <entry>
    <title>关于 ProcessHollowing</title>
    <link href="https://mirokaku.github.io/About-ProcessHollowing/"/>
    <id>https://mirokaku.github.io/About-ProcessHollowing/</id>
    <published>2019-05-25T16:04:41.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>ProcessHollowing</code> (进程镂空) 也是出来很久了, 网上已经一大堆相关介绍的文章.<br>我就不再详细介绍, 详细介绍请看&quot;<a href="https://3gstudent.github.io/3gstudent.github.io/%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%A3%80%E6%B5%8B/" target="_blank" rel="noopener external nofollow noreferrer">傀儡进程的实现与检测</a>&quot;, 这里就额外补充个小技巧.</p><span id="more"></span><div class="story post-story"><h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h2><p>假设我创建了一个 <code>svchost</code> 进程作为傀儡进程, 有一个问题就是: <code>svchost</code> 父进程不是 <code>services.exe</code>, 那么就能肉眼可见的发现这是个有问题的进程.</p><p>那么, 要怎么做才能做的更像 <code>&quot;svchost&quot;</code> 呢? 给 <code>svchost</code> 指定父进程为 <code>services.exe</code> 就行了.<br>下面是关键代码, 这个技巧还是我之前逆向 <a href="https://github.com/MeeSong/Reverse-Engineering" target="_blank" rel="noopener external nofollow noreferrer">CreateProcessInternalW</a> 的时候发现的.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!InitializeProcThreadAttributeList(</span><br><span class="line">    AttributeList,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    &amp;AttributeListSize))</span><br><span class="line">&#123;</span><br><span class="line">    DosError = GetLastError();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MSDN: https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute</span></span><br><span class="line"><span class="keyword">if</span> (!UpdateProcThreadAttribute(</span><br><span class="line">    AttributeList,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, <span class="comment">// 指定父进程</span></span><br><span class="line">    &amp;ParentHandle,</span><br><span class="line">    <span class="keyword">sizeof</span>(ParentHandle),</span><br><span class="line">    nullptr,</span><br><span class="line">    nullptr))</span><br><span class="line">&#123;</span><br><span class="line">    DosError = GetLastError();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> Startup               = STARTUPINFOEXW();</span><br><span class="line">Startup.StartupInfo.cb     = <span class="keyword">sizeof</span>(Startup);</span><br><span class="line">Startup.lpAttributeList    = AttributeList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">DosError = CreateProcessHollowed(</span><br><span class="line">    NewToken,</span><br><span class="line">    nullptr,</span><br><span class="line">    <span class="string">LR&quot;(C:\Windows\System32\notepad.exe)&quot;</span>,</span><br><span class="line">    RealApp,</span><br><span class="line">    Args,</span><br><span class="line">    nullptr, nullptr, FALSE,</span><br><span class="line">    EXTENDED_STARTUPINFO_PRESENT | CREATE_NEW_CONSOLE, <span class="comment">// 这里有个 EXTENDED_STARTUPINFO_PRESENT</span></span><br><span class="line">    nullptr, Sysdir,</span><br><span class="line">    (LPSTARTUPINFOW)&amp; Startup, &amp;ProcessInfo);</span><br><span class="line"><span class="keyword">if</span> (NOERROR != DosError)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h2><p>怎么用 32 位进程创建 64 位的镂空进程?</p><p>可以借助 <a href="https://github.com/rwfpl/rewolf-wow64ext" target="_blank" rel="noopener external nofollow noreferrer">wow64ext</a> 这个库, 它可以让 <code>Wow64</code> 进程调用 <code>64</code> 位 <code>Ntdll.dll</code> 的系统调用.<br>把 <code>ProcessHollowing</code> 里面对目标进程操作相关的 <code>API</code> 都换成 <code>wow64ext</code> 扩展的 <code>API</code> 就可以了.</p></div><div class="story post-story"><h2 id="例子代码"><a href="#例子代码" class="headerlink" title="例子代码"></a>例子代码</h2><p><a href="https://github.com/MiroKaku/Learning-Example/tree/master/ProcessHollowing" target="_blank" rel="noopener external nofollow noreferrer">MiroKaku&#x2F;ProcessHollowing</a></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;code&gt;ProcessHollowing&lt;/code&gt; (进程镂空) 也是出来很久了, 网上已经一大堆相关介绍的文章.&lt;br&gt;我就不再详细介绍, 详细介绍请看&amp;quot;&lt;a href=&quot;https://3gstudent.github.io/3gstudent.github.io/%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%A3%80%E6%B5%8B/&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;傀儡进程的实现与检测&lt;/a&gt;&amp;quot;, 这里就额外补充个小技巧.&lt;/p&gt;</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Hack" scheme="https://mirokaku.github.io/tags/hack/"/>
    
  </entry>
  
  <entry>
    <title>关于 InstrumentationCallback</title>
    <link href="https://mirokaku.github.io/About-InstrumentationCallback/"/>
    <id>https://mirokaku.github.io/About-InstrumentationCallback/</id>
    <published>2019-05-24T21:22:14.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>分析环境为 x64 版本</p></blockquote><p><code>InstrumentationCallback</code> 回调的技术刚出来的时候就收藏了, 一直没有去研究学习它. 现在有时间来看一下这个东西.</p><p>这个回调存储在 <code>KPROCESS-&gt; InstrumentationCallback</code>.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dtx nt!_KPROCESS</span><br><span class="line">    [+<span class="number">0x100</span>] InstrumentationCallback : <span class="number">0x7FF6FA0E11AE</span></span><br></pre></td></tr></table></figure><p>它很有意思, <em>当从内核返回到用户层的时候, 就会触发这个回调</em>.<br>下面是一些触发点:</p><ul><li>LdrInitializeThunk</li><li>KiUserExceptionDispatcher</li><li>KiRaiseUserExceptionDispatcher</li><li>KiUserCallbackDispatcher</li><li>KiUserApcDispatcher</li><li>sysret (KeSystemServiceExit)</li></ul><span id="more"></span><div class="story post-story"><h2 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用 ?"></a>怎么用 ?</h2><h3 id="安装回调"><a href="#安装回调" class="headerlink" title="安装回调"></a>安装回调</h3><p>既然这个回调存储在 <code>KPROCESS</code>, 那么我们就看一下设置进程相关的 <code>NtSetInformationProcess()</code></p><p>根据资料和分析可以知道传入参数的结构为:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PVOID Callback;</span><br><span class="line">&#125; PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION, * PPROCESS_INSTRUMENTATION_CALLBACK_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Since Windows 10</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION_EX</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Version;</span><br><span class="line">    ULONG Reserved;</span><br><span class="line">    PVOID Callback;</span><br><span class="line">&#125; PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION_EX, * PPROCESS_INSTRUMENTATION_CALLBACK_INFORMATION_EX;    </span><br></pre></td></tr></table></figure><p>下面代码是我对参数处理相关代码的还原:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NtSetInformationProcess()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ((aProcessInformationLength - <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF7</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INFO_LENGTH_MISMATCH;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (aProcessInformationLength == <span class="number">8</span>)</span><br><span class="line">        InstrumentationCallbackInfo.Callback = *(PVOID *)aProcessInformation;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        InstrumentationCallbackInfo.Callback = *(PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION_EX *)aProcessInformation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (InstrumentationCallbackInfo.Reserved)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (InstrumentationCallbackInfo.Version != InstrumentationCallbackInfo.Reserved)</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNKNOWN_REVISION;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (InstrumentationCallbackInfo.Callback != (<span class="type">void</span> *)((_QWORD)InstrumentationCallbackInfo.Callback &lt;&lt; <span class="number">16</span> &gt;&gt; <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从代码中我们看到几个信息:</p><pre><code>1. 函数接受两种长度的参数. 8 和 162. Reserved 必须为 03. Reversed 必须等于 Version4. 回调地址必须是用户层回调地址</code></pre><p>经过调试发现, Windows 10 之前的系统只支持长度为 8 的参数.</p><p>那么 <code>NtSetInformationProcess()</code> 的调用方法就是:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NtSetInformationProcess(</span><br><span class="line">    GetCurrentProcess(),</span><br><span class="line">    PROCESSINFOCLASS::ProcessInstrumentationCallback, <span class="comment">// 40</span></span><br><span class="line">    Information,        <span class="comment">// PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION[EX]</span></span><br><span class="line">    InformationLength); <span class="comment">// 8 or 16</span></span><br></pre></td></tr></table></figure><p>接下来我们就要看下怎么构造这个回调, 也就是要看下这个回调能用的参数是什么?</p><h3 id="构造回调"><a href="#构造回调" class="headerlink" title="构造回调"></a>构造回调</h3><p>要想知道回调的参数是什么, 我们就要去看一下触发点.</p><p>我选了比较简单的 <code>KiDispatchException()</code> 函数来分析.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">KiDispatchException()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    _disable();</span><br><span class="line">    TrapFrame-&gt;SegCs = <span class="number">0x33</span>;</span><br><span class="line">    TrapFrame-&gt;Rip   = KeUserExceptionDispatcher;</span><br><span class="line">    InstrumentationCallback = KeGetCurrentThread()-&gt;ApcState.Process-&gt;InstrumentationCallback;</span><br><span class="line">    <span class="keyword">if</span> (InstrumentationCallback)</span><br><span class="line">    &#123;</span><br><span class="line">        v6-&gt;R10 = (<span class="type">unsigned</span> __int64)TrapFrame-&gt;Rip;  <span class="comment">// return address</span></span><br><span class="line">        v6-&gt;Rip = (<span class="type">unsigned</span> __int64)InstrumentationCallback;</span><br><span class="line">    &#125;</span><br><span class="line">    _enable();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从代码中我们看到, <code>KiDispatchException()</code> 回到应用层是构造了一个 <code>TrapFrame</code>.<br>其中有处关键的地方: <code>R10</code>, 如果存在 <code>InstrumentationCallback</code> 回调, 这个寄存器就用来存储本应该返回的地址. 其它就是正常展开 <code>TrapFrame</code>. 所以我们要自己构造一个垫片函数, 来正确处理参数.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">include ksamd64.inc</span><br><span class="line">EXTERN InstrumentationCallback:NEAR</span><br><span class="line"></span><br><span class="line">.CODE</span><br><span class="line"></span><br><span class="line">InstrumentationCallbackShim PROC</span><br><span class="line"></span><br><span class="line">    ; https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention</span><br><span class="line"></span><br><span class="line">    push rax</span><br><span class="line">    push rcx</span><br><span class="line">    push RBX</span><br><span class="line">    push RBP</span><br><span class="line">    push RDI</span><br><span class="line">    push RSI</span><br><span class="line">    push RSP</span><br><span class="line">    push R12</span><br><span class="line">    push R13</span><br><span class="line">    push R14</span><br><span class="line">    push R15 </span><br><span class="line"></span><br><span class="line">    ; homespace (rcx, rdx, r8, r9)</span><br><span class="line">    sub rsp, 20h</span><br><span class="line">    mov rdx, rax ; return value</span><br><span class="line">    mov rcx, r10 ; return address</span><br><span class="line">    call InstrumentationCallback</span><br><span class="line">    add rsp, 20h</span><br><span class="line"></span><br><span class="line">    pop R15 </span><br><span class="line">    pop R14</span><br><span class="line">    pop R13</span><br><span class="line">    pop R12</span><br><span class="line">    pop RSP</span><br><span class="line">    pop RSI</span><br><span class="line">    pop RDI</span><br><span class="line">    pop RBP</span><br><span class="line">    pop RBX</span><br><span class="line">    pop rcx</span><br><span class="line">    pop rax</span><br><span class="line"></span><br><span class="line">    jmp R10</span><br><span class="line">InstrumentationCallbackShim ENDP</span><br><span class="line"> </span><br><span class="line">END</span><br></pre></td></tr></table></figure><h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>根据资料和调试分析得知几个注意的问题:</p><ol><li>Windows 10 之前的系统必须提升 <code>Debug</code> 特权, 才能正常调用 <code>NtSetInformationProcess()</code></li><li>Windows 10 之前的系统只支持传入 <code>PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</code></li></ol></div><div class="story post-story"><h2 id="例子代码"><a href="#例子代码" class="headerlink" title="例子代码"></a>例子代码</h2><p><a href="https://github.com/MiroKaku/Learning-Example/tree/master/InstrumentationCallback" target="_blank" rel="noopener external nofollow noreferrer">MiroKaku&#x2F;InstrumentationCallback</a></p></div><div class="story post-story"><h2 id="引用参考"><a href="#引用参考" class="headerlink" title="引用参考"></a>引用参考</h2><p><a href="https://secrary.com/Random/InstrumentationCallback/" target="_blank" rel="noopener external nofollow noreferrer">Hooking via InstrumentationCallback</a><br><a href="https://www.codeproject.com/Articles/543542/Windows-x-system-service-hooks-and-advanced-debug" target="_blank" rel="noopener external nofollow noreferrer">Windows x64 system service hooks and advanced debugging</a></p></div>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;分析环境为 x64 版本&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;InstrumentationCallback&lt;/code&gt; 回调的技术刚出来的时候就收藏了, 一直没有去研究学习它. 现在有时间来看一下这个东西.&lt;/p&gt;
&lt;p&gt;这个回调存储在 &lt;code&gt;KPROCESS-&amp;gt; InstrumentationCallback&lt;/code&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;: kd&amp;gt; dtx nt!_KPROCESS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [+&lt;span class=&quot;number&quot;&gt;0x100&lt;/span&gt;] InstrumentationCallback : &lt;span class=&quot;number&quot;&gt;0x7FF6FA0E11AE&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;它很有意思, &lt;em&gt;当从内核返回到用户层的时候, 就会触发这个回调&lt;/em&gt;.&lt;br&gt;下面是一些触发点:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LdrInitializeThunk&lt;/li&gt;
&lt;li&gt;KiUserExceptionDispatcher&lt;/li&gt;
&lt;li&gt;KiRaiseUserExceptionDispatcher&lt;/li&gt;
&lt;li&gt;KiUserCallbackDispatcher&lt;/li&gt;
&lt;li&gt;KiUserApcDispatcher&lt;/li&gt;
&lt;li&gt;sysret (KeSystemServiceExit)&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel" scheme="https://mirokaku.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>配置 Windows 网络模式内核调试</title>
    <link href="https://mirokaku.github.io/Windbg-Network/"/>
    <id>https://mirokaku.github.io/Windbg-Network/</id>
    <published>2018-10-03T19:07:33.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<div class="note warning"><p>Windbg 版本要与被调试的 Windows 版本一致! 否则可能出现网络包不支持。</p></div><div class="story post-story"><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ol><li><p>配置虚拟机</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /copy &#123;current&#125; /d TestMode</span><br><span class="line">bcdedit /set &#123;new&#125; debug on         # 开启调试模式</span><br><span class="line">bcdedit /set &#123;new&#125; testsigning on   # 开启测试签名模式</span><br><span class="line">bcdedit /set nointegritychecks on   # 关闭驱动程序签名强制验证</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hostip, port, key 自行修改</span></span><br><span class="line">bcdedit /dbgsettings net hostip:192.168.0.1 port:54231 key:xxxxx</span><br></pre></td></tr></table></figure></li><li><p>打开 <code>Windbg-&gt;File-&gt;Kernel Debugging</code>，填入上面配置的 port 和 key</p></li></ol></div><div class="story post-story"><h2 id="引用参考"><a href="#引用参考" class="headerlink" title="引用参考"></a>引用参考</h2><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection" target="_blank" rel="noopener external nofollow noreferrer">Setting Up KDNET Network Kernel Debugging Manually</a></p><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--set" target="_blank" rel="noopener external nofollow noreferrer">BCDEdit &#x2F;set</a></p><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--dbgsettings" target="_blank" rel="noopener external nofollow noreferrer">BCDEdit &#x2F;dbgsettings</a></p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note warning&quot;&gt;&lt;p&gt;Windbg 版本要与被调试的 Windows 版本一致! 否则可能出现网络包不支持。&lt;/p&gt;&lt;/div&gt;

&lt;div class=&quot;story post-story&quot;&gt;&lt;h2 id=&quot;配置&quot;&gt;&lt;a href=&quot;#配置&quot; </summary>
      
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel" scheme="https://mirokaku.github.io/tags/kernel/"/>
    
    <category term="Windbg" scheme="https://mirokaku.github.io/tags/windbg/"/>
    
    <category term="Debug" scheme="https://mirokaku.github.io/tags/debug/"/>
    
  </entry>
  
  <entry>
    <title>PDU 编码规则</title>
    <link href="https://mirokaku.github.io/PDU-Encode/"/>
    <id>https://mirokaku.github.io/PDU-Encode/</id>
    <published>2017-05-18T11:36:02.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>PDU模式不仅支持中文短信，也能发送英文短信。PDU模式收发短信可以使用3种编码：7-bit、8-bit和UCS2编码。<br>7-bit编码用于发送普通的ASCII字符，8-bit编码通常用于发送数据消息，UCS2编码用于发送Unicode字符。</p><span id="more"></span><p>PDU 内容总长度 140 个字节 (1120位)，支持采用三种编码方式：7-bit、8-bit 和 UCS2 编码。<br>7-bit 编码——用于发送普通的 ASCII 字符，ASCII码表最大到0x7X，最高位为0，总 7-bit，实际编码时则可把8-bit的最高位比特使用起来，所以可支持1120&#x2F;7&#x3D;160个字符；<br>8-bit 编码——用于发送数据消息，比如图片和铃声、二进制数据等，此类数据无法使用 7-bit 编码，因为那样会丢掉一位，也不能用下面UCS2编码，因为不符合 UNICODE 编码检查（范围）。8-bit 编码最多支持 140 个字节数据。<br>UCS2 编码——用于发送 Unicode 字符，每个中文（韩文、日文），占用 2 字节，只要短信里包含这些多字节编码文字，那么即使还有英文，英文也需要安装 UCS2 编码，也占用 2 字节，所以，最多支持 70 个中文字（或中英混合短信）</p><h1 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h1><p>一般的PDU编码由A B C D E F G H I J K L M十三项组成:</p><p>SCA (短信中心) 结构部分：<br>AT指令中 AT+CMGS&#x3D;<Len> Len不包含此段位组的长度</p><table><thead><tr><th align="left">Index</th><th align="left">Item</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">A</td><td align="left"><code>&lt;sc_len&gt;</code></td><td align="left">B+C的长度, 1Byte</td></tr><tr><td align="left">B</td><td align="left"><code>&lt;type_addr&gt;</code></td><td align="left">SMSC地址类型, 1Byte</td></tr><tr><td align="left">C</td><td align="left"><code>&lt;number&gt;</code></td><td align="left">SMSC 号码</td></tr></tbody></table><p>TPUD 结构部分：</p><table><thead><tr><th align="left">Index</th><th align="left">Item</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">D</td><td align="left"><code>&lt;option&gt;</code></td><td align="left">基本参数(TP-MTI&#x2F;VFP), 1Byte</td></tr><tr><td align="left">E</td><td align="left"><code>&lt;MR&gt;</code></td><td align="left">短信标识符(TP-MR), 1Byte</td></tr><tr><td align="left">F</td><td align="left"><code>v</code></td><td align="left">目标号码长度, 1Byte</td></tr><tr><td align="left">G</td><td align="left"><code>&lt;DA&gt;</code></td><td align="left">被叫号码类型, 1Byte</td></tr><tr><td align="left">H</td><td align="left"><code>^</code></td><td align="left">被叫号码, 长度由F中的数据决定</td></tr><tr><td align="left">I</td><td align="left"><code>&lt;PID&gt;</code></td><td align="left">协议标识(TP-PID), 1Byte</td></tr><tr><td align="left">J</td><td align="left"><code>&lt;DCS&gt;</code></td><td align="left">数据编码(TP-DCS), 1Byte</td></tr><tr><td align="left">K</td><td align="left"><code>&lt;VP&gt;</code></td><td align="left">有效期(TP-VP), 1Byte</td></tr><tr><td align="left">L</td><td align="left"><code>&lt;UDL&gt;</code></td><td align="left">用户数据长度(TP-UDL), 1Byte</td></tr><tr><td align="left">M</td><td align="left"><code>&lt;UD&gt;</code></td><td align="left">用户数据</td></tr></tbody></table><div class="story post-story"><h2 id="SCA-结构部分详细说明"><a href="#SCA-结构部分详细说明" class="headerlink" title="SCA 结构部分详细说明"></a>SCA 结构部分详细说明</h2><p><code>&lt;sc_len&gt;</code>：表示 <SCA>（短信中心号码）的长度，包含两个字符，指示 <type_addr> 和 <numbers> 所占字符的个数除于 2。</p><p><code>&lt;type_addr&gt;</code>：表示号码地址类型，包含两个字符，其结构如下：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bit7 </span>   <span class="keyword">bit6 </span>   <span class="keyword">bit5 </span>   <span class="keyword">bit4 </span>   <span class="keyword">bit3 </span>   <span class="keyword">bit2 </span>   <span class="keyword">bit1 </span>   <span class="keyword">bit0</span></span><br><span class="line"><span class="keyword"></span><span class="number">1</span>          Type-of-number       Numbering-plan-identification</span><br><span class="line"><span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span></span><br></pre></td></tr></table></figure><p>bit7 固定为 1</p><p>Type-of-number (bit6-bit4) 取值如下：</p><table><thead><tr><th align="left">value</th><th align="left">Descation</th></tr></thead><tbody><tr><td align="left">000</td><td align="left">若用户不能识别目标地址号码时，选用此值。此时地址号码由网络侧决定。</td></tr><tr><td align="left">001</td><td align="left">若用户能识别是国际号码或者或者认为是国内范围时，选用此值。</td></tr><tr><td align="left">010</td><td align="left">国内号码，不允许加前缀或者后缀。在用户发送国内电话时，选用此值。</td></tr><tr><td align="left">011</td><td align="left">本网络内的特定号码，用于管理或者服务，用户不能选用此值。</td></tr><tr><td align="left">101</td><td align="left">号码类型为 GSM 的缺省 7-bit 编码方式。</td></tr><tr><td align="left">110</td><td align="left">短小号码，暂不使用。</td></tr><tr><td align="left">111</td><td align="left">扩展保留，暂不使用。</td></tr></tbody></table><p>Numbering-plan-identification (bit3-bit0) 取值如下：<br>(注：当 bit6-bit4 取值为 000, 001, 010 时才有效，其他情况 bit3-bit0 无效)</p><table><thead><tr><th align="left">value</th><th align="left">Descation</th></tr></thead><tbody><tr><td align="left">0000</td><td align="left">号码由网络侧的号码方案确定</td></tr><tr><td align="left">0001</td><td align="left">ISDN&#x2F;电话号码方案</td></tr><tr><td align="left">0011</td><td align="left">数据号码方案，暂不使用</td></tr><tr><td align="left">0100</td><td align="left">Telex 号码方案，暂不使用</td></tr><tr><td align="left">1000</td><td align="left">国内号码方案，暂不使用</td></tr><tr><td align="left">1001</td><td align="left">私人号码方案，暂不使用</td></tr><tr><td align="left">1010</td><td align="left">ERMES 号码方案，暂不使用</td></tr></tbody></table><p><code>&lt;numbers&gt;</code>：表示地址号码，一个字节储存两个数字，且 bit3 ~ bit0 储存第一个数字，bit7 ~ bit4 储存第二个数字，如果号码为奇数，则最后一位补F后，再进行反转。如果为偶数，则不需要补F。像是反序的 8421 BCD 码，可如下例所示：</p><p>例如有<br>13 81 23 45 67 8<br>存储为<br>21 18 32 54 76 F8</p></div><div class="story post-story"><h2 id="TPDU-结构部分"><a href="#TPDU-结构部分" class="headerlink" title="TPDU 结构部分"></a>TPDU 结构部分</h2><p><code>&lt;option&gt;</code>：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RP    UDHI    SRR    VPF    RD    MTI</span><br><span class="line"><span class="keyword">bit7 </span> <span class="keyword">bit6 </span>   <span class="keyword">bit5 </span>  <span class="keyword">bit4-3 </span><span class="keyword">bit2 </span> <span class="keyword">bit1-0</span></span><br></pre></td></tr></table></figure><ul><li><code>&lt;MTI&gt;</code>：表示短消息类型。</li></ul><table><thead><tr><th align="left">bit1</th><th align="left">bit0</th><th align="left">Descrption</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">0</td><td align="left">SMS-DELIVER (SC 到 MT 方向)</td></tr><tr><td align="left">0</td><td align="left">0</td><td align="left">SMS-DELIVER-REPORT (MT 到 SC 方向)</td></tr><tr><td align="left">1</td><td align="left">0</td><td align="left">SMS-STATUS-REPORT (SC 到 MT 方向)</td></tr><tr><td align="left">1</td><td align="left">0</td><td align="left">SMS-COMMAND (MT 到 SC 方向)</td></tr><tr><td align="left">0</td><td align="left">1</td><td align="left">SMS-SUBMIT (MT 到 SC 方向)</td></tr><tr><td align="left">0</td><td align="left">1</td><td align="left">SMS-SUBMIT-REPROT (SC 到 MT 方向)</td></tr><tr><td align="left">1</td><td align="left">1</td><td align="left">保留</td></tr></tbody></table><ul><li><code>&lt;RD&gt;</code>：指示 SC 是否需要接受一个仍保存在 SC 中，与以前同一 OA 发出具有相同的 MR 和 DA 的短消息。</li></ul><p>0 接受<br>1 不接受</p><ul><li><code>&lt;VPF&gt;</code>：指示 VP 字段格式的有效性，格式指示。</li></ul><table><thead><tr><th align="left">bit1</th><th align="left">bit0</th><th align="left">Descrption</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">0</td><td align="left">VP 字段无效</td></tr><tr><td align="left">1</td><td align="left">0</td><td align="left">VP 字段有效，格式为 &quot;relative&quot;</td></tr><tr><td align="left">0</td><td align="left">1</td><td align="left">VP 字段有效，格式为 &quot;enhanced&quot;</td></tr><tr><td align="left">1</td><td align="left">1</td><td align="left">VP 字段有效，格式为 &quot;absolute&quot;</td></tr></tbody></table><ul><li><code>&lt;RP&gt;</code>：回复短信路径的设置指示，与短信发送时的设置相同。</li></ul><p>0 没有设置<br>1 设置，指示回复短信与发送时具有相同的 SC 号码设置，返回路径相同。</p><ul><li><code>UDHI</code>：用户数据头的指示。</li></ul><p>0 用户数据段只有短消息的内容<br>1 用户数据段除了短消息外，还包含有一个数据头</p><ul><li><code>&lt;SRR&gt;</code>：状态报告请求指示。</li></ul><p>0 不需要一个短信成功发送的状态报告信息<br>1 需要一个短信成功发送的状态报告信息</p><ul><li><code>&lt;MR&gt;</code>：表示短信标识符，取值范围为 0～255。</li></ul><p><code>&lt;DA&gt;</code>：目标地址信息，结构同 SCA，但是有一点不同需要注意！就是 len 字段不再是 type 和 number 的字节长度，而是 number 的字符长度  </p><p><code>&lt;PID&gt;</code>：协议指示。</p><ul><li>Bit7-6 :</li></ul><table><thead><tr><th align="left">Bit7</th><th align="left">Bit6</th><th align="left">(目前， Bit 7&#x3D;0 和 Bit 6&#x3D;0)</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">0</td><td align="left">分配 bits 0-5</td></tr><tr><td align="left">1</td><td align="left">0</td><td align="left">分配 bits 0-5</td></tr><tr><td align="left">0</td><td align="left">1</td><td align="left">保留</td></tr><tr><td align="left">1</td><td align="left">1</td><td align="left">分配 bits 0-5，为 SC 的特殊用途</td></tr></tbody></table><ul><li>Bit5 :</li></ul><p>0 无交互操作，但有 SME-to-CSME 协议<br>1 Telematic 交互操作 （此情况下， bit 4-0 的取值有效）</p><ul><li>Bit4-0 :</li></ul><p>若取值为 10010，则表示 Email ，其它取值暂不支持。</p><p><code>&lt;DSC&gt;</code>：表示用户数据的编码方式。</p><p>00 7-bit 编码 (英文)<br>04 8-bit 编码 (图片和铃声)<br>08 16-bit 编码 (UCS2)</p><p>Bit No.7与Bit No.6：<br>一般设置为00</p><p>Bit No.5：<br>0-文本未压缩<br>1-文本用GSM标准压缩算法压缩</p><p>Bit No.4：<br>0-指示Bit No.1 Bit No.0为保留位，不含信息类型信息<br>1-指示Bit No.1 Bit No.0含信息类型信息</p><p>Bit No.3与Bit No.2：<br>00-默认的字符集，每字符占7bit，此时最大可发送160字符<br>01-8bit，此时最大可发送140字符<br>10-USC2（16bit），发送双字节字符集<br>11-预留</p><p>Bit N0.1与Bit No.0：<br>00-Class 0，短消息直接显示在屏幕上<br>01-Class 1，<br>10-Class 2（SIM卡特定信息），<br>11-Class 3</p><p><code>&lt;VP&gt;</code>：表示有效期，时间从短消息被 SC 接收到开始计算。如果 <VPF>&#x3D;00，则该字段缺失，时间表示如下：</p><table><thead><tr><th align="left">VP 取值</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">0~143</td><td align="left">(VP + 1) x 5 minutes</td></tr><tr><td align="left">144~167</td><td align="left">12 hours + ((VP - 143) x 30 minutes)</td></tr><tr><td align="left">168~196</td><td align="left">(VP - 166) x 1 day</td></tr><tr><td align="left">197~255</td><td align="left">(VP - 192) x 1 week</td></tr></tbody></table><p><code>&lt;UDL&gt;</code>：表示用户数据长度，取值取决于具体的编码方式。</p><ul><li>若是 7-bit 缺省编码， <UDL> 表示共有多少个 septets。</li><li>若是 8-bit 编码， <UDL> 表示共有多少个 Octets。</li><li>若是 UCS2 编码， <UDL> 表示共有多少个 Octets。</li><li>若是有压缩的 7-bit 或 8-bit 或 UCS2 编码， <UDL> 表示压缩后共有多少个 Octets。</li><li>对压缩的短信编码， <UD> 的数据长度不超过 160 septets；对无压缩编码的短信， <UD> 长度不超过 140 Octets。</li></ul><p><code>&lt;UD&gt;</code>：表示用户数据，其有效数据由参数 <UDL> 决定。</p><h1 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h1><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">AT+CMGW=<span class="number">30</span></span><br><span class="line"><span class="number">0891683108705505F011000791680180F60008AA1200480065006C006C006F002055B555B5FF01</span></span><br><span class="line"></span><br><span class="line">AT 指令后面这个长度是 &lt;TPUD 结构的<span class="number">8</span>位字节个数&gt;</span><br><span class="line"></span><br><span class="line">首先看下 SCA 结构 <span class="number">0891683108705505F0</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x08</span></span><br><span class="line">SCA 号码类型和号码的长度</span><br><span class="line"></span><br><span class="line"><span class="number">0x91</span></span><br><span class="line">SCA 号码为国际号码，即 <span class="string">&quot;+&quot;</span></span><br><span class="line"></span><br><span class="line">683108705505F0</span><br><span class="line">可解析短信中心号码为 <span class="number">8613800755500</span></span><br><span class="line"></span><br><span class="line">然后看下 TPUD 结构 11000791680180F60008AA1200480065006C006C006F002055B555B5FF01</span><br><span class="line"></span><br><span class="line"><span class="number">0x11</span> options</span><br><span class="line">Bit No. <span class="number">7</span>       <span class="number">6</span>       <span class="number">5</span>       <span class="number">4</span>       <span class="number">3</span>       <span class="number">2</span>       <span class="number">1</span>       <span class="number">0</span></span><br><span class="line">        RP      UDHI    SRR     VPF     VPF     RD      MTI     MTI</span><br><span class="line">        <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x00</span> MR</span><br><span class="line">置为<span class="number">00</span>即可</span><br><span class="line"></span><br><span class="line"><span class="number">0791680180F6</span> DA</span><br><span class="line">解析为 <span class="number">07</span> <span class="number">91</span> <span class="number">8610086</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x00</span> PID</span><br><span class="line">对于标准情况下的MS-to-SC短消息传送，只需设置PID为<span class="number">00</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x08</span> DCS</span><br><span class="line">USC2（16bit）双字节字符集</span><br><span class="line"></span><br><span class="line"><span class="number">0xAA</span> 有效期</span><br><span class="line"></span><br><span class="line">第一种情况（相对的）：VPF=<span class="number">10</span>  VP=AAH（四天），在这里是第一种</span><br><span class="line">第二种情况（绝对的）：VPF=<span class="number">11</span></span><br><span class="line"></span><br><span class="line">年    月日时分秒时区</span><br><span class="line"><span class="number">30</span>    <span class="number">80</span><span class="number">02</span><span class="number">90</span><span class="number">54</span><span class="number">33</span><span class="number">20</span></span><br><span class="line">           表示：<span class="number">03</span>-<span class="number">08</span>-<span class="number">20</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x12</span> UDL</span><br><span class="line"><span class="number">18</span> 个<span class="number">8</span>位字节</span><br><span class="line"></span><br><span class="line"><span class="number">0048</span> <span class="number">0065</span> <span class="number">006C</span> <span class="number">006C</span> <span class="number">006F</span> <span class="number">0020</span> <span class="number">55B5</span> <span class="number">55B5</span> FF01</span><br><span class="line">H    e    l    l    o    空格  喵   喵   ！</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;PDU模式不仅支持中文短信，也能发送英文短信。PDU模式收发短信可以使用3种编码：7-bit、8-bit和UCS2编码。&lt;br&gt;7-bit编码用于发送普通的ASCII字符，8-bit编码通常用于发送数据消息，UCS2编码用于发送Unicode字符。&lt;/p&gt;</summary>
    
    
    
    <category term="other" scheme="https://mirokaku.github.io/categories/other/"/>
    
    
  </entry>
  
  <entry>
    <title>IDA + VMWare 调试系统</title>
    <link href="https://mirokaku.github.io/IDA-VM-System/"/>
    <id>https://mirokaku.github.io/IDA-VM-System/</id>
    <published>2017-05-12T19:00:18.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<div class="story post-story"><h2 id="配置虚拟机"><a href="#配置虚拟机" class="headerlink" title="配置虚拟机"></a>配置虚拟机</h2><p>打开虚拟机目录下的 <code>vmx</code> 文件, 添加设置项</p><h3 id="32-位客户机系统"><a href="#32-位客户机系统" class="headerlink" title="32 位客户机系统"></a>32 位客户机系统</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">debugStub.port.guest32</span>          = <span class="string">&quot;54232&quot;</span>   <span class="comment">; x86 默认调试端口 8832</span></span><br><span class="line"><span class="attr">debugStub.listen.guest32</span>        = <span class="string">&quot;TRUE&quot;</span></span><br><span class="line"><span class="attr">debugStub.listen.guest32.remote</span> = <span class="string">&quot;TRUE&quot;</span>    </span><br><span class="line"><span class="attr">debugStub.hideBreakpoints</span>       = <span class="string">&quot;TRUE&quot;</span>    <span class="comment">; 启用使用硬件断点而不是软件 (INT3) 断点</span></span><br><span class="line"><span class="attr">monitor.debugOnStartGuest32</span>     = <span class="string">&quot;TRUE&quot;</span>    <span class="comment">; 在第一条指令 (在BIOS! 中警告) 中断进入DebugStub</span></span><br><span class="line">                                            <span class="comment">; 这将在第一条指令在0xFFFF0处停止VM, 您可以设置下一个断点来破坏* 0x7c00引导加载程序由BIOS加载</span></span><br><span class="line"><span class="attr">bios.bootDelay</span>                  = <span class="string">&quot;3000&quot;</span>    <span class="comment">; 延迟启动BIOS代码</span></span><br></pre></td></tr></table></figure><h3 id="64-位客户机系统"><a href="#64-位客户机系统" class="headerlink" title="64 位客户机系统"></a>64 位客户机系统</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">debugStub.port.guest64</span>          = <span class="string">&quot;54264&quot;</span>   <span class="comment">; x64 默认调试端口 8864</span></span><br><span class="line"><span class="attr">debugStub.listen.guest64</span>        = <span class="string">&quot;TRUE&quot;</span></span><br><span class="line"><span class="attr">debugStub.listen.guest64.remote</span> = <span class="string">&quot;TRUE&quot;</span></span><br><span class="line"><span class="attr">debugStub.hideBreakpoints</span>       = <span class="string">&quot;TRUE&quot;</span></span><br><span class="line"><span class="attr">monitor.debugOnStartGuest64</span>     = <span class="string">&quot;TRUE&quot;</span></span><br><span class="line"><span class="attr">bios.bootDelay</span>                  = <span class="string">&quot;3000&quot;</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="配置调试器"><a href="#配置调试器" class="headerlink" title="配置调试器"></a>配置调试器</h2><p><code>IDA</code> -&gt; <code>Debugger</code> -&gt; <code>Attach</code> -&gt; <code>Remote GDB debugger</code></p><p><code>hostname</code> 填写 <code>localhost</code>，<code>port</code> 填上面给出的[默认]端口</p></div><div class="story post-story"><h2 id="设置内存布局"><a href="#设置内存布局" class="headerlink" title="设置内存布局"></a>设置内存布局</h2><p><code>Alt + S</code> 设置内存布局</p><p>32 Bit: <code>0x0 ~ 0xFFFFFFF0</code><br>64 Bit: <code>0x0 ~ 0xFFFFFFFFFFFFFFF0</code></p><blockquote><p>如果是要调试 BIOS 代码, 那么应创建一个从 0xF0000 到 0x10000 的 16 位段</p></blockquote></div>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;story post-story&quot;&gt;&lt;h2 id=&quot;配置虚拟机&quot;&gt;&lt;a href=&quot;#配置虚拟机&quot; class=&quot;headerlink&quot; title=&quot;配置虚拟机&quot;&gt;&lt;/a&gt;配置虚拟机&lt;/h2&gt;&lt;p&gt;打开虚拟机目录下的 &lt;code&gt;vmx&lt;/code&gt; 文</summary>
      
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Kernel" scheme="https://mirokaku.github.io/tags/kernel/"/>
    
    <category term="Windbg" scheme="https://mirokaku.github.io/tags/windbg/"/>
    
    <category term="Debug" scheme="https://mirokaku.github.io/tags/debug/"/>
    
  </entry>
  
  <entry>
    <title>《Writing Solid Python Code》 笔记</title>
    <link href="https://mirokaku.github.io/Writing-Solid-Python-Code-Notes/"/>
    <id>https://mirokaku.github.io/Writing-Solid-Python-Code-Notes/</id>
    <published>2016-08-02T09:44:56.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="《编写高质量代码：改善-Python-程序的-91-个建议》-学习笔记"><a href="#《编写高质量代码：改善-Python-程序的-91-个建议》-学习笔记" class="headerlink" title="《编写高质量代码：改善 Python 程序的 91 个建议》 学习笔记"></a>《编写高质量代码：改善 Python 程序的 91 个建议》 学习笔记</h1><p>之前自己学了很多次 Python，由于用不到，所以总是学完就忘掉了。<br>刚好最近工作需要用到 Python，就借此机会好好学习了一番。<br>Pyhton 的各种特性和风格让我甚是喜欢。不过我总是感觉自己写的代码不是那么漂亮，不够 Pythonic。<br>所以我想通过学习一些经典建议来让我有个思路。</p><span id="more"></span><div class="story post-story"><h2 id="建议-1：理解-Pythonic-概念"><a href="#建议-1：理解-Pythonic-概念" class="headerlink" title="建议 1：理解 Pythonic 概念"></a>建议 1：理解 Pythonic 概念</h2><p>对于 Pythonic 的概念，大家心中的指南就是 Tim Peters 的 《The Zen of Python》（Python 之禅）。<br>下面几点来自其中的内容：</p><ul><li>美胜丑，显胜隐，简胜杂，平胜陡，疏胜密。</li><li>找到简单问题的一个方法，最好是唯一的方法（正确的解决之道）。</li><li>难以解释的实现，源自不好的主意；如有非常棒的主意，它的实现肯定易于解释。</li></ul><p>代码风格建议参考 PEP8 和 <a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/contents/" target="_blank" rel="noopener external nofollow noreferrer">Python 风格指南</a><br>比如：</p><ul><li>包和模块的命名采用小写、单数形式，而且短小。</li><li>包通常仅作为命名空间，如只包含空的 <code>__init__.py</code> 文件</li></ul></div><div class="story post-story"><h2 id="建议-2：编写-Pythonic-代码"><a href="#建议-2：编写-Pythonic-代码" class="headerlink" title="建议 2：编写 Pythonic 代码"></a>建议 2：编写 Pythonic 代码</h2><ol><li>要避免劣化代码</li></ol><ul><li>避免只用大小写来区分不同的对象 </li><li>避免使用容易引起混淆的名称<br>  比如，重复使用已经存在于上下文中的变量名来表示不同的类型；<br>  误用了内建名称来表示其他含义的名称而使之在当前命名空间被屏蔽；<br>  没有构建新的数据类型的情况下使用类似于 element、list、dict等作为变量名；<br>  使用o、l、等作为变量名。</li><li>不要害怕过长的变量名，可读性更重要</li></ul><ol start="2"><li>深入认识 Python 有助于编写 Pythonic 代码</li></ol><ul><li>全面掌握 Python 提供给我们的所有特性，包括语言特性和库特性。</li><li>学习每个 Python 新版本提供的新特性，使用 Python 推荐的惯用法来完成任务</li><li>深入学习业界公认的比较 Pythonic 的代码，比如 Flask、gevent 和 requests 等。</li></ul><ol start="3"><li>使用工具来达到检查和约束，比如我个人使用 Pycharm IDE 来写 Python，对代码风格的要求挺严格的...</li></ol></div><div class="story post-story"><h2 id="建议-3：理解-Python-与-C-语言的不同之处"><a href="#建议-3：理解-Python-与-C-语言的不同之处" class="headerlink" title="建议 3：理解 Python 与 C 语言的不同之处"></a>建议 3：理解 Python 与 C 语言的不同之处</h2><p>我们都知道，Python 底层是用 C 语言实现的，但切忌用 C 语言的思维和风格来编写 Python 代码。尤其重要的是，不要使用之前的编程思想。</p><ol><li>“缩进”与“{}”<br>与 C、C++、Java 等语言使用花括号来分隔代码段不同，Python 中使用严格的代码缩进方式分隔代码块。<br>另外，建议 Tab 替换成 4 个空格，不要混用 Tab 键和空格。</li><li>&#39; 与 &quot;<br>C 语言中单引号 <code>&#39;</code> 与双引号 <code>&quot;</code> 由严格的区别，单引号代表一个字符，它实际对应于编译器所采用的字符集中的一个整数值。而双引号则表示字符串，默认以 <code>\0</code> 结尾。<br>但是在 Python 中，单引号与双引号没有明显区别。</li><li>三元操作符 &quot;?:&quot;<br>三元操作符是 if...else 的简写方法，语法形式为 C ? X: Y，而在 Python 中的等价形式为 X if C else Y</li><li>switch...case<br>Python 中没有像 C 语言那样的 switch...case 分支语句。不过在 Python 中有很多替代的解决方法：</li></ol><p>C:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(n) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You typed zero.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You are in top.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;n is an even number.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Only single-digit numbers are allowed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;You typed zero.&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> n == <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;You are in top.&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> n == <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;n is an even number.&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Only single-digit numbers are allowed.)</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="number">0</span>: <span class="string">&quot;You typed zero.&quot;</span>,</span><br><span class="line">        <span class="number">1</span>: <span class="string">&quot;You are in top.&quot;</span>,</span><br><span class="line">        <span class="number">2</span>: <span class="string">&quot;n is an even number.&quot;</span></span><br><span class="line">    &#125;.get(n, <span class="string">&quot;Only single-digit numbers are allowed.&quot;</span>)</span><br></pre></td></tr></table></figure><p>Python 和其他语言的差异远不止这些。但总归一句话：不要被其他语言的思维和习惯困扰，掌握 Python 的这些和思维方式才是硬道理。</p></div><div class="story post-story"><h2 id="建议-4：在代码中适当添加注释"><a href="#建议-4：在代码中适当添加注释" class="headerlink" title="建议 4：在代码中适当添加注释"></a>建议 4：在代码中适当添加注释</h2><p>Python 中有三种形式的代码注释：块注释、行注释以及文档注释（docstring）。这三种注释的惯用法大概如下几种：</p><ol><li>使用块或行注释的时候仅仅注释那些复杂的操作、算法，还有可能别人难以理解的技巧或者不够一目了然地代码。</li><li>注释和代码隔开一定的距离，同时在块注释之后最好多留几行空白再写代码。</li><li>给外部可访问的函数和方法添加文档注释，无论简单与否。<br>注释要清楚地描述方法的功能，并对参数、返回值以及可能发生的异常进行说明，使得外部调用它的人员仅仅看docstring就能正确使用。<br>较为复杂的内部方法也需要进行注释。</li><li>推荐在文件头中包含 copyright 申明、模块描述等，如有比较可以考虑加入作者信息及变更记录。</li></ol></div><div class="story post-story"><h2 id="建议-5：通过适当添加空行使代码布局更为优雅、合理"><a href="#建议-5：通过适当添加空行使代码布局更为优雅、合理" class="headerlink" title="建议 5：通过适当添加空行使代码布局更为优雅、合理"></a>建议 5：通过适当添加空行使代码布局更为优雅、合理</h2><p>Python 代码布局也有一些基本规则可以遵循（PEP8 中有详细规范..）：</p><ol><li>在一组代码表达完一个完整的思路之后，应该用空白行进行间隔。如每个函数之间，导入声明、变量赋值等。</li><li>尽量保持上下文语义的易理解性</li><li>避免过长的代码行，每行最好不要超过 80 字符。</li><li>不要为了保持水平对其而使用多余的空格 （写C&#x2F;C++就有这习惯...）</li><li>空格的使用要能够在需要强调的时候竟是读者，在疏松关系的实体间起到分隔作用。<ul><li>二元运算符、布尔运算的左右两边应该有空格</li><li>逗号和分号前不要使用空格</li><li>函数名和左括号之间、序列索引操作时序列名和 [] 之间不需要空格，函数的默认参数两侧不需要空格。</li><li>强调前面的操作符的时候使用空格</li></ul></li></ol></div><div class="story post-story"><h2 id="建议-6：编写函数的-4-个原则"><a href="#建议-6：编写函数的-4-个原则" class="headerlink" title="建议 6：编写函数的 4 个原则"></a>建议 6：编写函数的 4 个原则</h2><p>** 原则 1 ** 函数设计要尽量短小，嵌套层次不宜过深。<br>** 原则 2 ** 函数申明应该做到合理、简单、易于使用。<br>** 原则 3 ** 函数参数设计应该考虑向下兼容。<br>** 原则 4 ** 一个函数只做一件事儿，尽量保证函数语句粒度的一致性。</p><p>Python 中函数设计的好习惯还包括：不要再函数中定义可变对象作为默认值，使用异常替换返回错误，保证通过单元测试等。</p></div><div class="story post-story"><h2 id="建议-7：将常量集中到一个文件"><a href="#建议-7：将常量集中到一个文件" class="headerlink" title="建议 7：将常量集中到一个文件"></a>建议 7：将常量集中到一个文件</h2><p>Python 中使用常量一般有以下两种方式：</p><ul><li>通过命名风格来提醒使用者该变量代表的意义为常量，如常量名所有字母大写，用下划线连接各个单词，如 MAX_OVERFLOW，这只是一种约定俗成的风格。</li><li>通过自定义的类实现常量功能。这要求符合“命名全部为大写”和“值一旦绑定便不可再修改”这两个条件。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_const</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ConstError</span>(<span class="title class_ inherited__">TypeError</span>): <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ConstCaseError</span>(<span class="title class_ inherited__">ConstError</span>): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        <span class="keyword">if</span> self.__dict__.has_key(name):</span><br><span class="line">            <span class="keyword">raise</span> self.ConstError, <span class="string">&quot;Can&#x27;t change const.&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name.isupper():</span><br><span class="line">            <span class="keyword">raise</span> self.ConstCaseError, <span class="string">&#x27;const name &quot;&#123;&#125;&quot; is not all uppercase&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">        self.__dict__[name] = value</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[__name__] = _const()</span><br></pre></td></tr></table></figure>如果上面的代码对应的模块名为 const，使用的时候只需要 import const，便可直接定义常量了，如下代码：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> const</span><br><span class="line">const.COMPANY = <span class="string">&quot;IBM&quot;</span></span><br></pre></td></tr></table></figure></li></ul></div><div class="story post-story"><h2 id="建议-8：利用-assert-语句来发现问题"><a href="#建议-8：利用-assert-语句来发现问题" class="headerlink" title="建议 8：利用 assert 语句来发现问题"></a>建议 8：利用 assert 语句来发现问题</h2><p>断言（assert）在很多语言中都存在，它主要为调试程序服务，能够快速方便的检查程序的异常或者发现不恰当的输入等，可防止意想不到的情况出现。</p><p>对 Python 中使用断言需要说明如下：</p><ol><li><strong>debug</strong> 的值默认设置为 True，而且是只读的。</li><li>断言是有性能影响的。Python 可以在运行脚本时通过 <code>-O</code> 标识来禁用断言。比如 <code>Python -O test.py</code></li></ol><p>断言实际是被设计用来捕获用户所定义的约束的，而不是用来捕获程序本身错误的，因此食用断言需要注意以下几点：</p><ol><li>不要滥用，这是使用断言最基本的原则。</li><li>如果 Python 本身的异常能够处理就不要再使用断言。断言没有明确的异常类型。</li><li>不要使用断言来检查用户的输入。</li><li>在函数调用后，当需要确认返回值是否合理时可以使用断言。</li><li>当条件是业务逻辑继续下去的先决条件时可以使用断言。</li></ol></div><div class="story post-story"><h2 id="建议-9：数据交换值得时候不推荐使用中间变量"><a href="#建议-9：数据交换值得时候不推荐使用中间变量" class="headerlink" title="建议 9：数据交换值得时候不推荐使用中间变量"></a>建议 9：数据交换值得时候不推荐使用中间变量</h2><h2 id="建议-10：充分利用-Lazy-evaluation-的特性"><a href="#建议-10：充分利用-Lazy-evaluation-的特性" class="headerlink" title="建议 10：充分利用 Lazy evaluation 的特性"></a>建议 10：充分利用 Lazy evaluation 的特性</h2><p>Lazy evaluation 常被译为“延迟计算”或“惰性计算”，值得是仅仅在真正需要执行的时候才会计算表达式的值。<br>充分利用 Lazy evaluation 的特性带来的好处有两个方面：</p><ol><li>避免不必要的计算，带来性能上的提升。</li><li>节省空间，使得无限循环的数据结构成为可能。</li></ol></div><div class="story post-story"><h2 id="建议-11：理解枚举替代实现的缺陷"><a href="#建议-11：理解枚举替代实现的缺陷" class="headerlink" title="建议 11：理解枚举替代实现的缺陷"></a>建议 11：理解枚举替代实现的缺陷</h2><p>在 Python 3.4 之前，并没有提供枚举类型。所以人们充分利用 Python 的dong&#39;tai动态性这个特征，行除了美剧的各种替代实现：</p><ol><li><p>使用类属性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Seasons</span>:</span><br><span class="line">    Spring, Summer, Autumn, Winter = <span class="built_in">range</span>(<span class="number">4</span>)</span><br></pre></td></tr></table></figure></li><li><p>借助函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">enum</span>(<span class="params">*posarg, **keysarg</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">type</span>(<span class="string">&quot;Enum&quot;</span>, (<span class="built_in">object</span>,), <span class="built_in">dict</span>(<span class="built_in">zip</span>(posarg, xrange(<span class="built_in">len</span>(posarg))), **keysarg))</span><br></pre></td></tr></table></figure></li><li><p>使用 collections.nametuple</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Seasons = namedtuple(&#x27;Seasons&#x27;, &#x27;Spring Summer Autumn Winter&#x27;)._make(range(4))</span><br></pre></td></tr></table></figure></li></ol><p>但是这些替代有其不合理的地方：</p><ul><li>允许枚举值重复</li><li>支持无意义的操作，比如相加</li></ul><p>在3.4之后，加入了枚举 Enum，其实现主要参考 flufl.enum，但两者之间存在一些差别。</p></div><div class="story post-story"><h2 id="建议-12：不推荐使用-type-来进行类型检查"><a href="#建议-12：不推荐使用-type-来进行类型检查" class="headerlink" title="建议 12：不推荐使用 type 来进行类型检查"></a>建议 12：不推荐使用 type 来进行类型检查</h2><p>基于内建类型扩展的用户自定义类型，type函数并不能准确返回结果。<br>任意泪的实例的 <code>type()</code> 返回结果都是 <code>&lt;type &#39;instance&#39;&gt;</code>。<br>我们可以使用 isinstance() 函数来检测类型。</p></div><div class="story post-story"><h2 id="建议-13：尽量转换为浮点类型后再做除法"><a href="#建议-13：尽量转换为浮点类型后再做除法" class="headerlink" title="建议 13：尽量转换为浮点类型后再做除法"></a>建议 13：尽量转换为浮点类型后再做除法</h2><h2 id="建议-14：警惕-eval-的安全漏洞"><a href="#建议-14：警惕-eval-的安全漏洞" class="headerlink" title="建议 14：警惕 eval() 的安全漏洞"></a>建议 14：警惕 eval() 的安全漏洞</h2><p>Python 中 eval() 函数将字符串 str 当初有效的表达式来求值并返回计算结果。其函数声明如下：<br><code>eval(expression[, globals[, locals]])</code><br>其中参数 globals 为字典形式，locals 为任何映射对象，他们分别表示全局和局部命名空间。<br>如果传入 globals 参数的字典中缺少 <code>__builtins__</code> 的时候，当前的全局命名空间将作为 globals 参数输入并且在表达式计算之前被解析。<br>locals 参数默认与 globals 相同，如果两者都省略的话，表达式将在 eval() 调用的环境中执行。</p><p>如果使用对象不是信任源，应该尽量避免使用 eval，在需要使用 eval 的地方可用安全性更好的 ast.literal_eval 替代。</p></div><div class="story post-story"><h2 id="建议-15：使用-enumerate-获取序列迭代的索引和值"><a href="#建议-15：使用-enumerate-获取序列迭代的索引和值" class="headerlink" title="建议 15：使用 enumerate() 获取序列迭代的索引和值"></a>建议 15：使用 enumerate() 获取序列迭代的索引和值</h2><h2 id="建议-16：分清-x3D-x3D-与-is-的适用场景"><a href="#建议-16：分清-x3D-x3D-与-is-的适用场景" class="headerlink" title="建议 16：分清 &#x3D;&#x3D; 与 is 的适用场景"></a>建议 16：分清 &#x3D;&#x3D; 与 is 的适用场景</h2><table><thead><tr><th align="left">操作符</th><th align="left">意义</th></tr></thead><tbody><tr><td align="left">is</td><td align="left">object identity</td></tr><tr><td align="left">&#x3D;&#x3D;</td><td align="left">equal</td></tr></tbody></table><p>is 表示的是对象标识符 (object identity)，而 &#x3D;&#x3D; 表示的意思是相等。<br>is 的作用是用来检查对象的标识符是否一致的，也就是比较两个对象在内存中是否拥有同一块内存空间。<br>&#x3D;&#x3D; 才是用来检验两个对象的值是否相等的，它实际调用内部 <code>__eq__()</code> 方法。</p></div><div class="story post-story"><h2 id="建议-17：考虑兼容性，尽可能使用-Unicode"><a href="#建议-17：考虑兼容性，尽可能使用-Unicode" class="headerlink" title="建议 17：考虑兼容性，尽可能使用 Unicode"></a>建议 17：考虑兼容性，尽可能使用 Unicode</h2><h2 id="建议-18：构建合理的包层次来管理-module"><a href="#建议-18：构建合理的包层次来管理-module" class="headerlink" title="建议 18：构建合理的包层次来管理 module"></a>建议 18：构建合理的包层次来管理 module</h2><p>什么是包？简单说包即是目录，但是与目录不同，它除了包含常规的 Python 文件以外，还包含一个 <code>__init__.py</code> 文件，同时它允许嵌套。<br>包有以下几种导入方法：</p><ol><li>直接导入一个包<br><code>import Package</code></li><li>导入子模块或子包，包嵌套的情况下可以进行嵌套导入<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Package <span class="keyword">import</span> Module1</span><br><span class="line"><span class="keyword">import</span> Package.Module1</span><br></pre></td></tr></table></figure></li></ol><p>包的使用能够带来以下便利：</p><ul><li>合理组织代码，便于维护和使用</li><li>能够有效的避免命名空间冲突</li></ul></div><div class="story post-story"><h2 id="建议-19：有节制的使用-from-import-语句"><a href="#建议-19：有节制的使用-from-import-语句" class="headerlink" title="建议 19：有节制的使用 from...import 语句"></a>建议 19：有节制的使用 from...import 语句</h2><p>在使用 import 的时候注意以下几点：</p><ul><li>一般情况下尽量优先使用 import a 形式</li><li>有节制地使用 from a import B 形式，可以直接访问 B</li><li>尽量避免使用 from a import *，因为这会污染命名空间，并且无法清晰的表示导入了哪些对象</li></ul><p>当加载一个模块的时候，解释器实际上要完成以下动作：</p><ol><li>在 sys.modules 中进行搜索看看模块是否已经存在，如果存在，则将其导入到当前局部命名空间，加载结束。</li><li>如果在 sys.modules 中找不到对应的模块名称，则为需要导入的模块创建一个字典对象，并将该对象信息插入 sys.modules 中。</li><li>加载钱确认是否需要对模块对应的文件进行编译，如果需要则先进行编译。</li><li>执行动态加载，在当前模块的命名空间中执行编译后的字节码，并将其中所有的对象放入模块对应的字典中。</li></ol><p>对于 from...import 无节制的使用会带来什么问题：</p><ol><li>命名空间的冲突</li><li>循环嵌套导入的问题</li></ol></div><div class="story post-story"><h2 id="建议-20：优先使用-absolute-import-来导入模块"><a href="#建议-20：优先使用-absolute-import-来导入模块" class="headerlink" title="建议 20：优先使用 absolute import 来导入模块"></a>建议 20：优先使用 absolute import 来导入模块</h2><h2 id="建议-21：i-x3D-1-不等于-i"><a href="#建议-21：i-x3D-1-不等于-i" class="headerlink" title="建议 21：i+&#x3D;1 不等于 ++i"></a>建议 21：i+&#x3D;1 不等于 ++i</h2><p>Python 中是不支持概念中 ++i 操作的。<br>但是如果你这么写，会被 Python 解释成 +(+i)，其中 + 表示正号</p></div><div class="story post-story"><h2 id="建议-22：使用-with-自动关闭资源"><a href="#建议-22：使用-with-自动关闭资源" class="headerlink" title="建议 22：使用 with 自动关闭资源"></a>建议 22：使用 with 自动关闭资源</h2><p>with 语句可以在代码块执行完毕后还原进入该代码块时的现场。包含有 with 语句的代码块的执行过程如下：</p><ol><li>计算表达式的值，返回一个上下文管理器对象。</li><li>加载上下文管理器对象的 <code>__exit__()</code> 方法以备后用</li><li>调用上下文管理器对象的 <code>__enter__()</code> 方法</li><li>如果 with 语句中设置了目标对象，则将 <code>__enter__()</code> 方法的返回值赋值给目标对象</li><li>执行 with 中的代码块</li><li>如果步骤5中代码正常结束，调用上下文管理器的 <code>__exit__()</code> 方法，其返回值直接忽略。</li><li>如果步骤5中代码执行过程中发生异常，调用上下文管理器的 <code>__exit__()</code> 方法，并将异常类型、值及 traceback 信息作为参数传递给 <code>__exit__()</code> 方法。<br>如果 <code>__exit__()</code> 返回值为 False，则异常会重新抛出；如果其返回值为 True，异常被挂起，程序继续执行。</li></ol></div><div class="story post-story"><h2 id="建议-23：使用-else-子句简化循环（异常处理）"><a href="#建议-23：使用-else-子句简化循环（异常处理）" class="headerlink" title="建议 23：使用 else 子句简化循环（异常处理）"></a>建议 23：使用 else 子句简化循环（异常处理）</h2><h2 id="建议-24：遵循异常处理的几点基本原则"><a href="#建议-24：遵循异常处理的几点基本原则" class="headerlink" title="建议 24：遵循异常处理的几点基本原则"></a>建议 24：遵循异常处理的几点基本原则</h2><ol><li>注意异常的粒度，不推荐在 try 中放入过多的代码。</li><li>谨慎使用单独的 except 语句处理所有异常，最好能定位具体的异常。</li><li>注意异常捕获的顺序，在合适的层次处理异常。推荐的方法是将继承结构中子类异常在前面的 except 语句中抛出，而父类异常在后面的 except 语句中抛出。</li><li>使用更为友好的异常信息，遵循异常参数的规范。</li></ol></div><div class="story post-story"><h2 id="建议-25：避免-finally-中可能发生的陷阱"><a href="#建议-25：避免-finally-中可能发生的陷阱" class="headerlink" title="建议 25：避免 finally 中可能发生的陷阱"></a>建议 25：避免 finally 中可能发生的陷阱</h2><p>在实际应用程序开发过程中，并不推荐在 finally 中使用 return 语句或 break 进行返回，这种处理方式不仅会带来误解而且可能会引起非常严重的错误。</p></div><div class="story post-story"><h2 id="建议-26：深入理解-None，正确判断对象是否为空"><a href="#建议-26：深入理解-None，正确判断对象是否为空" class="headerlink" title="建议 26：深入理解 None，正确判断对象是否为空"></a>建议 26：深入理解 None，正确判断对象是否为空</h2><p>Python 中以下数据会当作空来处理：</p><ul><li>常量 None</li><li>常量 Flase</li><li>任何形式的数值类型零，如0、0L、0.0、0j</li><li>空的序列，如 &#39;&#39;、()、[]</li><li>空的字典，如 {}</li><li>当用户定义的类中定义了 nonzero() 方法和 len() 方法，并且该方法返回整数0或者布尔值 False 的时候。</li></ul><p>其中常量 None 的特殊性体现在它既不是0、False，也不是空字符串，他就是一个空值对象。其数据类型为 NoneType，遵循单例模式，是唯一的，因而不能创建 None 对象。<br>所有赋值为 None 的变量都相等，并且 None 与任何其他非 None 的对象比较结果都为 False</p><p><strong>错误的比较</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_list = []</span><br><span class="line"><span class="keyword">if</span> test_list <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;list is:&#x27;</span>, test_list)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;list is empty&#x27;</span>) </span><br></pre></td></tr></table></figure><p><strong>正确的比较</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_list = []</span><br><span class="line"><span class="keyword">if</span> test_list:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;list is:&#x27;</span>, test_list)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;list is empty&#x27;</span>) </span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="建议-27：连接字符串应优先使用-join-而不是"><a href="#建议-27：连接字符串应优先使用-join-而不是" class="headerlink" title="建议 27：连接字符串应优先使用 join 而不是 +"></a>建议 27：连接字符串应优先使用 join 而不是 +</h2><p>jion 的效率要高于 + 操作符<br>jion 的时间复杂度为O(n), + 的时间复杂度为 O(n^2)</p></div><div class="story post-story"><h2 id="建议-28：格式化字符串时尽量使用-format-方式而不是"><a href="#建议-28：格式化字符串时尽量使用-format-方式而不是" class="headerlink" title="建议 28：格式化字符串时尽量使用 .format 方式而不是 %"></a>建议 28：格式化字符串时尽量使用 .format 方式而不是 %</h2><p>% 操作符格式化字符串时有如下几种用法：</p><ol><li>直接格式化字符或者数值<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;your score is %06.1f&#x27;</span> % <span class="number">9.5</span>)</span><br></pre></td></tr></table></figure></li><li>以元组的形式格式化<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;the %s of a circle with radius %f is %0.3f&#x27;</span> %(<span class="string">&#x27;circumference&#x27;</span>, <span class="number">3</span>, math.pi*radius*<span class="number">2</span>))</span><br></pre></td></tr></table></figure></li><li>以字典的形式格式化<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">itemdict = &#123;<span class="string">&#x27;itemname&#x27;</span>: <span class="string">&#x27;circumference&#x27;</span>, <span class="string">&#x27;radius&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;value&#x27;</span>: math.pi*radius*<span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;the %(itemname)s of a circle with radius %(radius)f is %(value)0.3f&#x27;</span> % itemdict)</span><br></pre></td></tr></table></figure></li></ol><p>.format 方式格式化字符串的基本语法为：<code>[[填充符] 对齐方式][符号][#][0][宽度][,][.精确度][转换类型]</code><br>其中填充符可以是除了 <code>&#123;</code> 和 <code>&#125;</code> 符号之外的任意符号。</p><table><thead><tr><th align="left">对其方式</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">&lt;</td><td align="left">表示左对其，是大多数对象为默认的对其方式</td></tr><tr><td align="left">&gt;</td><td align="left">表示右对其，数值默认的对其方式</td></tr><tr><td align="left">&#x3D;</td><td align="left">仅对数值类型有效，如果有符号的话，在符号后数值前进行填充，如-0029</td></tr><tr><td align="left">^</td><td align="left">居中对其，用空格进行填充</td></tr></tbody></table><table><thead><tr><th align="left">符号</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">+</td><td align="left">正数前加 +，负数前加 -</td></tr><tr><td align="left">-</td><td align="left">正数前不加符号，负数前加 -，为数值的默认形式</td></tr><tr><td align="left">空格</td><td align="left">正数前加空格，负数前加 -</td></tr></tbody></table><p>.format 常用用法：</p><ol><li>使用位置符号</li><li>使用名称</li><li>通过属性<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Customer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, gender, phone</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.gender = gender</span><br><span class="line">        self.phone = phone</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 通过 str() 函数返回格式化的结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Customer(&#123;self.name&#125;,&#123;self.gender&#125;,&#123;self.phone&#125;)&#x27;</span>.<span class="built_in">format</span>(self=self)</span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>(Customer(<span class="string">&#x27;Lisa&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>, <span class="string">&#x27;67889&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;Customer(Lisa, Female, 67889)&#x27;</span></span><br></pre></td></tr></table></figure></li><li>格式化元组的具体项<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">point = (<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line"><span class="string">&#x27;X:&#123;0[0]&#125;;Y:&#123;0[1]&#125;&#x27;</span>.<span class="built_in">format</span>(point)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;X:1;Y:3&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><p>使用 .format 的理由：</p><ol><li>format 方式在使用上较 % 操作符更为灵活</li><li>format 方式可以方便的作为参数传递</li><li>% 最终会被 .format 方式所替代</li><li>% 方法在某些情况下使用时需要特别小心</li></ol></div><div class="story post-story"><h2 id="建议-29：区别对待可变对象和不可变对象"><a href="#建议-29：区别对待可变对象和不可变对象" class="headerlink" title="建议 29：区别对待可变对象和不可变对象"></a>建议 29：区别对待可变对象和不可变对象</h2><p>数字、字符串、元组属于不可变对象<br>字典、列表、字节数组属于可变对象</p><p>看一个经典例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, coures=[]</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.course = coures</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_course</span>(<span class="params">self, course_name</span>):</span><br><span class="line">        self.course.append(course_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">print_course</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.course:</span><br><span class="line">            <span class="built_in">print</span>(item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    stu_a = Student(<span class="string">&#x27;Wang yi&#x27;</span>)</span><br><span class="line">    stu_a.add_course(<span class="string">&#x27;English&#x27;</span>)</span><br><span class="line">    stu_a.add_course(<span class="string">&#x27;Math&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(stu_a.name + <span class="string">&quot;&#x27;s course:&quot;</span>)</span><br><span class="line">    stu_a.print_course()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;----------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    stu_b = Student(<span class="string">&#x27;Li san&#x27;</span>)</span><br><span class="line">    stu_b.add_course(<span class="string">&#x27;Chinese&#x27;</span>)</span><br><span class="line">    stu_b.add_course(<span class="string">&#x27;Physics&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(stu_b.name + <span class="string">&quot;&#x27;s course:&quot;</span>)</span><br><span class="line">    stu_b.print_course()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\MeeSong\AppData\Local\Programs\Python\Python35\python.exe C:/Users/MeeSong/Desktop/test/test.py</span><br><span class="line">Wang yi<span class="string">&#x27;s course:</span></span><br><span class="line"><span class="string">English</span></span><br><span class="line"><span class="string">Math</span></span><br><span class="line"><span class="string">----------------------------</span></span><br><span class="line"><span class="string">Li san&#x27;</span>s course:</span><br><span class="line">English</span><br><span class="line">Math</span><br><span class="line">Chinese</span><br><span class="line">Physics</span><br><span class="line"></span><br><span class="line">Process finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><p>看到没，结果与预想的并不一样。<br>我们通过 <code>id(stu_a.course)</code> 和 <code>id(stu_b.course)</code> (id 是查看对象的内存标识的，即内存地址) 发现两个结果是一样的，说明两个list对象指的是同一块地址。<br>但 <code>stu_a</code> 和 <code>stu_b</code> 本身却是两个不同的对象。在实例化两个对象的时候，这两个对象被分配了不同的内存空间，并且调用 <code>init()</code> 函数进行了初始化。<br>但由于 <code>init()</code> 函数的第二个参数是个默认参数，默认桉树在函数被调用的时候仅仅被评估一次，以后都会使用第一次评估的结果，因此实际上对象空间里面 course 所指向的是同一个list地址。</p><p>我们改成这样就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, coures=<span class="literal">None</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.course = coures <span class="keyword">if</span> coures <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_course</span>(<span class="params">self, course_name</span>):</span><br><span class="line">        self.course.append(course_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">print_course</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.course:</span><br><span class="line">            <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure><p>另外，切片操作相当于浅拷贝。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a[<span class="number">0</span>])</span><br><span class="line"><span class="number">2279905391312</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(b[<span class="number">0</span>])</span><br><span class="line"><span class="number">2279905391312</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a)</span><br><span class="line"><span class="number">2279910237896</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(b)</span><br><span class="line"><span class="number">2279910245384</span></span><br></pre></td></tr></table></figure><p>对于不可变对象，当我们对其进行相关操作的时候，Python 实际上仍然保持原来的值，并重新创建一个新的对象。<br>比如字符串操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s1 = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = s1</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(s2)</span><br><span class="line"><span class="number">2279910241368</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(s1)</span><br><span class="line"><span class="number">2279910241368</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(s1[:<span class="number">1</span>])</span><br><span class="line"><span class="number">2279905395408</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="建议-30：-、-和-：一致的容器初始化形式"><a href="#建议-30：-、-和-：一致的容器初始化形式" class="headerlink" title="建议 30：[]、() 和 {}：一致的容器初始化形式"></a>建议 30：[]、() 和 {}：一致的容器初始化形式</h2><p>建议使用列表解析来初始化，即列表推导式（或元组和字典）<br>列表推导式的语法为：<code>[expr for iter_item in iterable if cond_expr]</code><br>元组推导式的语法为：<code>(expr for iter_item in iterable if cond_expr)</code><br>集合推导式的语法为：<code>&#123;expr for iter_item in iterable if cond_expr&#125;</code><br>字典推导式的语法为：<code>&#123;exprk:exprv for iter_item in iterable if cond_expr&#125;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[v**<span class="number">2</span> <span class="keyword">if</span> v%<span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> v+<span class="number">1</span> <span class="keyword">for</span> v <span class="keyword">in</span> [<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,-<span class="number">1</span>] <span class="keyword">if</span> v&gt;<span class="number">0</span>]</span><br><span class="line">[<span class="number">4</span>, <span class="number">4</span>, <span class="number">16</span>]</span><br></pre></td></tr></table></figure><p>列表推导式非常灵活：</p><ol><li>支持多重嵌套</li><li>支持多重迭代</li><li>列表推导式的语法中的表达式可以是简单表达式，也可以是复杂表达式，甚至是函数</li><li>列表推导式语法中的iterable可以是任意可迭代对象</li></ol><p>为什么推荐俺在需要生成列表的时候使用列表推导式呢？</p><ol><li>使用列表推导式更为直观清晰，代码更为简洁</li><li>列表推导式的效率更高</li></ol></div><div class="story post-story"><h2 id="建议-31：记住函数传参既不是传值也不是传引用"><a href="#建议-31：记住函数传参既不是传值也不是传引用" class="headerlink" title="建议 31：记住函数传参既不是传值也不是传引用"></a>建议 31：记住函数传参既不是传值也不是传引用</h2><p>先看两张图</p><p><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-31.1-55c74.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-31.1-55c74.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-31.2-7876c.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-31.2-7876c.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>对于在Python函数参数是传值还是传引用这个问题：<br>正确叫法应该是传对象或者说传对象的引用。函数参数在传递的过程中将整个对象传入，<br>对可变对象的修改在函数外部以及内部都可见，调用者和被调用者之间共享这个对象，<br>而对于不可变对象， 由于并不能真正被修改，因此修改往往是通过生成一个新对象然后赋值来实现的</p></div><div class="story post-story"><h2 id="建议-32：-警惕默认参数潜在的问题"><a href="#建议-32：-警惕默认参数潜在的问题" class="headerlink" title="建议 32： 警惕默认参数潜在的问题"></a>建议 32： 警惕默认参数潜在的问题</h2><p>这个问题同 <a href="#%E5%BB%BA%E8%AE%AE-29%EF%BC%9A%E5%8C%BA%E5%88%AB%E5%AF%B9%E5%BE%85%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1%E5%92%8C%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1">建议 29：区别对待可变对象和不可变对象</a> 的例子</p></div><div class="story post-story"><h2 id="建议-33：慎用变长参数"><a href="#建议-33：慎用变长参数" class="headerlink" title="建议 33：慎用变长参数"></a>建议 33：慎用变长参数</h2><p>Python 支持可变长度的参数列表，可以通过在函数定义的时候使用 *args 和 **kwargs 这两个特殊语法来实现。</p><ol><li>使用 *args 来实现可变参数列表： *args 用于接收一个包装为元组形式的参数列表来传递非关键字参数，参数个数可以任意。</li><li>使用 **kwargs 接受字典形式的关键字参数列表，其中字典的键值对分别表示不可变参数的参数名和值</li></ol><p>为什么要慎用可变长度参数呢：</p><ol><li>使用过于灵活</li><li>如果一个函数的参数列表很长，虽然可以通过使用 *args 和 **kwargs 来简化函数的定义，但通常这意味着这个函数可以有更好的实现方式，应该被重构。</li><li>可变长参数适合在下列情况下使用：</li></ol><ul><li>为函数添加一个装饰器</li><li>如果参数的数目不确定，可以考虑使用变长参数</li><li>用来实现函数的多态或者在继承情况下子类需要调用父类的某些方法的时候</li></ul></div><div class="story post-story"><h2 id="建议-34：深入理解-str-和-repr-的区别"><a href="#建议-34：深入理解-str-和-repr-的区别" class="headerlink" title="建议 34：深入理解 str() 和 repr() 的区别"></a>建议 34：深入理解 str() 和 repr() 的区别</h2><p>函数 str() 和 repr() 都可以将 Python 中的对象转换为字符串，他们的使用及输出都非常相似</p><p><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-34.1-c7dbb.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-34.1-c7dbb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-34.2-e700e.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/Writing-Solid-Python-Code-Notes/python-34.2-e700e.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>区别主要有以下几点：</p><ol><li>两者之间的目标不同：str() 主要面向用户，其目的是可读性，返回形式为用户友好性和可读性都较强的字符串类型;<br>而 repr() 面向的是Python解释器，或者说开发人员，其目的是准确性，返回值表示 Python 解释器内部的含义，常作为编程人员 debug 用途</li><li>在解释器中输入a时，默认调用 <code>repr()</code> 函数，而 <code>print(a)</code> 则调用 str() 函数</li><li>repr() 的返回值一般可以用 eval() 函数来还原对象，通常来说有这个等式：<code>obj == eval(repr(obj))</code></li><li>这两个方法分别调用内建的 <code>__str__()</code> 和 <code>__repr__()</code> 方法，一般来说在类中都应该定义 <code>__repr__()</code> 方法，而 <code>__str__()</code> 方法则为可选，<br>当可读性比准确性更重要的时候应该考虑定义 <code>__str__()</code> 方法。如果类中没有定义 <code>__str__()</code> 方法，则默认会使用 <code>__repr__()</code> 方法的结果来返回对象的字符串形式。<br>用户实现 <code>__repr__()</code> 方法的时候最好保证其返回值可以用 eval() 方法使对象重新还原</li></ol></div><div class="story post-story"><h2 id="建议-35：分清-staticmenthod-和-classmethod-的适用场景"><a href="#建议-35：分清-staticmenthod-和-classmethod-的适用场景" class="headerlink" title="建议 35：分清 staticmenthod 和 classmethod 的适用场景"></a>建议 35：分清 staticmenthod 和 classmethod 的适用场景</h2><p>静态方法没有常规方法的特殊行为，如绑定、非绑定、隐式参数等规则<br>类方法的调用使用类本身作为其隐含参数，但调用本身并不需要显示提供该参数</p><p>类方法能够根据不同的类型返回对应的类的实例<br>既不跟特定的实例相关，也不跟特定的类相关的时候，用静态方法更合适</p></div><div class="story post-story"><h2 id="建议-36：掌握字符串的基本用法"><a href="#建议-36：掌握字符串的基本用法" class="headerlink" title="建议 36：掌握字符串的基本用法"></a>建议 36：掌握字符串的基本用法</h2><p>小技巧<br>Python 遇到未闭合的小括号时会自动将多行代码拼接为一行和把相邻的两个字符串字面量拼接到一起。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = (<span class="string">&#x27;SELECT * &#x27;</span></span><br><span class="line"><span class="meta">... </span>     <span class="string">&#x27;FROM atable &#x27;</span></span><br><span class="line"><span class="meta">... </span>     <span class="string">&#x27;WHERE afield=&quot;value&quot;&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(s)</span><br><span class="line">SELECT * FROM atable WHERE afield=<span class="string">&quot;value&quot;</span></span><br></pre></td></tr></table></figure><p>性质判定</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">isalnum()</td><td align="left">是否只是数字或字母</td></tr><tr><td align="left">isalpha()</td><td align="left">是否字母</td></tr><tr><td align="left">isdigit()</td><td align="left">是否数字</td></tr><tr><td align="left">islower()</td><td align="left">是否小写</td></tr><tr><td align="left">isupper()</td><td align="left">是否大写</td></tr><tr><td align="left">isspace()</td><td align="left">是否空白符</td></tr><tr><td align="left">istitle()</td><td align="left">是否标题化的，即每个单词首字母是否大写</td></tr><tr><td align="left">startswith(prefix[,start[,end]])</td><td align="left">是否以prefix开头，可范围内检查，prefix可接受tuple类型的实参</td></tr><tr><td align="left">endswith(suffix[,start[,end]])</td><td align="left">是否以suffix结尾，可范围内检查，suffix可接收tuple类型的实参</td></tr></tbody></table><p>查找</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">count(sub[,start[,end]])</td><td align="left">查找sub在字符串中出现的次数，这个数值在调用replace方法时用得着</td></tr><tr><td align="left">find(sub[,start[,end]])</td><td align="left">查找sub在字符串中的位置，找不到时返回-1</td></tr><tr><td align="left">index(sub[,start[,end]])</td><td align="left">同find，不过找不到会抛出 ValueError 异常，另外对于是否包含字串，更推荐使用 in 和 not in 操作符</td></tr><tr><td align="left">rfind(sub[,start[,end]])</td><td align="left">同find，从右侧开始</td></tr><tr><td align="left">rindex(sub[,start[,end]])</td><td align="left">同index，从右侧开始</td></tr></tbody></table><p>替换</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">replace(old, new[,count])</td><td align="left">把字符串中的old替换为new，count为最多替换次数</td></tr><tr><td align="left">translate(table[,deletechars])</td><td align="left">根据table转换字符串的字符，可以由string.maketrans(frm,to)生成；deletechars为过滤掉的字符</td></tr></tbody></table><p>分切</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">partition(sep)</td><td align="left">它接受一个字符串参数，并返回一个3个元素的 tuple 对象。如果sep没出现在母串中，返回值是 (sep, ‘’, ‘’)；否则，返回值的第一个元素是 sep 左端的部分，第二个元素是 sep 自身，第三个元素是 sep 右端的部分。</td></tr><tr><td align="left">rpartition(sep)</td><td align="left"></td></tr><tr><td align="left">splitlines([keepends])</td><td align="left"></td></tr><tr><td align="left">split([sep [,maxsplit]])</td><td align="left">参数 maxsplit 是分切的次数，即最大的分切次数，所以返回值最多有 maxsplit+1 个元素。</td></tr><tr><td align="left">rsplit([sep[,maxsplit]])</td><td align="left"></td></tr></tbody></table><p>不过有一个需要注意的地方<br>对于字符串s、s.split() 和 s.split(&#39; &#39;) 返回值是不同的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27; hello  world!&#x27;</span>.split()</span><br><span class="line">[<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world!&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27; hello  world!&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;world!&#x27;</span>]</span><br></pre></td></tr></table></figure><p>产生差异的原因在于当忽略 sep 参数或sep参数为 None 时与明确给 sep 赋予字符串值时 split() 采用两种不同的算法。<br>对于前者，split() 先去除字符串两端的空白符，然后以任意长度的空白符串作为界定符分切字符串（即连续的空白符串被当作单一的空白符看待）；对于后者则认为两个连续的 sep 之间存在一个空字符串。</p><p>连接<br>join() 函数的高效率（相对于循环相加而言），使它成为最值得关注的字符串方法之一。<br>它的功用是将可迭代的字符串序列连接成一条长字符串，如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>conf = &#123;<span class="string">&#x27;host&#x27;</span>:<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">&#x27;db&#x27;</span>:<span class="string">&#x27;spam&#x27;</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">&#x27;user&#x27;</span>:<span class="string">&#x27;sa&#x27;</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">&#x27;passwd&#x27;</span>:<span class="string">&#x27;eggs&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;;&#x27;</span>.join(<span class="string">&quot;%s=%s&quot;</span>%(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> conf.iteritems())</span><br><span class="line"><span class="string">&#x27;passswd=eggs;db=spam;user=sa;host=127.0.0.1&#x27;</span></span><br></pre></td></tr></table></figure><p>变形</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">lower()</td><td align="left">转小写</td></tr><tr><td align="left">upper()</td><td align="left">转大写</td></tr><tr><td align="left">capitalize()</td><td align="left">把字符串的第一个字符大写</td></tr><tr><td align="left">swapcase()</td><td align="left">翻转 string 中的大小写</td></tr><tr><td align="left">title()</td><td align="left">返回&quot;标题化&quot;的 string,就是说所有单词都是以大写开始，其余字母均为小写</td></tr></tbody></table><p>title()函数是比较特别的，它的功能是将每一个单词的首字母大写，并将单词中的非首字母转换为小写（英文文章的标题通常是这种格式）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;hello world!&#x27;</span>.title()</span><br><span class="line"><span class="string">&#x27;Hello World!&#x27;</span></span><br></pre></td></tr></table></figure><p>因为title() 函数并不去除字符串两端的空白符也不会把连续的空白符替换为一个空格，所以建议使用string 模块中的capwords(s)函数，它能够去除两端的空白符，再将连续的空白符用一个空格代替。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27; hello   world!&#x27;</span>.title()</span><br><span class="line"><span class="string">&#x27; Hello   World!&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>string.capwords(<span class="string">&#x27; hello   world!&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;Hello World!&#x27;</span></span><br></pre></td></tr></table></figure><p>删减</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">strip([chars])</td><td align="left">在 string 上执行 lstrip()和 rstrip()</td></tr><tr><td align="left">lstrip([chars])</td><td align="left">截掉 string 左边的空格</td></tr><tr><td align="left">rstrip([chars])</td><td align="left">删除 string 字符串末尾的空格.</td></tr></tbody></table><p>*strip()函数族用以去除字符串两端的空白符，空白符由string.whitespace常量定义。</p><p>填充</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">center(width[, fillchar])</td><td align="left">返回一个原字符串居中,并使用空格填充至长度 width 的新字符串， fillchar 参数指定了用以填充的字符，默认为空格</td></tr><tr><td align="left">ljust(width[, fillchar])</td><td align="left">返回一个原字符串左对齐,并使用空格填充至长度 width 的新字符串</td></tr><tr><td align="left">rjust(width[, fillchar])</td><td align="left">返回一个原字符串右对齐,并使用空格填充至长度 width 的新字符串</td></tr><tr><td align="left">zfill(width)</td><td align="left">返回长度为 width 的字符串，原字符串 string 右对齐，前面填充0</td></tr><tr><td align="left">expandtabs([tabsize])</td><td align="left">把字符串 string 中的 tab 符号转为空格，tab 符号默认的空格数是 8</td></tr></tbody></table><p>编码</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">encode([encoding[,errors]])</td><td align="left">以 encoding 指定的编码格式编码 string，如果出错默认报一个ValueError 的异常，除非 errors 指定的是&#39;ignore&#39;或者&#39;replace&#39;</td></tr><tr><td align="left">decode([encoding[,errors]])</td><td align="left">以 encoding 指定的编码格式解码 string，如果出错默认报一个 ValueError 的 异 常 ， 除 非 errors 指 定 的 是 &#39;ignore&#39; 或 者&#39;replace&#39;</td></tr></tbody></table></div><div class="story post-story"><h2 id="建议-37：按需选择-sort-或者-sorted"><a href="#建议-37：按需选择-sort-或者-sorted" class="headerlink" title="建议 37：按需选择 sort() 或者 sorted()"></a>建议 37：按需选择 sort() 或者 sorted()</h2><p><code>sorted(iterable[, cmp[, key[, reverse]]])</code><br><code>s.sort([cmp[, key[, reverse]]])</code></p><ul><li>cmp 为用户定义的任何比较函数，函数的参数为两个可比较的元素（来自iterable或者list），函数根据第一个参数与第二个参数的关系依次返回 -1、0、+1（第一个参数小于第二个参数则返回负数）。该参数默认值为None。</li><li>key 是带一个参数的函数，用来为每个元素提取比较值，默认为None（即直接比较每个元素）</li><li>reverse 表示结果是否反转</li></ul><p>sort() 与 sorted() 之间的比较：</p><ol><li>相比于 sort()，sorted() 使用范围更为广泛</li><li>当排序对象为列表的时候两者适合的场景不同。sorted() 函数会返回一个排序后的立标，原有列表保持不变；而 sort() 函数会直接修改原有列表，函数返回为 None</li><li>无论是 sort() 还是 sorted() 函数，传入参数 key 比传入参数 cmp 效率要高。</li><li>sorted() 函数功能非常强大，使用它可以方便的针对不同的数据结构进行排序，从而满足不同需求。对于 itemgetter 的使用，参见 <a href="http://beginman.cn/python/2015/05/18/python-operator-sorted/" target="_blank" rel="noopener external nofollow noreferrer">python operator.itemgetter函数与sorted的妙用</a></li></ol><ul><li>对字典进行排序<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>phonebook = &#123;<span class="string">&#x27;Linda&#x27;</span>:<span class="string">&#x27;7750&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>:<span class="string">&#x27;9345&#x27;</span>, <span class="string">&#x27;Carol&#x27;</span>:<span class="string">&#x27;5834&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted_pb = <span class="built_in">sorted</span>(phonebook.items(), key=itemgetter(<span class="number">1</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted_pb</span><br><span class="line">[(<span class="string">&#x27;Carol&#x27;</span>, <span class="string">&#x27;5834&#x27;</span>), (<span class="string">&#x27;Linda&#x27;</span>, <span class="string">&#x27;7750&#x27;</span>), (<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;9345&#x27;</span>)]</span><br></pre></td></tr></table></figure></li><li>多维 list 排序<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gameresult = [[<span class="string">&#x27;Bob&#x27;</span>, <span class="number">95.00</span>, <span class="string">&#x27;A&#x27;</span>], [<span class="string">&#x27;Alan&#x27;</span>, <span class="number">86.0</span>, <span class="string">&#x27;C&#x27;</span>], [<span class="string">&#x27;Mandy&#x27;</span>, <span class="number">82.5</span>, <span class="string">&#x27;A&#x27;</span>], [<span class="string">&#x27;Rob&#x27;</span>, <span class="number">86</span>, <span class="string">&#x27;E&#x27;</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">sorted</span>(gameresult, key=itemgetter(<span class="number">2</span>,<span class="number">1</span>))</span><br><span class="line">[[<span class="string">&#x27;Mandy&#x27;</span>, <span class="number">82.5</span>, <span class="string">&#x27;A&#x27;</span>], [<span class="string">&#x27;Bob&#x27;</span>, <span class="number">95.0</span>, <span class="string">&#x27;A&#x27;</span>], [<span class="string">&#x27;Alan&#x27;</span>, <span class="number">86.0</span>, <span class="string">&#x27;C&#x27;</span>], [<span class="string">&#x27;Rob&#x27;</span>, <span class="number">86</span>, <span class="string">&#x27;E&#x27;</span>]]</span><br></pre></td></tr></table></figure></li><li>字典中混合 list 排序<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mydict = &#123;<span class="string">&#x27;Li&#x27;</span>: [<span class="string">&#x27;M&#x27;</span>, <span class="number">7</span>],</span><br><span class="line">          <span class="string">&#x27;Zhang&#x27;</span>: [<span class="string">&#x27;E&#x27;</span>, <span class="number">2</span>],</span><br><span class="line">          <span class="string">&#x27;Wang&#x27;</span>: [<span class="string">&#x27;p&#x27;</span>, <span class="number">3</span>],</span><br><span class="line">          <span class="string">&#x27;Du&#x27;</span>: [<span class="string">&#x27;c&#x27;</span>, <span class="number">2</span>],</span><br><span class="line">          <span class="string">&#x27;Ma&#x27;</span>: [<span class="string">&#x27;c&#x27;</span>, <span class="number">9</span>],</span><br><span class="line">          <span class="string">&#x27;Zhe&#x27;</span>: [<span class="string">&#x27;H&#x27;</span>, <span class="number">7</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(mydict.items(), key=<span class="keyword">lambda</span> item: itemgetter(<span class="number">1</span>)(itemgetter(<span class="number">1</span>)(item))))</span><br><span class="line"></span><br><span class="line">[(<span class="string">&#x27;Zhang&#x27;</span>, [<span class="string">&#x27;E&#x27;</span>, <span class="number">2</span>]), (<span class="string">&#x27;Du&#x27;</span>, [<span class="string">&#x27;c&#x27;</span>, <span class="number">2</span>]), (<span class="string">&#x27;Wang&#x27;</span>, [<span class="string">&#x27;p&#x27;</span>, <span class="number">3</span>]), (<span class="string">&#x27;Li&#x27;</span>, [<span class="string">&#x27;M&#x27;</span>, <span class="number">7</span>]), (<span class="string">&#x27;Zhe&#x27;</span>, [<span class="string">&#x27;H&#x27;</span>, <span class="number">7</span>]), (<span class="string">&#x27;Ma&#x27;</span>, [<span class="string">&#x27;c&#x27;</span>, <span class="number">9</span>])]</span><br></pre></td></tr></table></figure></li><li>list 中混合字典排序<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gameresult = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;wins&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">75.00</span>&#125;,</span><br><span class="line">              &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;David&#x27;</span>, <span class="string">&#x27;wins&#x27;</span>:<span class="number">3</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">57.00</span>&#125;,</span><br><span class="line">              &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Carol&#x27;</span>, <span class="string">&#x27;wins&#x27;</span>:<span class="number">4</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">57.00</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(gameresult, key=itemgetter(<span class="string">&#x27;rating&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">[&#123;<span class="string">&#x27;wins&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Carol&#x27;</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">57.0</span>&#125;, &#123;<span class="string">&#x27;wins&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;David&#x27;</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">57.0</span>&#125;, &#123;<span class="string">&#x27;wins&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;losses&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;rating&#x27;</span>: <span class="number">75.0</span>&#125;]</span><br></pre></td></tr></table></figure></li></ul></div><div class="story post-story"><h2 id="建议-38：-使用-copy-模块进行深拷贝对象"><a href="#建议-38：-使用-copy-模块进行深拷贝对象" class="headerlink" title="建议 38： 使用 copy 模块进行深拷贝对象"></a>建议 38： 使用 copy 模块进行深拷贝对象</h2><p>概念：</p><ul><li>浅拷贝（shallow copy）：构造一个新的复合对象并将从原对象中发现的引用插入该对象中。浅拷贝的实现方式与多种，如工厂函数、切片操作、copy模块中的copy操作。</li><li>深拷贝（deep copy）：也是构造一个新的复合对象，但是遇到引用会继续递归拷贝其所指向的具体内容，也就是说它会针对引用所指向的对象继续执行拷贝，因此产生的对象不受其他引用对象操作的影响。</li></ul></div><div class="story post-story"><h2 id="建议-39：使用-Counter-进行计数统计"><a href="#建议-39：使用-Counter-进行计数统计" class="headerlink" title="建议 39：使用 Counter 进行计数统计"></a>建议 39：使用 Counter 进行计数统计</h2><p>Counter 类是自 Python2.7 起增加的，属于字典的子类，是一个容器对象，主要用来统计散列对象。</p></div><div class="story post-story"><h2 id="建议-40：深入掌握-ConfigParser"><a href="#建议-40：深入掌握-ConfigParser" class="headerlink" title="建议 40：深入掌握 ConfigParser"></a>建议 40：深入掌握 ConfigParser</h2><h2 id="建议-41：使用-argparse-处理命令行参数"><a href="#建议-41：使用-argparse-处理命令行参数" class="headerlink" title="建议 41：使用 argparse 处理命令行参数"></a>建议 41：使用 argparse 处理命令行参数</h2><p>另外，还有更先进好用的 docopt，不过暂时还没加入标准库。详见 <a href="http://docopt.org/" target="_blank" rel="noopener external nofollow noreferrer">docopt</a></p></div><div class="story post-story"><h2 id="建议-42：使用-pandas-处理大型-CSV-文件"><a href="#建议-42：使用-pandas-处理大型-CSV-文件" class="headerlink" title="建议 42：使用 pandas 处理大型 CSV 文件"></a>建议 42：使用 pandas 处理大型 CSV 文件</h2><p>CSV(Comma Separated Values) 作为一种逗号分隔符型值的纯文本格式文件，在实际应用中经常用到，如数据库的导入导出、数据分析中记录的存储等。</p><p>CSV 处理相关 API：</p><ol><li>&#39;reader(csvfile[, dialect&#x3D;&#39;excel&#39;][, fmtparam])&#39;，主要用于 CSV 文件的读取，返回一个 reader 对象用于在 CSV 文件内容上进行行迭代</li><li>&#39;csv.writer(csvfile, dialect&#x3D;&#39;excel&#39;, **fmtparams)&#39;，用于写入 CSV 文件。</li><li>&#39;csv.DictReader(csvfile, fieldnames&#x3D;None, restkey&#x3D;None, restval&#x3D;None, dialect&#x3D;&#39;excel&#39;, *args, **kwds)&#39;，将读入的信息映射到一个字典中去</li><li>&#39;csv.DictWrite(csvfile, fieldnames, restval&#x3D;&#39;&#39;, extrasaction&#x3D;&#39;raise&#39;, dialect&#x3D;&#39;excel&#39;, *args, **kwds)&#39;，用于支持字典的写入。</li></ol><p>但是在处理大型 CSV 文件，上面API会抛出 MemoryError 异常。</p><p>Pandas 即 Python Data Analysis Library，是为了解决数据分析而创建的第三方工具，支持多种文件格式处理，包括 CSV、HDF5、HTML 等，能够提供高效的大型数据处理。</p><ul><li>Series：它是一种类似数据的带索引的一维数据结构，支持的类型与 NumPy 兼容。</li><li>DataFrame：类似于电子表格，其数据为排好序的数据列的集合，每一列都可以是不同的数据类型，它类似于一个二维数据结构，支持行和列的索引。</li></ul></div><div class="story post-story"><h2 id="建议-43：一般情况使用-ElementTree-解析-XML"><a href="#建议-43：一般情况使用-ElementTree-解析-XML" class="headerlink" title="建议 43：一般情况使用 ElementTree 解析 XML"></a>建议 43：一般情况使用 ElementTree 解析 XML</h2><ul><li>使用简单</li><li>内存上消耗明显低于 DOM 解析。</li><li>支持 XPath 查询</li></ul></div><div class="story post-story"><h2 id="建议-44：理解模块-pickle-优劣"><a href="#建议-44：理解模块-pickle-优劣" class="headerlink" title="建议 44：理解模块 pickle 优劣"></a>建议 44：理解模块 pickle 优劣</h2><p>pickle 估计是最通用的序列化模块了，它还有个 C 语言的实现 cPickle，相比 pickle 来说具有较好的性能，其速度大概是 pickle 的 1000 倍，除了不能被继承之外，它们两者的使用基本上区别不大</p><p>pickle 中最主要的两个函数对儿为 dump() 和 load()，分别来进行对象的序列化和反序列化：</p><ul><li>pickle.dump(obj, file[, protocol])：序列化数据到一个文件描述符。</li><li>pickle.load(file)：表示把文件中的对象恢复为原来的对象。</li></ul><p>pickle 模块的优点：</p><ol><li>接口简单，容易使用</li><li>pickle 的存储格式具有通用性，能够被不同平台的 Python 解析器共享</li><li>支持的数据类型广泛</li><li>pickle 模块是可扩展的</li><li>能够自动维护对象间的引用，如果一个对象上存在多个引用，pickle 后不会改变对象间的引用</li></ol><p>pickle 模块的限制：</p><ol><li>pickle 不能保证操作的原子性</li><li>pickle 存在安全性问题</li><li>pickle 协议是 Python 特性的，不同语言之间的兼容性难以保证</li></ol></div><div class="story post-story"><h2 id="建议-45：序列化的另一个不错的选择——JSON"><a href="#建议-45：序列化的另一个不错的选择——JSON" class="headerlink" title="建议 45：序列化的另一个不错的选择——JSON"></a>建议 45：序列化的另一个不错的选择——JSON</h2><p>相比 pickle，JSON 具有以下优势：</p><ol><li>使用简单，支持多种数据类型，仅存在以下两大数据结构：</li></ol><ul><li>名称 &#x2F; 值 对儿的集合 （dict）</li><li>值的有序列表 （list）</li></ul><ol start="2"><li>存储格式可读性更为友好，容易修改。</li><li>JSON 支持跨平台跨语言</li><li>具有较强的扩展性，JSON 模块还提供了编码（JSONEncoder）和解码类（JSONDecoder），以便用户对其默认不支持的序列化类型进行扩展</li></ol></div><div class="story post-story"><h2 id="建议-46：使用-traceback-获取栈信息"><a href="#建议-46：使用-traceback-获取栈信息" class="headerlink" title="建议 46：使用 traceback 获取栈信息"></a>建议 46：使用 traceback 获取栈信息</h2><p>常用方法：</p><ol><li>traceback.print_exception(type, value, traceback[, limit[, file]])，根据 limit 的设置打印栈信息，file 为 None 的情况下定位到 sys.stderr，否则写入到文件；<br>其中 type、value、traceback 这3个参数对应的值可以从 sys.exc_info() 中获取</li><li>traceback.print_exc(limit[, file])，为 print_exception 函数的缩写，不需要传入 type、value、traceback 这三个参数</li><li>traceback.format_exc([limit])，与 print_exc() 类似，区别在于返回形式为字符串</li><li>traceback.extract_stack([file[, limit]])，从当前栈帧中提取 trace 信息。</li></ol></div><div class="story post-story"><h2 id="建议-47：使用-logging-记录日志信息"><a href="#建议-47：使用-logging-记录日志信息" class="headerlink" title="建议 47：使用 logging 记录日志信息"></a>建议 47：使用 logging 记录日志信息</h2><p>使用见 <a href="http://hgoldfish.com/blogs/article/7/" target="_blank" rel="noopener external nofollow noreferrer">Python的日志系统</a></p></div><div class="story post-story"><h2 id="建议-48：使用-threading-模块编写多线程程序"><a href="#建议-48：使用-threading-模块编写多线程程序" class="headerlink" title="建议 48：使用 threading 模块编写多线程程序"></a>建议 48：使用 threading 模块编写多线程程序</h2><p>实际应用中推荐使用 threading 模块而不是 thread 模块：</p><ol><li>threading 模块对同步原语的支持更为完善和丰富</li><li>threading 模块在主线程和子线程交互上更为友好</li><li>thread 模块不支持守护线程</li><li>python3 中已经不存在 thread 模块</li></ol><p>使用见 <a href="http://hgoldfish.com/blogs/article/80/" target="_blank" rel="noopener external nofollow noreferrer">Python中使用线程的技巧</a></p></div><div class="story post-story"><h2 id="建议-49：使用-Queue-使多线程编程更安全"><a href="#建议-49：使用-Queue-使多线程编程更安全" class="headerlink" title="建议 49：使用 Queue 使多线程编程更安全"></a>建议 49：使用 Queue 使多线程编程更安全</h2><h2 id="建议-50：利用模块实现单例模式"><a href="#建议-50：利用模块实现单例模式" class="headerlink" title="建议 50：利用模块实现单例模式"></a>建议 50：利用模块实现单例模式</h2><h2 id="建议-51：用-mixin-模式让程序更加灵活"><a href="#建议-51：用-mixin-模式让程序更加灵活" class="headerlink" title="建议 51：用 mixin 模式让程序更加灵活"></a>建议 51：用 mixin 模式让程序更加灵活</h2><h2 id="建议-52：用发布订阅模式实现松耦合"><a href="#建议-52：用发布订阅模式实现松耦合" class="headerlink" title="建议 52：用发布订阅模式实现松耦合"></a>建议 52：用发布订阅模式实现松耦合</h2><h2 id="建议-53：用状态模式美化代码"><a href="#建议-53：用状态模式美化代码" class="headerlink" title="建议 53：用状态模式美化代码"></a>建议 53：用状态模式美化代码</h2><h2 id="建议-54：理解-built-in-objects"><a href="#建议-54：理解-built-in-objects" class="headerlink" title="建议 54：理解 built-in objects"></a>建议 54：理解 built-in objects</h2><p>Python 一切皆对象。<br>自 Python2.2 之后，为了弥补内建类型和古典类之间的鸿沟，引入了新式类。<br>新式类中，object 是所有内建类型的积累，用户定义的类可以继承自 object 也可继承自内建类型。</p><blockquote><p>这里的鸿沟指的是：在 2.2 版本之前，类和类型并不统一，如 a 是古典类 ClassA 的一个实例，那么 <code>a.__class__</code> 返回 <code>&#39;class__main__ClassA&#39;</code>，<code>type(a)</code> 返回 <code>&lt;type&#39;instalce&#39;&gt;</code>。<br>当引入新类后，比如 ClassB 是个新类，b 是 ClassB 的实例，b.<strong>class</strong> 和 type(b) 都是返回 <code>&#39;class__main__.ClassB&#39;</code></p></blockquote><p>新式类相对于古典类来说有很多优势：能够基于内建类型构建新的用户类型，支持 property 和描述符特性等。</p></div><div class="story post-story"><h2 id="建议-55：-init-不是构造方法"><a href="#建议-55：-init-不是构造方法" class="headerlink" title="建议 55：__init__() 不是构造方法"></a>建议 55：<code>__init__()</code> 不是构造方法</h2><p>实际上 <code>__init__()</code> 并不是真正意义上的构造方法，<code>__init__()</code>方法所做的工作是在类的对象创建好之后进行变量的初始化。<code>__new__()</code>方法才会真正创建实例，是类的构方法。</p><p>两个方法之间的不同点，总结如下：</p><ul><li><code>object.__new__(cls[, args...])</code>：其中 cls 代表类，args 为参数列表</li><li><code>object.__init__(self[, args...])</code>：其中 self 代表实例对象，args 为参数列表</li><li><code>__new__()</code> 方法是静态方法，<code>__init__()</code> 为实例方法</li><li><code>__new__()</code> 方法一般需要返回类的对象，当返回类的对象时将会自动调用 <code>__init__()</code> 方法进行初始化，如果没有对象返回，则 <code>__init__()</code> 方法不会被调用。 <code>__init__()</code> 方法不需要显式返回，默认为 None，否则会在运行时抛出 TypeError</li><li>当需要控制实例创建的时候可使用 <code>__new__()</code> 方法，而控制实例初始化的时候用 <code>__init__()</code> 方法</li><li>一般情况下不需要覆盖 <code>__new__()</code> 方法，但当子类继承自不可变类型，如 str、int、unicode 或者 tuple 的时候，往往需要覆盖该方法。</li><li>当需要覆盖 <code>__new__()</code> 和 <code>__init__()</code> 方法的时候这两个方法的参数必须保持一致，如果不一致将会导致异常。</li></ul><p>什么特殊情况下需要覆盖 <code>__new__()</code> 方法呢？</p><ol><li>当类继承不可变类型且默认的 <code>__new__()</code> 方法不能满足需求的时候。</li><li>用来实现工厂模式或者单例模式或者进行元类便哼的时候</li><li>作为用来初始化的 <code>__init__()</code> 方法在多继承的情况下，子类的 <code>__init__()</code> 方法如果不显式调用父类的 <code>__init__()</code> 方法，则父类的 <code>__init__()</code> 方法不会被调用。</li></ol></div><div class="story post-story"><h2 id="建议-56：理解名字查找机制"><a href="#建议-56：理解名字查找机制" class="headerlink" title="建议 56：理解名字查找机制"></a>建议 56：理解名字查找机制</h2><p>在 Python 中，所有所谓的变量其实都是名字，这些名字指向一个或者多个 Python 对象。</p><p>Python 中有 4 中作用域：</p><ul><li><strong>局部作用域</strong>：一般来说函数的每次调用都会创建一个新的本地作用于，拥有新的命名空间。</li><li><strong>全局作用域</strong>：定义在Python模块文件中的变量名拥有全局作用域，需要注意的是这里的全局仅限单个文件，即在一个文件的顶层的变量名仅在这个文件内可见，并非所有的文件，其他文件中想使用这些变量必须先导入文件对应的模块</li><li><strong>嵌套作用域</strong>：一般在多重函数嵌套的情况下才会考虑到，在嵌套作用域的情况下，如果想在嵌套的函数内修改外层函数中定义的变量，即使使用 global 进行声明也不能达到目的，其结果最终是在嵌套的函数所在的命名空间中创建了一个新的变量。</li><li><strong>内置作用域</strong>：通过一个标准库名为 <code>__builtin__</code> 的模块来实现的。</li></ul><p>Python 的名字查找机制如下：</p><ol><li>在最内层范围内查找，一般而言就是函数内部，即在 locals() 里面查找</li><li>在模块内查找，即在 globals() 里面查找</li><li>在外层查找，即在内置模块中查找，也就是在 <code>__builtin__</code> 中查找</li></ol><p>若要修改全局变量，在 Python3 中可以使用 nonlocal 来声明变量</p></div><div class="story post-story"><h2 id="建议-57：为什么需要-self-参数"><a href="#建议-57：为什么需要-self-参数" class="headerlink" title="建议 57：为什么需要 self 参数"></a>建议 57：为什么需要 self 参数</h2><ol><li>Python 在当初设计的时候借鉴了其他语言的一些特征，如 Moudla-3 中方法会显示的在参数列表中传入 self。</li><li>Python 语言本身的动态性决定了使用 self 能够带来一定便利。</li><li>在存在同名的局部变量以及实例变量的情况下使用 self 使得实例变量更容易被区分</li></ol></div><div class="story post-story"><h2 id="建议-58：理解-MRO-与多继承"><a href="#建议-58：理解-MRO-与多继承" class="headerlink" title="建议 58：理解 MRO 与多继承"></a>建议 58：理解 MRO 与多继承</h2><h2 id="建议-59：理解描述符机制"><a href="#建议-59：理解描述符机制" class="headerlink" title="建议 59：理解描述符机制"></a>建议 59：理解描述符机制</h2><h2 id="建议-60：区别-getattr-和-getattribute-方法"><a href="#建议-60：区别-getattr-和-getattribute-方法" class="headerlink" title="建议 60：区别 __getattr__() 和 __getattribute__() 方法"></a>建议 60：区别 <code>__getattr__()</code> 和 <code>__getattribute__()</code> 方法</h2><p><code>__getattr__()</code> 和 <code>__getattribute__()</code> 都可以用作实例属性的获取和拦截（仅对实例属性）<br><code>__getattr__()</code> 适用于未定义的属性，即该属性在实例中以及对应的类的基类以及祖先类中都不存在<br><code>__getattribute__()</code> 对于所有属性的访问都会调用该方法，仅应用于新式类</p><p>覆盖这些方法时，几点注意事项：</p><ol><li><p>避免无穷递归。例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__getattribute__</span>(<span class="params">self, attr</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> self.__dict__[attr]</span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br></pre></td></tr></table></figure><p>属性的访问调用的是覆盖的 <code>__getattribute__()</code> 方法，而该方法中 <code>self.__dict__[attr]</code> 又要调用 <code>__getattribute__(self, attr)</code>，于是产生了无穷递归。正确方法是使用 <code>super(obj, self).__getattribute__(attr)</code>。</p></li><li><p>访问未定义的属性。如果在 <code>__getattribute__()</code> 方法中不抛出 AttributeError 异常或者显示返回一个值，则会返回 None，此时可能会影响到程序的实际运行预期</p></li><li><p>覆盖了 <code>__getattribute__()</code> 方法之后，任何属性的访问都会调用用户定义的 <code>__getattribute__()</code> 方法，性能上会有损耗</p></li><li><p>覆盖的 <code>__getattr__()</code> 方法如果能够动态处理事先未定义的属性，可以更好的实现数据隐藏。</p></li></ol><blockquote><p><code>__getattribute__()</code> 总是会被调用，而 <code>__getattr__()</code> 只有在 <code>__getattribute__()</code> 中引发异常的情况下才会被调用。</p></blockquote></div><div class="story post-story"><h2 id="建议-61：使用更为安全的-property"><a href="#建议-61：使用更为安全的-property" class="headerlink" title="建议 61：使用更为安全的 property"></a>建议 61：使用更为安全的 property</h2><p>property 是用来实现属性可管理性的 built-in 数据类型，其实质是一种特殊的数据描述符。<br>它和普通描述符的区别在于：普通描述符提供的是一种较为低级的控制属性访问的机制，而 property 是它的高级应用，它以标准库的形式提供描述符的实现，其签名形式为：<br><code>property(fget=None, fset=None, fdel=None, doc=None) -&gt; property attribute</code></p><p>property 的优势可以简单概括为以下几点：</p><ol><li>代码更简洁，可读性更强。</li><li>更好的管理属性的访问</li><li>代码可维护性更好</li><li>控制属性访问权限，提高数据安全性</li></ol></div><div class="story post-story"><h2 id="建议-62：掌握-metaclass"><a href="#建议-62：掌握-metaclass" class="headerlink" title="建议 62：掌握 metaclass"></a>建议 62：掌握 metaclass</h2><p>什么是元类？</p><ul><li>元类是关于类的类，是类的模板</li><li>元类是用来控制如何创建类的，正如类是创建对象的模板一样</li><li>元类的实例为类，正如类的实例为对象</li></ul><p>元类需要注意的几点：</p><ol><li>区别类方法与元方法</li><li>多继承需要严格限制，否则会产生冲突</li></ol><blockquote><p>元类用来指导类的生成，元方法可以从元类或者类中调用，不能从类的实例中调用，而类方法既可以从类中调用，也可以从类的实例中调用。</p></blockquote></div><div class="story post-story"><h2 id="建议-63：-熟悉-Python-对象协议"><a href="#建议-63：-熟悉-Python-对象协议" class="headerlink" title="建议 63： 熟悉 Python 对象协议"></a>建议 63： 熟悉 Python 对象协议</h2><ol><li><p>用以比较大小的协议，这个协议依赖于 <code>__cmp__()</code> 方法，相等返回0，小于返回负值，大于返回正值。<br>还有其他诸如 <code>__eq__()</code>、<code>__ne__()</code>、<code>__lt__()</code>、<code>__gt__()</code> 等方法来实现相等、不等、小于和大于的判定。这也就是 Python 对 &#x3D;&#x3D;、!&#x3D;、&lt; 和 &gt; 等操作符的进行重载的支撑机制</p></li><li><p>数值类型相关的协议</p></li></ol><table><thead><tr><th align="left">分类</th><th align="left">方法</th><th align="center">操作符 &#x2F; 函数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">数值运算符</td><td align="left"><code>__add__</code></td><td align="center">+</td><td align="left">加</td></tr></tbody></table><pre><code>      | `__sub__`           | -             | 减      | `__mul__`           | *             | 乘      | `__div__`           | /             | 除      | `__floordiv__`      | //            | 整除      | `__truediv__`       | /             | 真除法，当 `__future__.division` 起作用时调用，否则调用 `__div__`      | `__pow__`           | **            | 幂运算      | `__mod__`           | %             | 模运算      | `__divmod__`        | divmod()      | 余、除</code></pre><p>位运算符   | <code>__lshift__</code>        | &lt;&lt;            | 向左移位<br>          | <code>__rshift__</code>        | &gt;&gt;            | 向右移位<br>          | <code>__and__</code>           | &amp;             | 与<br>          | <code>__or__</code>            | or 那个符号    | 或<br>          | <code>__xor__</code>           | ^             | 异或<br>          | <code>__invert__</code>        | ~             | 非<br>运算赋值符 | <code>__iadd__</code>          | +&#x3D;            |<br>          | <code>__isub__</code>          | -&#x3D;            |<br>          | <code>__imul__</code>          | *&#x3D;            |<br>          | <code>__idiv__</code>          | &#x2F;&#x3D;            |<br>          | <code>__ifloordiv__</code>     | &#x2F;&#x2F;&#x3D;           |<br>          | <code>__itruediv__</code>      | &#x2F;&#x3D;            |<br>          | <code>__ipow__</code>          | **&#x3D;           |<br>          | <code>__imod__</code>          | %&#x3D;            |<br>          | <code>__ilshift__</code>       | &lt;&lt;&#x3D;           |<br>          | <code>__irshift__</code>       | &gt;&gt;&#x3D;           |<br>          | <code>__iand__</code>          | &amp;&#x3D;            |<br>          | <code>__ior__</code>           | |&#x3D;           |<br>          | <code>__ixor__</code>          | ^&#x3D;            |<br>其他       | <code>__pos__</code>           | +             | 正<br>          | <code>__neg__</code>           | -             | 负<br>          | <code>__abs__</code>           | abs()         | 绝对值</p><ol start="3"><li><p>容器类型协议。<br><code>__len__()</code> 支持内置函数 len()<br><code>__getitem__()</code>、<code>__setitem__()</code>、<code>__delitem__()</code> 对应读、写、删除<br><code>__iter__()</code> 对应迭代器<br><code>__reversed__()</code> 支持内置函数 reversed()<br><code>__contains__()</code> 支持使用 in 和 not in 运算符</p></li><li><p>可调用对象协议 <code>__call__()</code></p></li><li><p>与可调用对象差不多的，还有一个可哈希对象，他是用过 <code>__hash__()</code> 方法来支持 hash() 这个内置函数的</p></li><li><p>描述符协议和属性交互协议（<code>__getattr__()</code>、<code>__setattr__()</code>、<code>__delattr__()</code>）</p></li><li><p>上下文管理器协议<br>这个协议通过 <code>__enter__()</code> 和 <code>__exit__()</code> 这两个方法来实现对资源的清理。</p></li></ol></div><div class="story post-story"><h2 id="建议-64：利用操作符重载实现中缀语法"><a href="#建议-64：利用操作符重载实现中缀语法" class="headerlink" title="建议 64：利用操作符重载实现中缀语法"></a>建议 64：利用操作符重载实现中缀语法</h2><p>可以安装 pipe 来实现 <code>pip install pipe</code></p></div><div class="story post-story"><h2 id="建议-65：熟悉-Python-的迭代器协议"><a href="#建议-65：熟悉-Python-的迭代器协议" class="headerlink" title="建议 65：熟悉 Python 的迭代器协议"></a>建议 65：熟悉 Python 的迭代器协议</h2><p>迭代器协议归纳：</p><ol><li>实现 <code>__iter__()</code> 方法，返回一个迭代器</li><li>实现 next() 方法，返回当前的元素，并指向下一个元素的为止，如果当前为止已无元素，则抛出 StopIteration 异常</li></ol></div><div class="story post-story"><h2 id="建议-66：熟悉-Python-的生成器"><a href="#建议-66：熟悉-Python-的生成器" class="headerlink" title="建议 66：熟悉 Python 的生成器"></a>建议 66：熟悉 Python 的生成器</h2><p>如果一个函数使用了 yield 语句，那么它就是一个生成器函数。<br>每一个生成器函数调用之后，它的函数体并不执行，而是到第一次调用 next() 的时候才开始执行，执行到 yield 表达式为止。</p></div><div class="story post-story"><h2 id="建议-67：基于生成器的协程及-greenlet"><a href="#建议-67：基于生成器的协程及-greenlet" class="headerlink" title="建议 67：基于生成器的协程及 greenlet"></a>建议 67：基于生成器的协程及 greenlet</h2><h2 id="建议-68：理解-GIL-的局限性"><a href="#建议-68：理解-GIL-的局限性" class="headerlink" title="建议 68：理解 GIL 的局限性"></a>建议 68：理解 GIL 的局限性</h2><p>针对这种，不建议高密集的计算使用多线程，建议堵塞I&#x2F;O的使用..</p></div><div class="story post-story"><h2 id="建议-69：对象的管理与垃圾回收"><a href="#建议-69：对象的管理与垃圾回收" class="headerlink" title="建议 69：对象的管理与垃圾回收"></a>建议 69：对象的管理与垃圾回收</h2><p>Python 使用引用计数器的方法来管理内存中的对象，即针对每一个对象维护一个引用计数值来表示该对象当前有多少个引用。<br>引用计数算法最明显的缺点是无法解决循环引用的问题，即两个对象相互引用。</p><p>我们可以使用自带的 gc 模块来跟踪对象的 “入引用” 和 “出引用”。</p></div><div class="story post-story"><h2 id="建议-70：从-PyPi-安装包"><a href="#建议-70：从-PyPi-安装包" class="headerlink" title="建议 70：从 PyPi 安装包"></a>建议 70：从 PyPi 安装包</h2><p>PyPi 全称 Python Package Index，直译过来就是 Python包索引，它是Python编程语言的软件仓库。</p></div><div class="story post-story"><h2 id="建议-71：使用-pip-和-yolk-安装、管理包"><a href="#建议-71：使用-pip-和-yolk-安装、管理包" class="headerlink" title="建议 71：使用 pip 和 yolk 安装、管理包"></a>建议 71：使用 pip 和 yolk 安装、管理包</h2><h2 id="建议-72：做-paster-创建包"><a href="#建议-72：做-paster-创建包" class="headerlink" title="建议 72：做 paster 创建包"></a>建议 72：做 paster 创建包</h2><h2 id="建议-73：理解单元测试概念"><a href="#建议-73：理解单元测试概念" class="headerlink" title="建议 73：理解单元测试概念"></a>建议 73：理解单元测试概念</h2><p>单元测试带来以下好处：</p><ul><li>减少了潜在 bug，提高了代码的质量。</li><li>大大缩减软件修复的成本。</li><li>为集成测试提供基本保障</li></ul><p>有效的单元测试应该从以下几个方面考虑：</p><ol><li>测试先行，遵循单元测试步骤。</li></ol><ul><li>创建测试计划</li><li>编写测试用例，准备测试数据</li><li>编写测试脚本</li><li>边界被测试代码，在代码完成之后执行测试脚本</li><li>修正代码缺陷，重新测试直到代码可接受为止。</li></ul><ol start="2"><li>遵循单元测试基本原则</li></ol><ul><li>一致性</li><li>原子性</li><li>单一职责</li><li>隔离性</li></ul><ol start="3"><li>使用单元测试框架 unittest。<br>unittest 相关的概念主要有以下四个：</li></ol><ul><li>测试固件。测试相关的准备工作和清理工作，基于类 TestCase 差个内奸测试固件的时候通常需要重新实现 setUp() 和 tearDown() 方法。</li><li>测试用例。最小的测试单元，通常基于 TestCase 构建</li><li>测试用例集，测试用例的集合，使用 TestSuite 类来实现</li><li>测试运行器，控制和驱动整个单元测试过程，一般使用 TestRunner 类作为测试用例的基本执行环境，常用的运行器为 TextTestRunner，它是 TestRunner 的子类，以文字方式运行测试并报告结果。</li></ul></div><div class="story post-story"><h2 id="建议-74：为包编写单元测试-nose"><a href="#建议-74：为包编写单元测试-nose" class="headerlink" title="建议 74：为包编写单元测试 nose"></a>建议 74：为包编写单元测试 nose</h2><h2 id="建议-75：利用测试驱动开发提高代码的可测性"><a href="#建议-75：利用测试驱动开发提高代码的可测性" class="headerlink" title="建议 75：利用测试驱动开发提高代码的可测性"></a>建议 75：利用测试驱动开发提高代码的可测性</h2><p>测试驱动开发流程：</p><ol><li>编写部分测试用例，并运行测试</li><li>如果测试用过，则回到测试用例编写的步骤，继续添加新的测试用例</li><li>如果测试失败，则修改代码直到测试通过</li><li>当所有测试用例编写完成并通过测试之后，再来考虑对代码进行重构</li></ol><p>关于测试驱动开发和提高代码可测性方面有几点说明：</p><ul><li>TDD 只是手段而不是目的，因此在实践中尽量只验证正确的事情，并且每次仅仅验证一件事儿。</li><li>测试驱动开发本身就是一门学问，不要指望通过一个简单的例子就掌握其精髓。</li><li>代码的不可测性可以从以下几个方面考量：<br>实践 TDD 困难；外部依赖太多；<br>需要写很多模拟代码才能完成测试；<br>职责太多导致功能模糊；<br>内部状态过多且没有办法去操作和维护这些状态；<br>函数没有明显返回或者参数过多；<br>低内聚高耦合等等</li></ul></div><div class="story post-story"><h2 id="建议-76：使用-Pylint-检查代码风格"><a href="#建议-76：使用-Pylint-检查代码风格" class="headerlink" title="建议 76：使用 Pylint 检查代码风格"></a>建议 76：使用 Pylint 检查代码风格</h2><p>我使用 PyChrame 貌似内置..严格遵循 PEP8 标准</p></div><div class="story post-story"><h2 id="建议-77：进行高效的代码审查"><a href="#建议-77：进行高效的代码审查" class="headerlink" title="建议 77：进行高效的代码审查"></a>建议 77：进行高效的代码审查</h2><h2 id="建议-78：将包发布到-PyPI"><a href="#建议-78：将包发布到-PyPI" class="headerlink" title="建议 78：将包发布到 PyPI"></a>建议 78：将包发布到 PyPI</h2><h2 id="建议-79：了解代码优化的基本原则"><a href="#建议-79：了解代码优化的基本原则" class="headerlink" title="建议 79：了解代码优化的基本原则"></a>建议 79：了解代码优化的基本原则</h2><ol><li>优先保证代码是可工作的</li><li>权衡优化的代价</li><li>定义性能指标，集中力量解决首要问题</li><li>不要忽略可读性</li></ol></div><div class="story post-story"><h2 id="建议-80：借助性能优化工具"><a href="#建议-80：借助性能优化工具" class="headerlink" title="建议 80：借助性能优化工具"></a>建议 80：借助性能优化工具</h2><p>例如 Pypy</p></div><div class="story post-story"><h2 id="建议-81：利用-cProfile-定位性能瓶颈"><a href="#建议-81：利用-cProfile-定位性能瓶颈" class="headerlink" title="建议 81：利用 cProfile 定位性能瓶颈"></a>建议 81：利用 cProfile 定位性能瓶颈</h2><p>cProfile 的统计结果及其各项意义</p><table><thead><tr><th align="left">统计项</th><th align="left">意义</th></tr></thead><tbody><tr><td align="left">ncalls</td><td align="left">函数的被调用次数</td></tr><tr><td align="left">tottime</td><td align="left">函数总计运行时间，不含调用的函数运行时间</td></tr><tr><td align="left">percall</td><td align="left">函数运行一次的平均时间，等于 tottime&#x2F;ncalls</td></tr><tr><td align="left">cumtime</td><td align="left">函数总计运行时间，含调用的函数运行时间</td></tr><tr><td align="left">percall</td><td align="left">函数一次运行的平均时间，等于 cumtime&#x2F;ncalls</td></tr><tr><td align="left">filename:lineno(function)</td><td align="left">函数所在的文件名、函数行号、函数名</td></tr></tbody></table><p>Stats 提供了对 cProfile 输出结果进行排序、输出控制等功能。</p><p>Stats 函数以及对应作用</p><table><thead><tr><th align="left">函数</th><th align="left">函数的作用</th></tr></thead><tbody><tr><td align="left">strip_dirs()</td><td align="left">用以除去文件名前面的路径信息</td></tr><tr><td align="left">add(filename[,...])</td><td align="left">把 profile 的输出文件加入 Stats 实例中统计</td></tr><tr><td align="left">dump_stats(filename)</td><td align="left">把 Stats 的统计结果保存到文件</td></tr><tr><td align="left">sort_stats(key[,...])</td><td align="left">用以排序 Profile 的输出</td></tr><tr><td align="left">reverse_order()</td><td align="left">把 Stats 实例里的数据反序重排</td></tr><tr><td align="left">print_stats([restriction, ...])</td><td align="left">把 Stats 报表输出到 stdout</td></tr><tr><td align="left">print_callers([restriction, ...])</td><td align="left">输出调用了指定的函数的相关信息</td></tr><tr><td align="left">print_callees([restriction, ...])</td><td align="left">输出指定的函数调用过的函数的相关信息</td></tr></tbody></table><p>sort_stats 可接受参数列表</p><table><thead><tr><th align="left">参数</th><th align="left">意义</th></tr></thead><tbody><tr><td align="left">ncalls</td><td align="left">被调用次数</td></tr><tr><td align="left">cumulative</td><td align="left">函数运行的总时间</td></tr><tr><td align="left">file</td><td align="left">文件名</td></tr><tr><td align="left">module</td><td align="left">模块名</td></tr><tr><td align="left">pcalls</td><td align="left">简单的调用统计</td></tr><tr><td align="left">line</td><td align="left">行号</td></tr><tr><td align="left">name</td><td align="left">函数名</td></tr><tr><td align="left">nfl</td><td align="left">Name、file、line</td></tr><tr><td align="left">stdname</td><td align="left">标准函数名</td></tr><tr><td align="left">time</td><td align="left">函数内部运行时间，不计调用子函数的时间</td></tr></tbody></table></div><div class="story post-story"><h2 id="建议-82：使用-memory-profiler-和-objgraph-剖析内存使用"><a href="#建议-82：使用-memory-profiler-和-objgraph-剖析内存使用" class="headerlink" title="建议 82：使用 memory_profiler 和 objgraph 剖析内存使用"></a>建议 82：使用 memory_profiler 和 objgraph 剖析内存使用</h2><h2 id="建议-83：努力降低算法复杂度"><a href="#建议-83：努力降低算法复杂度" class="headerlink" title="建议 83：努力降低算法复杂度"></a>建议 83：努力降低算法复杂度</h2><p>常见数据结构基本操作的时间复杂度</p><table><thead><tr><th align="left">数据结构</th><th align="left">操作</th><th align="left">平均时间复杂度</th><th align="left">最差时间复杂度</th></tr></thead><tbody><tr><td align="left">list</td><td align="left">复制</td><td align="left">O(<em>n</em>)</td><td align="left">O(<em>n</em>)</td></tr></tbody></table><pre><code>                | 追加、取元素的值，给某个元素赋值  | O(_1_)        | O(_1_)                | 插入、删除某个元素，迭代操作      | O(_n_)        | O(_n_)                | 切片操作                        | O(_k_)        | O(_k_)</code></pre><p>set                 | x in s                         | O(<em>1</em>)        | O(<em>n</em>)<br>                    | 并 s or t                      | O(len(<em>s</em>)+len(<em>t</em>)) |<br>                    | 交 s&amp;t                         | O(min(len(<em>s</em>), len(<em>t</em>))) | O(len(<em>s</em>) * len(<em>t</em>))<br>                    | 差 s-t                         | O(len(<em>s</em>))   |<br>dict                | 获取修改元素的值，删除           | O(<em>1</em>)        | O(<em>n</em>)<br>                    | 迭代操作                        | O(<em>n</em>)        | O(<em>n</em>)<br>collections.deque   | 入列、出列、（包括左边出入列）    | O(<em>1</em>)        | O(<em>n</em>)<br>                    | 扩大队列                        | O(<em>k</em>)        | O(<em>k</em>)<br>                    | 删除元素                        | O(<em>n</em>)        | O(<em>n</em>)</p></div><div class="story post-story"><h2 id="建议-84：掌握循环优化的基本技巧"><a href="#建议-84：掌握循环优化的基本技巧" class="headerlink" title="建议 84：掌握循环优化的基本技巧"></a>建议 84：掌握循环优化的基本技巧</h2><ol><li>减少循环内部的计算</li><li>将显式循环改为隐式循环</li><li>在循环中尽量引用局部变量</li><li>关注内层嵌套循环</li></ol></div><div class="story post-story"><h2 id="建议-85：使用生成器提高效率"><a href="#建议-85：使用生成器提高效率" class="headerlink" title="建议 85：使用生成器提高效率"></a>建议 85：使用生成器提高效率</h2><p>生成器的优点有如下几条：</p><ul><li>生成器提供了一种更为便利的产生迭代器的方式，用户一般不需要自己实现 <code>__iter__</code> 和 <code>next</code> 方法，它默认返回一个迭代器</li><li>代码更为简洁、优雅</li><li>充分利用了延迟评估的特性，仅在需要的时候才产生对应的元素，而不是一次生成所有的元素，从而节省了内存空间，提高效率</li><li>使得协程更为容易实现。（Python3.5 中引入了 async 和 wait 关键字）</li></ul></div><div class="story post-story"><h2 id="建议-86：使用不同的数据结构优化性能"><a href="#建议-86：使用不同的数据结构优化性能" class="headerlink" title="建议 86：使用不同的数据结构优化性能"></a>建议 86：使用不同的数据结构优化性能</h2><h2 id="建议-87：充分利用-set-的优势"><a href="#建议-87：充分利用-set-的优势" class="headerlink" title="建议 87：充分利用 set 的优势"></a>建议 87：充分利用 set 的优势</h2><h2 id="建议-88：使用-multiprocessing-克服-GIL-的缺陷"><a href="#建议-88：使用-multiprocessing-克服-GIL-的缺陷" class="headerlink" title="建议 88：使用 multiprocessing 克服 GIL 的缺陷"></a>建议 88：使用 multiprocessing 克服 GIL 的缺陷</h2><p>Multiprocessing 模块在使用上需要注意以下几个要点：</p><ol><li>进程之间的通信优先考虑 Pipe 和 Queue，而不是 Lock、Event、Condition、Semaphore 等同步原语</li><li>尽量避免资源共享。如果不可避免，可以通过 multiprocessing.Value 和 multiprocessing.Array 或者 multiprocessing.sharedctype 来实现内存共享。<br>也可以通过服务器进程管理器 Manager() 来实现数据和状态的共享。</li><li>注意平台之间的差异。</li><li>尽量避免使用 terminate() 方式终止进程，并且确保 pool.map 中传入的参数是可以序列化的</li></ol></div><div class="story post-story"><h2 id="建议-89：使用线程池提高效率"><a href="#建议-89：使用线程池提高效率" class="headerlink" title="建议 89：使用线程池提高效率"></a>建议 89：使用线程池提高效率</h2><h2 id="建议-90：使用-C-x2F-C-模块扩展提高性能"><a href="#建议-90：使用-C-x2F-C-模块扩展提高性能" class="headerlink" title="建议 90：使用 C&#x2F;C++ 模块扩展提高性能"></a>建议 90：使用 C&#x2F;C++ 模块扩展提高性能</h2><h2 id="建议-91：使用-Cython-编写扩展模块"><a href="#建议-91：使用-Cython-编写扩展模块" class="headerlink" title="建议 91：使用 Cython 编写扩展模块"></a>建议 91：使用 Cython 编写扩展模块</h2></div>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;《编写高质量代码：改善-Python-程序的-91-个建议》-学习笔记&quot;&gt;&lt;a href=&quot;#《编写高质量代码：改善-Python-程序的-91-个建议》-学习笔记&quot; class=&quot;headerlink&quot; title=&quot;《编写高质量代码：改善 Python 程序的 91 个建议》 学习笔记&quot;&gt;&lt;/a&gt;《编写高质量代码：改善 Python 程序的 91 个建议》 学习笔记&lt;/h1&gt;&lt;p&gt;之前自己学了很多次 Python，由于用不到，所以总是学完就忘掉了。&lt;br&gt;刚好最近工作需要用到 Python，就借此机会好好学习了一番。&lt;br&gt;Pyhton 的各种特性和风格让我甚是喜欢。不过我总是感觉自己写的代码不是那么漂亮，不够 Pythonic。&lt;br&gt;所以我想通过学习一些经典建议来让我有个思路。&lt;/p&gt;</summary>
    
    
    
    <category term="Language" scheme="https://mirokaku.github.io/categories/language/"/>
    
    
    <category term="Python" scheme="https://mirokaku.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>ArchLinux 安装笔记</title>
    <link href="https://mirokaku.github.io/ArchLinux-install-notes/"/>
    <id>https://mirokaku.github.io/ArchLinux-install-notes/</id>
    <published>2016-07-17T16:01:18.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前提说明"><a href="#前提说明" class="headerlink" title="前提说明"></a>前提说明</h1><p>建议优先选择官方文档为参考，内容随时更新且非常详细。这里记录是包含一些自己遇到的坑。且只针对自己安装需求的情况。</p><h1 id="引用参考"><a href="#引用参考" class="headerlink" title="引用参考"></a>引用参考</h1><blockquote><p><a href="https://wiki.archlinux.org/index.php/Beginners%27_guide_%28%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%29" target="_blank" rel="noopener external nofollow noreferrer">Beginners&#39;guide (简体中文)</a><br><a href="https://wiki.archlinux.org/index.php/Installation_guide_%28%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%29" target="_blank" rel="noopener external nofollow noreferrer">Installation guide (简体中文)</a><br><a href="https://bigeagle.me/2014/06/archlinux-install-for-beginners/" target="_blank" rel="noopener external nofollow noreferrer">给妹子看的 Arch Linux 桌面日常安装</a><br><a href="https://blog.ikke.moe/posts/archlinux-installation-notes/" target="_blank" rel="noopener external nofollow noreferrer">ArchLinux 安装笔记</a><br><a href="http://blog.csdn.net/u011152627/article/details/18925121" target="_blank" rel="noopener external nofollow noreferrer">寒假折腾Archlinux的一些经验（新手向）--桌面配置篇</a><br><a href="http://blog.csdn.net/u011152627/article/details/38145125" target="_blank" rel="noopener external nofollow noreferrer">ArchLinux使用中常见问题集锦</a></p></blockquote><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>机器: DELL<br>BOOT: UEFI<br>SSD: 256G<br>内存: 8G<br>CPU: i7-6500U<br>安装需求：本机安装单系统<br>ArchLinux: Release 2016.06.01</p><span id="more"></span><h1 id="LiveUSB"><a href="#LiveUSB" class="headerlink" title="LiveUSB"></a>LiveUSB</h1><p>参考 <a href="https://wiki.archlinux.org/index.php/USB_flash_installation_media_%28%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%29" target="_blank" rel="noopener external nofollow noreferrer">USB flash installation media (简体中文)</a><br>推荐使用里面的手动方法，这样制作的LiveUSB可以使用剩余空间来存储其他东西。</p><h1 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h1><p>镜像中不包含软件包，安装的软件是通过服务器上的源下载，所以安装的时候必须要有网络连接。</p><ul><li>联网<br>有线：</li></ul><ol><li>用<code>ip addr</code> 查看网卡接口型号，比如 enp2s0</li><li>启用网卡DHCP功能，<code>systemctl enable dhcpcd@enp2s0.service</code><br>无线：</li><li><code>wifi-menu</code></li><li>选择自己的 wifi 并输入密码连接网络</li></ol><p>最后 <code>ping</code> 一下，确认网络无误</p><ul><li><p>更新系统时间<br><code>timedatectl set-ntp true</code></p></li><li><p>准备磁盘</p></li></ul><ol><li>lsblk 查看自己的硬盘所在，比如我的就是 &#x2F;dev&#x2F;sda</li><li>使用parted 分区<br>注意：我是要全盘安装的，所以重新建立分区表了。<br>a. <code>parted /dev/sda</code><br>b. <code>(parted) mktable gpt</code> 重建 GPT 分区表<br>c. <code>(parted) mkpart ESP fat32 1M 513M</code> 分配 ESP 分区，前1M是分区表，ESP大小为512M<br>d. <code>(parted) set 1 boot on</code> 设置为ESP分区<br>e. <code>(parted) mkpart primary linux-swap 513M 8705M</code> 分配swap分区，这里使用了与我内存同样大小的8G<br>f. <code>(parted) mkpart primary ext4 8705M 100%</code> 分配root分区，使用剩余所有空间</li><li>格式化分区<br>a. <code>mkfs.vfat –F32 /dev/sda1</code> ESP分区需要格式化成fat32，否则无法启动<br>b. <code>mkswap /dev/sda2 &amp; swapon /dev/sda2</code> 格式化交换分区，并设置<br>c. <code>mkfs.ext4 –b 4096 /dev/sda3</code> 格式化root分区，并4K对齐</li><li>挂载分区<br>a. <code>mount –t ext4 –o discard,noatime /dev/sda3 /mnt</code><br>b. <code>mkdir –p /mnt/boot/EFI</code><br>c. <code>mount /dev/sda1 /mnt/boot/EFI</code></li></ol><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ul><li><p>配置安装源<br>默认镜像是美国的，在中国速度慢，所以全改中国了..<br><code>sed -i &#39;/Score/&#123;/China/!&#123;n;s/^/#/&#125;&#125;&#39; /etc/pacman.d/mirrorlist</code></p></li><li><p>安装基本系统<br>安装之前先确认是否连网<br><code>pacstrap /mnt base base-devel vim</code></p></li><li><p>生成 fstab<br><code>genfstab –U –p /mnt &gt;&gt; /mnt/etc/fstab</code></p></li><li><p>chroot<br><code>arch-chroot /mnt /bin/bash</code></p></li><li><p>Locale<br><code>vim /etc/locale.gen</code><br>取消下面这些注释<br>en_US.UTF-8 UTF-8<br>zh_CN.UTF-8 UTF-8<br>zh_TW.UTF-8 UTF-8</p></li></ul><p>生成locale信息<br><code>locale-gen</code><br><code>echo LANG=en_US.UTF-8 &gt; /etc/locale.conf</code></p><ul><li>时间<br>选择时区（Shanghai）<br><code>tzselect</code></li></ul><p>将 <code>/etc/localtime</code> 软连接到 <code>/usr/share/zoneinfo/Zone/SubZone</code><br><code>ln –s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code></p><p>设置时间标准为 UTC 并调整时间偏移<br><code>hwclock –systohc –utc</code></p><ul><li><p>创建初始 ramdisk 环境<br><code>mkinitcpio –p linux</code></p></li><li><p>设置 root 密码<br><code>passwd</code></p></li><li><p>安装 grub<br>先df命令确认一下有木有挂载ESP分区<br>应该是这样的...</p></li></ul><table><thead><tr><th align="left">File system</th><th align="left">Mounted On</th></tr></thead><tbody><tr><td align="left">&#x2F;dev&#x2F;sda3</td><td align="left">&#x2F;</td></tr><tr><td align="left">&#x2F;dev&#x2F;sda1</td><td align="left">&#x2F;boot&#x2F;EFI</td></tr><tr><td align="left">...</td><td align="left">...</td></tr></tbody></table><p><code>pacman –S grub efibootmgr</code><br><code>grub-install –target=x86_64-efi –efi-directory=/boot/EFI –bootloader-id=arch_grub –recheck</code><br><code>grub-mkconfig –o /boot/grub/grub.cfg</code><br>**注意:**有些BIOS需要自己设置EFI文件位置才能找到efi文件。比如我的DELL</p><ul><li>配置网络<br><code>echo myhostname &gt; /etc/hostname</code><br>并在 &#x2F;etc&#x2F;hosts 添加同样主机名<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;ip-address&gt;    &lt;hostname.domain.org&gt;        &lt;hostname&gt;</span></span><br><span class="line">127.0.0.1        localhost.localdomain        localhost        myhostname</span><br><span class="line">::1              localhost.localdomain        localhost        myhostname</span><br></pre></td></tr></table></figure>有线网络<br>Interface 是您的网络接口名，见连网<br><code>systemctl enable dhcpcd@interface.service</code></li></ul><p>无线网络<br><code>pacman –S iw wpa_supplicant dialog</code></p><ul><li>卸载分区并重启系统<br><code>exit</code><br><code>umount -R /mnt</code><br><code>reboot</code></li></ul><h1 id="折腾新大陆"><a href="#折腾新大陆" class="headerlink" title="折腾新大陆"></a>折腾新大陆</h1><p>重启之后就阔以以root进入到archlinux系统了，首先我们要进行<a href="#%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87">联网</a>。</p><ul><li><p>添加用户<br><code>useradd –m –g users –G wheel –s /bin/bash username</code><br><code>passwd username</code></p></li><li><p>sudo<br><code>pacman –S sudo</code><br><code>vim /etc/sudoers</code><br>找到 root ALL&#x3D;(ALL) ALL<br>照着这个，在下面添加一个 username ALL&#x3D;(ALL) ALL</p></li><li><p>安装 yaourt<br><code>vim /etc/pacman.conf</code><br>加入下面的内容:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[archlinuxcn]</span><br><span class="line"><span class="comment"># The Chinese Arch Linux communities packages.</span></span><br><span class="line">SigLevel = Optional TrustAll</span><br><span class="line">Server = http://mirrors.163.com/archlinux-cn/<span class="variable">$arch</span></span><br></pre></td></tr></table></figure><p>更新并安装yaourt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman –Syu</span><br><span class="line">pacman –S yaourt</span><br><span class="line">pacman –S archlinuxcn-keyring</span><br></pre></td></tr></table></figure></li><li><p>安装 SSH、GIT、wget<br><code>pacman –S git openssh wget</code></p></li><li><p>安装 zsh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman –S zsh</span><br><span class="line">chsh /bin/zsh</span><br><span class="line">sh –c “$(curl –fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)”</span><br></pre></td></tr></table></figure></li><li><p>安装 screenfetch<br><code>pacman –S screenfetch</code></p></li><li><p>NTFS 读写<br><code>pacman –S ntfs-3g</code></p></li><li><p>安装解压缩软件<br><code>pacman –S file-roller unrar unzip p7zip</code></p></li><li><p>Shadowsocks-qt5<br><code>pacman –S shadowsocks-qt5</code></p></li><li><p>ProxyChains<br><code>pacman –S proxychains</code></p></li><li><p>RP-PPPOE<br>拨号的，按需安装<br><code>pacman –S rp-pppoe</code><br><code>nm-connection-editor</code></p></li><li><p>安装 xorg 桌面管理器<br><code>pacman –S xorg-xinit xorg-server xorg-twm xterm</code></p></li><li><p>安装 gnome 桌面环境<br>按需，个人安装的gnome，觉得新版3.20挺好看的<br><code>pacman –S gnome</code><br><code>pacman –S gnome-tweak-tool</code></p></li><li><p>VPN 扩展</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman –S networkmanager-pptp</span><br><span class="line">yaourt networkmanager-l2tp</span><br><span class="line">systemctl restart NetworkManager</span><br></pre></td></tr></table></figure></li><li><p>启动服务<br>显示管理器gnome默认是用的GDM<br><code>systemctl enable gdm.service</code></p></li></ul><p>网络管理<br><code>systemctl enable NetworkManager.service</code></p><p>更新<br><code>pacman –Syu</code></p><ul><li><p>安装 chromium<br><code>pacman –S chromium</code></p></li><li><p>安装输入法<br>依赖<br><code>pacman –S fcitx-im fcitx-configtool fcitx-gtk3 fcitx-gtk2 fcitx-qt4 fcitx-qt5</code></p></li></ul><p>自行选择安装的拼音，我选择的sun<br><code>pacman –S sunpinyin</code></p><p>配置.xprofile文件<br><code>vim ~/.xprofile</code></p><p>添加如下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LC_CTYPE=zh_CN.UTF-8</span><br><span class="line"><span class="built_in">export</span> XIM=fcitx</span><br><span class="line"><span class="built_in">export</span> XIM_PROGRAM=fcitx</span><br><span class="line"><span class="built_in">export</span> GTK_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">&quot;@im=fcitx&quot;</span></span><br><span class="line"><span class="built_in">eval</span> `dbus-launch --sh-syntax --exit-with-session`</span><br><span class="line"><span class="built_in">exec</span> fcitx &amp;</span><br></pre></td></tr></table></figure><p>注意，即使这样，你会发现还是调用不出输入法…<br>等下重启之后告诉你如何解决~</p><ul><li><p>安装网易云音乐<br><code>pacman –S netease-cloud-music</code></p></li><li><p>重启<br><code>reboot</code></p></li></ul><h1 id="来到新的世界"><a href="#来到新的世界" class="headerlink" title="来到新的世界"></a>来到新的世界</h1><p>重启你会发现有了界面~</p><ul><li><p>配置输入法<br>前面说即使安装完那些东西也调不出来，是有个地方需要配置一下<br>左下角可以有个后台程序栏。右键输入法，选择配置。发现输入法里面并没有拼音，我们添加进安装的 sunpinyin 就好了。<br>注意:切换输入法与 gnome 显示的不一致。<br>默认切换输入法是 <code>ctrl+space</code></p></li><li><p>中文化<br>安装中文字体，推荐<a href="https://github.com/adobe-fonts/source-han-sans" target="_blank" rel="noopener external nofollow noreferrer">思源黑体</a>，安装方法见 Github 上的安装过程。<br>安装等宽字体，推荐 <a href="https://github.com/adobe-fonts/source-code-pro/" target="_blank" rel="noopener external nofollow noreferrer">Source Code Pro</a><br>打开 Gnome Tweak Tool，切换到字体栏，<br>将窗口、界面、文档的字体改为 Source Han Sans Normal<br>将等宽字体设置为 Source Code Pro</p></li><li><p>VMWare<br>我这里环境：<br>VMWare: VMware-Workstation-Full-12.1.1-3770994.x86_64.bundle<br>Linux: Linux 4.6.2-1-ARCH</p></li></ul><p>首先从VMWare官网下载个 VMWare二进制包<br>安装部分详见 VMware_(简体中文)</p><p>安装依赖<br><code>mkdir /etc/init.d</code></p><p>添加VMWare服务配置文件<br><code>yaourt vmware-systemd-services</code><br><code>systemctl enable vmware.service</code><br><code>systemctl start vmware.service</code></p><p>有一个地方我要说明一下。<br>在启动提示有个服务跟新的时候，更新会失败，导致不能启动VMWare<br>注意：下面的方法不一定在你的版本适用，请注意备份。<br>解决方法是：</p><ol><li>进入 <code>/usr/lib/vmware/modules/source</code></li><li>解包 <code>vmnet.tar vmmon.tar</code></li><li><code>Replace function &quot;get_user_pages()&quot; with &quot;get_user_pages_remote()&quot; in vmmon-only/linux/hostif.c and vmnet-only/userif.c files.</code></li><li>重新打包回去</li></ol><p>具体如下：<br><code>cd /usr/lib/vmware/modules/source</code></p><p>解包<br><code>sudo tar –xvf vmnet.tar</code><br><code>sudo tar –xvf vmmon.tar</code></p><p>把下面两个文件里面的 <code>get_user_pages</code> 函数替换成 <code>get_user_pages_remote</code><br><code>sudo vim vmnet-only/driver.c</code><br><code>sudo vim vmmon-only/linux/hostif.c</code></p><p>打包<br><code>sudo tar -uvf vmnet.tar vmnet-only</code><br><code>sudo tar -uvf vmmon.tar vmmon-only</code></p><p>然后删除那解包的文件夹<br><code>sudo rm -r vmnet-only</code><br><code>sudo rm -r vmmon-only</code></p><h1 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h1>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前提说明&quot;&gt;&lt;a href=&quot;#前提说明&quot; class=&quot;headerlink&quot; title=&quot;前提说明&quot;&gt;&lt;/a&gt;前提说明&lt;/h1&gt;&lt;p&gt;建议优先选择官方文档为参考，内容随时更新且非常详细。这里记录是包含一些自己遇到的坑。且只针对自己安装需求的情况。&lt;/p&gt;
&lt;h1 id=&quot;引用参考&quot;&gt;&lt;a href=&quot;#引用参考&quot; class=&quot;headerlink&quot; title=&quot;引用参考&quot;&gt;&lt;/a&gt;引用参考&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://wiki.archlinux.org/index.php/Beginners%27_guide_%28%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%29&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;Beginners&amp;#39;guide (简体中文)&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://wiki.archlinux.org/index.php/Installation_guide_%28%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%29&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;Installation guide (简体中文)&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://bigeagle.me/2014/06/archlinux-install-for-beginners/&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;给妹子看的 Arch Linux 桌面日常安装&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.ikke.moe/posts/archlinux-installation-notes/&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;ArchLinux 安装笔记&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://blog.csdn.net/u011152627/article/details/18925121&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;寒假折腾Archlinux的一些经验（新手向）--桌面配置篇&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://blog.csdn.net/u011152627/article/details/38145125&quot; target=&quot;_blank&quot; rel=&quot;noopener external nofollow noreferrer&quot;&gt;ArchLinux使用中常见问题集锦&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h1&gt;&lt;p&gt;机器: DELL&lt;br&gt;BOOT: UEFI&lt;br&gt;SSD: 256G&lt;br&gt;内存: 8G&lt;br&gt;CPU: i7-6500U&lt;br&gt;安装需求：本机安装单系统&lt;br&gt;ArchLinux: Release 2016.06.01&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://mirokaku.github.io/categories/linux/"/>
    
    
    <category term="ArchLinux" scheme="https://mirokaku.github.io/tags/archlinux/"/>
    
  </entry>
  
  <entry>
    <title>XP 兼容系列：C++11 的静态对象</title>
    <link href="https://mirokaku.github.io/XP-Compatible-cpp11/"/>
    <id>https://mirokaku.github.io/XP-Compatible-cpp11/</id>
    <published>2016-01-13T08:25:01.000Z</published>
    <updated>2022-07-11T02:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>文章可能有错误的地方，希望各位童鞋能够提出~</p></blockquote><p>事故缘由…<br>为了使用很爽的C++11 特性，我司最新项目是用的VS2015进行开发的。<br>但是同时又要对XP做兼容（讲真，我个人是不支持对Win7之前的系统做兼容的，我觉得影响发展）。</p><p>我们写了个COM组件作为插件，和驱动进行通讯。<br>在我们进行单元测试的时候，一切正常。但是出了测试安装包之后，发现加载插件会崩溃。<br>然后我们挂载了Windbg神器来定位崩溃点。<br>崩溃点是一个读取TLS，这个值为空 (外部静态对象才会有TLS)</p><span id="more"></span><p>想到单元测试程序也是通过VS2015编译的。我们就比较两个进程有啥不一样。<br>如图:<br><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/1-7c59c.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/1-7c59c.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/2-c7f79.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/2-c7f79.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们看一下 nt!_TEB 结构，发现 Tls Storage 就是 _TEB::ThreadLocalStoragePointer 字段。如图：<br><img src="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/3-4c219.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/MiroKaku/MyBlog.PictureHost/main/img/2022-07-08/XP-Compatible-cpp11/3-4c219.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>于是我们查了一下 ReactOS 0.3.15 看下这个字段到底是啥，找到了这个分配Tls的函数</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line">NTAPI</span><br><span class="line">LdrpAllocateTls(VOID)</span><br><span class="line">&#123;</span><br><span class="line">    PTEB Teb = NtCurrentTeb();</span><br><span class="line">    PLIST_ENTRY NextEntry, ListHead;</span><br><span class="line">    PLDRP_TLS_DATA TlsData;</span><br><span class="line">    SIZE_T TlsDataSize;</span><br><span class="line">    PVOID *TlsVector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we have any entries */</span></span><br><span class="line">    <span class="keyword">if</span> (!LdrpNumberOfTlsEntries)</span><br><span class="line">        return STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the vector array */</span></span><br><span class="line">    TlsVector = RtlAllocateHeap(RtlGetProcessHeap(),</span><br><span class="line">                                    <span class="number">0</span>,</span><br><span class="line">                                    LdrpNumberOfTlsEntries * sizeof(PVOID));</span><br><span class="line">    <span class="keyword">if</span> (!TlsVector) return STATUS_NO_MEMORY;</span><br><span class="line">    T<span class="function"><span class="title">eb</span>-&gt;</span>ThreadLocalStoragePointer = TlsVector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Loop the TLS Array */</span></span><br><span class="line">    ListHead = &amp;LdrpTlsList;</span><br><span class="line">    N<span class="function"><span class="title">extEntry</span> = ListHead-&gt;</span>Flink;</span><br><span class="line">    <span class="keyword">while</span> (NextEntry != ListHead)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Get the entry */</span></span><br><span class="line">        TlsData = CONTAINING_RECORD(NextEntry, LDRP_TLS_DATA, TlsLinks);</span><br><span class="line">        N<span class="function"><span class="title">extEntry</span> = NextEntry-&gt;</span>Flink;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Allocate this vector */</span></span><br><span class="line">        T<span class="function"><span class="title">lsDataSize</span> = TlsData-&gt;</span>TlsDirectory.EndAddressOfRawData -</span><br><span class="line">                      T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.StartAddressOfRawData;</span><br><span class="line">        T<span class="function"><span class="title">lsVector</span>[TlsData-&gt;</span>TlsDirectory.Characteristics] = RtlAllocateHeap(RtlGetProcessHeap(),</span><br><span class="line">                                                                           <span class="number">0</span>,</span><br><span class="line">                                                                           TlsDataSize);</span><br><span class="line">        <span class="function"><span class="title">if</span> (!TlsVector[TlsData-&gt;</span>TlsDirectory.Characteristics])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Out of memory */</span></span><br><span class="line">            return STATUS_NO_MEMORY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Show debug message */</span></span><br><span class="line">        <span class="keyword">if</span> (ShowSnaps)</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINT1(<span class="string">&quot;LDR: TlsVector %x Index %d = %x copied from %x to %x\n&quot;</span>,</span><br><span class="line">                    TlsVector,</span><br><span class="line">                    T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.Characteristics,</span><br><span class="line">                    &amp;T<span class="function"><span class="title">lsVector</span>[TlsData-&gt;</span>TlsDirectory.Characteristics],</span><br><span class="line">                    T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.StartAddressOfRawData,</span><br><span class="line">                    T<span class="function"><span class="title">lsVector</span>[TlsData-&gt;</span>TlsDirectory.Characteristics]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Copy the data */</span></span><br><span class="line">        R<span class="function"><span class="title">tlCopyMemory</span>(TlsVector[TlsData-&gt;</span>TlsDirectory.Characteristics],</span><br><span class="line">                      (PVOID)T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.StartAddressOfRawData,</span><br><span class="line">                      TlsDataSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Done */</span></span><br><span class="line">    return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是这个函数并不能得到太多有用信息。我们又看了下谁调用了它，得到了 LdrpInitializeTls 这个函数，从这个函数里面，我们就知道，实际上 _TEB::ThreadLocalStoragePointer 这个字段就是 初始化好的PE文件里面的 Tls 表。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line">NTAPI</span><br><span class="line">LdrpInitializeTls(VOID)</span><br><span class="line">&#123;</span><br><span class="line">    PLIST_ENTRY NextEntry, ListHead;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY LdrEntry;</span><br><span class="line">    PIMAGE_TLS_DIRECTORY TlsDirectory;</span><br><span class="line">    PLDRP_TLS_DATA TlsData;</span><br><span class="line">    ULONG Size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the TLS List */</span></span><br><span class="line">    InitializeListHead(&amp;LdrpTlsList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Loop all the modules */</span></span><br><span class="line">    L<span class="function"><span class="title">istHead</span> = &amp;NtCurrentPeb()-&gt;</span>L<span class="function"><span class="title">dr</span>-&gt;</span>InLoadOrderModuleList;</span><br><span class="line">    N<span class="function"><span class="title">extEntry</span> = ListHead-&gt;</span>Flink;</span><br><span class="line">    <span class="keyword">while</span> (ListHead != NextEntry)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Get the entry */</span></span><br><span class="line">        LdrEntry = CONTAINING_RECORD(NextEntry, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);</span><br><span class="line">        N<span class="function"><span class="title">extEntry</span> = NextEntry-&gt;</span>Flink;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get the TLS directory */</span></span><br><span class="line">        T<span class="function"><span class="title">lsDirectory</span> = RtlImageDirectoryEntryToData(LdrEntry-&gt;</span>DllBase,</span><br><span class="line">                                                    TRUE,</span><br><span class="line">                                                    IMAGE_DIRECTORY_ENTRY_TLS,</span><br><span class="line">                                                    &amp;Size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check if we have a directory */</span></span><br><span class="line">        <span class="keyword">if</span> (!TlsDirectory) continue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check if the image has TLS */</span></span><br><span class="line">        <span class="keyword">if</span> (!LdrpImageHasTls) LdrpImageHasTls = TRUE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Show debug message */</span></span><br><span class="line">        <span class="keyword">if</span> (ShowSnaps)</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINT1(<span class="string">&quot;LDR: Tls Found in %wZ at %p\n&quot;</span>,</span><br><span class="line">                    &amp;L<span class="function"><span class="title">drEntry</span>-&gt;</span>BaseDllName,</span><br><span class="line">                    TlsDirectory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Allocate an entry */</span></span><br><span class="line">        TlsData = RtlAllocateHeap(RtlGetProcessHeap(), <span class="number">0</span>, sizeof(LDRP_TLS_DATA));</span><br><span class="line">        <span class="keyword">if</span> (!TlsData) return STATUS_NO_MEMORY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Lock the DLL and mark it for TLS Usage */</span></span><br><span class="line">        L<span class="function"><span class="title">drEntry</span>-&gt;</span>LoadCount = -<span class="number">1</span>;</span><br><span class="line">        L<span class="function"><span class="title">drEntry</span>-&gt;</span>TlsIndex = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Save the cached TLS data */</span></span><br><span class="line">        T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory = *TlsDirectory;</span><br><span class="line">        I<span class="function"><span class="title">nsertTailList</span>(&amp;LdrpTlsList, &amp;TlsData-&gt;</span>TlsLinks);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Update the index */</span></span><br><span class="line">        *(PLONG)T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.AddressOfIndex = LdrpNumberOfTlsEntries;</span><br><span class="line">        T<span class="function"><span class="title">lsData</span>-&gt;</span>TlsDirectory.Characteristics = LdrpNumberOfTlsEntries++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Done setting up TLS, allocate entries */</span></span><br><span class="line">    return LdrpAllocateTls();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到了这步，我们以为可以很容易的解决问题，既然需要Tls目录，那我们给它一个不就行了？<br>所以我们给测试代码添加了一个Tls目录..</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/INCLUDE:__tls_used&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;.CRT$XLB&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    PIMAGE_TLS_CALLBACK TlsCallBackArray[] = &#123; TlsCallBackFunction &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br></pre></td></tr></table></figure><p>不过我们还是太天真了..我们的Tls的回调啥也没做，所以在程序执行的时候，执行到并没有初始化的对象直接崩溃了..（对，VS2015生成的Tls表（回调）就是用来初始化静态对象的。）</p><p>后来...<br>我们在 MSDN 发现一个相关的说明</p><blockquote><p>Starting in C++11, a static local variable initialization is guaranteed to be thread-safe.This feature is sometimes called magic statics.However, in a multithreaded application all subsequent assignments must be synchronized.The thread-safe statics feature can be disabled by using the &#x2F;Zc:threadSafeInit- flag to avoid taking a dependency on the CRT.</p></blockquote><p>大致意思是，由于在C++11开始可以保证静态本地变量初始化时是线程安全的，即“神奇的静态对象”<br>但是这个特性是默认需要CRT支持的，所以需要增加一条编译选项来关闭它。</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/Zc</span><span class="function">:threadSafeInit-</span></span><br></pre></td></tr></table></figure><p>这样在XP上运行就不会出现问题了。</p><p>好了，结束~<br>以此记录，来避免自己再遇到同样的坑 (●ˇ∀ˇ●)</p><blockquote><p><strong>引用链接：</strong><br><a href="https://msdn.microsoft.com/zh-cn/library/y5f6w579.aspx" target="_blank" rel="noopener external nofollow noreferrer">Storage class (C++)</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;文章可能有错误的地方，希望各位童鞋能够提出~&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;事故缘由…&lt;br&gt;为了使用很爽的C++11 特性，我司最新项目是用的VS2015进行开发的。&lt;br&gt;但是同时又要对XP做兼容（讲真，我个人是不支持对Win7之前的系统做兼容的，我觉得影响发展）。&lt;/p&gt;
&lt;p&gt;我们写了个COM组件作为插件，和驱动进行通讯。&lt;br&gt;在我们进行单元测试的时候，一切正常。但是出了测试安装包之后，发现加载插件会崩溃。&lt;br&gt;然后我们挂载了Windbg神器来定位崩溃点。&lt;br&gt;崩溃点是一个读取TLS，这个值为空 (外部静态对象才会有TLS)&lt;/p&gt;</summary>
    
    
    
    <category term="Windows" scheme="https://mirokaku.github.io/categories/windows/"/>
    
    
    <category term="Windows XP" scheme="https://mirokaku.github.io/tags/windows-xp/"/>
    
  </entry>
  
</feed>
